<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>Ataque format string &#8211; c4rta</title> <meta name="description" content="Soy Omar, un amante de la ciberseguridad y las radiocomunicaciones"> <meta name="keywords" content="Explotacion Binaria, format string"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/logo8.gif"> <meta name="twitter:title" content="Ataque format string"> <meta name="twitter:description" content="Aprederas lo basico de como realizar un ataque format string y lekear valores de la memoria"> <meta name="twitter:site" content="@_c4rta_"> <meta name="twitter:creator" content="@_c4rta_"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Ataque format string"> <meta property="og:description" content="Aprederas lo basico de como realizar un ataque format string y lekear valores de la memoria"> <meta property="og:url" content="http://localhost:4000/format-string/"> <meta property="og:site_name" content="c4rta"> <meta property="og:image" content="http://localhost:4000/assets/img/logo8.gif"> <link rel="canonical" href="http://localhost:4000/format-string/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="c4rta Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/logo8.gif" alt="c4rta photo" class="author-photo"> <h4>c4rta</h4> <p>Soy Omar, un amante de la ciberseguridad y las radiocomunicaciones</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://twitter.com/_c4rta_" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://github.com/ic4rta" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul><!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Ataque format string</h1> <h4>29 Jul 2022</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~5 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>Aprederas lo basico de como realizar un ataque format string y lekear valores de la memoria</p> <h2 class="lead" id="que-es-format-string">¿Que es format string?</h2> <p>Vulnerabilidad la cual ocurre cuando los inputs de los usuarios son ejecutados y procesados como comandos por una funcion vulnerable, esto permite que se puedan lekear valores de la memoria, ejecutar codigo, u ocasionar un segmentation fault</p> <h3 id="funciones-vulnerables">Funciones vulnerables</h3> <p>Las funciones que pueden ser vulnerables a format string son las de la familia <code class="language-plaintext highlighter-rouge">printf</code>, aca les dejo un listado de cuales son</p> <ul> <li>printf()</li> <li>fprintf()</li> <li>sprintf()</li> <li>vprintf()</li> <li>snprintf()</li> <li>vsnprintf()</li> <li>vfprintf()</li> <li>vfprintf()</li> </ul> <p>El format string o cadena de formato en español es al argumento que se le pasa a una de las funciones que pueden ser vulnerables, aca una imagen de cuales son los format string y su tipo</p> <p><img src="/assets/img/format-string/formatString.png" alt="" /></p> <p>Imagen: <a href="https://www.tutorialspoint.com">https://www.tutorialspoint.com</a></p> <h2 id="calling-conventions">Calling conventions</h2> <p>Las calling conventions describen lo siguiente:</p> <ul> <li>El orden en que se pasan los argumentos a una funcion</li> </ul> <p>Hay que tomar en cuenta que en una arquitectura de 64 bits los primeros 6 argumentos se pasan los los registros <code class="language-plaintext highlighter-rouge">RDI, RSI, RDX, RCX, R8, R9</code>, y los demas se empiezan a pasar por el stack y ese es el orden que describe las calling conventions</p> <h2 id="lekenado-valores-de-la-memoria">Lekenado valores de la memoria</h2> <p>Para explicar un poco mas a detalle esto vamos a ir probando con un pequeño programa en C el cual es el siguiente</p> <div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">void</span> <span class="n">main</span><span class="p">(){</span>
	<span class="kt">char</span> <span class="n">input</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Holi:)"</span><span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div> <p>El codigo lo pueden compilar como sea aun que yo lo hize de esta manera</p> <div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>gcc ejemplo.c -o ejemplo
</code></pre></div> <p>Para esta primera parte el programa simplemente esta usando la funcion <code class="language-plaintext highlighter-rouge">printf</code> para imprimir la variable <code class="language-plaintext highlighter-rouge">input</code> que contiene la cadena <code class="language-plaintext highlighter-rouge">Holi:)</code> y si ejecutamos el programa debe de salir algo como esto:</p> <p><img src="/assets/img/format-string/pt1.png" alt="" /></p> <p>Pero que pasara si ahora yo en el <code class="language-plaintext highlighter-rouge">printf</code> le indico mas format string y el codigo del programa queda asi</p> <div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">void</span> <span class="n">main</span><span class="p">(){</span>
        <span class="kt">char</span> <span class="n">input</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"Holi:)"</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"%s %x %x %x"</span> <span class="p">,</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div> <p>Lo compilamos de la misma forma y ejecutamos</p> <p><img src="/assets/img/format-string/pt2.png" alt="" /></p> <p><strong>¿De donde salieron esos caracteres?</strong></p> <p>Bueno, en la funcion <code class="language-plaintext highlighter-rouge">printf</code> se le estan pasando 4 format string, el primer format string que es <code class="language-plaintext highlighter-rouge">%s</code> que es para imprimir en string, este corresponde a la variable <code class="language-plaintext highlighter-rouge">input</code>, pero los demas format string que son <code class="language-plaintext highlighter-rouge">%x</code> para imprimir un valor en su representacion en hexadecimal no corresponden a nada, entonces como no tienen nada que imprimir empiezan a buscar valores de la memoria del programa y eso es lo que imprime, entonces lo que hacen los 3 <code class="language-plaintext highlighter-rouge">%x</code> es buscar valores de la memoria e imprimirlos</p> <h2 id="resolviendo-un-pequeño-ejercicio">Resolviendo un pequeño ejercicio</h2> <p>El codigo es el siguiente y se compila de la misma forma que los anteriores</p> <div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">secret_num</span> <span class="o">=</span> <span class="mh">0x8badf00d</span><span class="p">;</span>

    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Hello "</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"! You'll never get my secret!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div> <p>En el programa se esta declarando una variable llamada <code class="language-plaintext highlighter-rouge">secret_num</code> con el valor <code class="language-plaintext highlighter-rouge">0x8badf00d</code> la cual nunca se muesta en la ejecucion del programa, tambien se esta declarando un buffer llamado <code class="language-plaintext highlighter-rouge">name</code> en el cual se va almacenar nuestro input y posteriormente lo imprime con <code class="language-plaintext highlighter-rouge">printf</code></p> <p><strong>Objetivo:</strong> Lo que debemos de hacer para resolver este ejercicio es lekear la suficiente memoria para poder vizualizar el valor de <code class="language-plaintext highlighter-rouge">secret_num</code></p> <p>Para la primera ejecucion del programa le pasaremos varios format string y queda asi:</p> <p><img src="/assets/img/format-string/format1.png" alt="" /></p> <p>Vemos como nos muesta varios valores de la memoria en su representacion en hexadecimal, sin embargo aun no vemos nuestro valor secreto pero ahi esta</p> <p><strong>¿Como asi?</strong></p> <p>Lo que pasa es que ahora debemos de empezar a jugar con los format string, si revisamos la tabla que puse al principio, hay un format string el cual es <code class="language-plaintext highlighter-rouge">%l</code>, este format string es para imprimir un tipo de dato <code class="language-plaintext highlighter-rouge">long</code>, entonces si ahora volvemos a ejecutar el binario pero le pasamos esto como input</p> <div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>%lx %lx %lx %lx %lx %lx %lx %lx %lx
</code></pre></div> <p>Nos mostrara algo como esto</p> <p><img src="/assets/img/format-string/format2.png" alt="" /></p> <p>Vemos como la posicion numero 7 que se imprimio tiene esto <code class="language-plaintext highlighter-rouge">8badf00d00000000</code>, el cual es nuestro numero secreto, tambien podemos mostrar directamente lo que se encuentre ahi y lo hacemos asi:</p> <div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>%7$lx
</code></pre></div> <p>Lo que esta haciendo es imprimir lo que encuentre en la posicion numero 7 y nos muestra esto que es el valor secreto que buscamos</p> <p><img src="/assets/img/format-string/format3.png" alt="" /></p> <h2 id="visualizandolo-en-radare2">Visualizandolo en radare2</h2> <p>Ahora pasaremos a verlo por detras con radare2, dejo al URL de su pagina para que puedan descargarlo</p> <p><a href="https://rada.re/n/radare2.html">https://rada.re/n/radare2.html</a></p> <p>Ingresamos este comando para ejecutar el binario <code class="language-plaintext highlighter-rouge">radare2 ./vuln</code>, ingresamos <code class="language-plaintext highlighter-rouge">ood</code> para cambiarnos a modo de lectura y escritura, ingresamos <code class="language-plaintext highlighter-rouge">aaa</code> para que redare analice el binario, ingresamos <code class="language-plaintext highlighter-rouge">s main</code> para movernos a la funcion main y por ultimo usamos <code class="language-plaintext highlighter-rouge">pdf</code>para desensamblarla y nos muestra algo como esto</p> <p><img src="/assets/img/format-string/radare1.png" alt="" /></p> <p>Lo que hare es poner un break point en la direccion donde se hace el <code class="language-plaintext highlighter-rouge">printf</code> de nuestro input que es la linea que esta seleccionada, esto es para que cuando se ejecute el binario se detenga en esa parte, y el comando queda asi <code class="language-plaintext highlighter-rouge">db 0x5555555551fd</code>, ahora pondre <code class="language-plaintext highlighter-rouge">dc</code> para continuar la ejecucion del binario, vemos como se queda esperando un input, en este caso yo lo puse esto:</p> <p><code class="language-plaintext highlighter-rouge">%lx %lx %lx %lx %lx %lx %lx %lx</code> y vemos como nos arroja un mensaje que dice <code class="language-plaintext highlighter-rouge">hit breakpoint at: 0x5555555551fd</code>, eso es por que llego a ese break point, ahora pondre <code class="language-plaintext highlighter-rouge">dr</code> para mostrar los registros y <code class="language-plaintext highlighter-rouge">dc</code>para continuar con la ejecucion del programa y vemos algo como esto</p> <p><img src="/assets/img/format-string/radare2.png" alt="" /></p> <p>Esto con el fin de que vean lo que menciono de las calling conventions, vemos como los primeros 6 argumentos se pasan por los registros, y lo que estamos haciendo con los primeros <code class="language-plaintext highlighter-rouge">%lx %lx %lx %lx %lx %lx %lx %lx</code> de nuestro input es mostrar los valores de esos registros empezando por el <code class="language-plaintext highlighter-rouge">RSI</code>, de hecho si vemos que lo que nos imprimio fue</p> <div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>Hello 20 0 400 400 7ffff7fcbae0 80000000c 8badf00d00000000 20786c2520786c25
</code></pre></div> <p>Donde los primeros 5 valores despues del <code class="language-plaintext highlighter-rouge">Hello</code>son los valores de los registros RSI, RDX, RCX, R8, R9 y los podemos comparar con los que nos salieron mostrando los registros con <code class="language-plaintext highlighter-rouge">dr</code>, simplemente en nuestro input los estamos representando en hexadecimal</p> <p>Tambien para completar podemos mostrar el registro <code class="language-plaintext highlighter-rouge">RSP</code> con el comando <code class="language-plaintext highlighter-rouge">pxr @ rsp</code> y esto tambien nos debe de mostar nuestro input y el valor secreto que buscamos</p> <p><img src="/assets/img/format-string/radare3.png" alt="" /></p> <p>Eso ha sido todo, gracias por leer ❤</p> <p><img src="/assets/img/format-string/waifu.png" alt="" /></p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#Explotacion Binaria" title="Pages tagged Explotacion Binaria" class="tag"><span class="term">Explotacion Binaria</span></a><a href="http://localhost:4000/tags/#format string" title="Pages tagged format string" class="tag"><span class="term">format string</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/format-string/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/format-string/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/format-string/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <!--<section id="disqus_thread" class="animated fadeInUp"></section> /#disqus_thread --> <section id="utterances_thread" class="animated fadeInUp"> <!-- <script src="https://giscus.app/client.js" data-repo="ic4rta/ic4rta.github.io" data-repo-id="R_kgDOIyhU8A" data-category="Publicaciones" data-category-id="DIC_kwDOIyhU8M4CWjpB" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async> </script> --> <script src="https://utteranc.es/client.js" repo="ic4rta/ic4rta.github.io" issue-term="pathname" label="Publicaciones" theme="github-light" crossorigin="anonymous" async> </script> </section> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <script type="text/javascript"> var disqus_shortname = 'https-ic4rta-github-io'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
