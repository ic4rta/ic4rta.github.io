<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"> <title>Hijack de rand() usando LD_PRELOAD trick &#8211; c4rta</title> <meta name="description" content="En este caso vamos a hacer hijack de la funcion rand() para controlar la generacion de numeros aletorios con el fin de que sea completamente predecible."> <meta name="keywords" content="Explotacion Binaria, ld_preload"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="logo.png"> <meta name="twitter:title" content="Hijack de rand() usando LD_PRELOAD trick"> <meta name="twitter:description" content="En este caso vamos a hacer hijack de la funcion rand() para controlar la generacion de numeros aletorios con el fin de que sea completamente predecible."> <meta name="twitter:site" content="@_c4rta"> <meta name="twitter:creator" content="@_c4rta"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Hijack de rand() usando LD_PRELOAD trick"> <meta property="og:description" content="En este caso vamos a hacer hijack de la funcion rand() para controlar la generacion de numeros aletorios con el fin de que sea completamente predecible."> <meta property="og:url" content="http://localhost:4000/rand-ld_preload/"> <meta property="og:site_name" content="c4rta"> <meta property="og:image" content="http://localhost:4000/images/logo.png"> <link rel="canonical" href="http://localhost:4000/rand-ld_preload/"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Feed --> <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="" /> <!-- Favicons --> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- CSS --> <link rel="stylesheet" type="text/css" href="http://localhost:4000/assets/css/main.css"> <!-- Left Block Image for Posts --> <style type="text/css"> #posts.inner-post-page .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/assets/img/fondo4.png) no-repeat;background-size: cover;} </style> <!-- Left Block Images for Home and Pages --> <style type="text/css"> #posts .block-left {background: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(http://localhost:4000/assets/img/placeholder-big.jpg) no-repeat;background-size: cover, cover;} .block-left {background: linear-gradient(rgba(44,45,51,0.9), rgba(44,45,51,0.9)), url(http://localhost:4000/assets/img/fondo3.jpg) no-repeat;background-size: cover;} </style> </head> <body id="posts" class="inner-post-page"> <div class="block-left"> <div class="content"> <a href="http://localhost:4000" class="logo"><img src="http://localhost:4000/images/logo.png"></a> <div class="post-title-section"> <div class="section-line">Posts <em>/</em></div> <h1 class="section-title">Hijack de rand() usando LD_PRELOAD trick </h1> <ul class="tags"> <li><a href="http://localhost:4000/tags#Explotacion Binaria">Explotacion Binaria</a></li> <li><a href="http://localhost:4000/tags#ld_preload">ld_preload</a></li> </ul> <div class="section-line reverse"><a href="http://localhost:4000/posts">Back to posts</a> <em>/</em></div> </div> </div> </div> <div class="block-right"> <div class="share-buttons"> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/rand-ld_preload/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/rand-ld_preload/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/rand-ld_preload/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> </div> <a href="../posts.html" title="posts" class="posts-menu-icon"></a> <a title="projects" class="projects-menu-icon"> <span></span> </a> <div class="inner-post content"> <div class="date-highlight">22 Jan 2023</div> <p class="lead">En este caso vamos a hacer hijack de la funcion rand() para controlar la generacion de numeros aletorios con el fin de que sea completamente predecible.</p> <p>El credito es para <code class="highlighter-rouge">ProfessionallyEvil</code> ya que es el creador de este desafio: <code class="highlighter-rouge">https://github.com/ProfessionallyEvil/LD_PRELOAD-rand-Hijack-Example.git</code></p> <h2 id="funcionamiendo-de-ld_preload">Funcionamiendo de LD_PRELOAD</h2> <h3 id="bibliotecas-compartidas">Bibliotecas compartidas</h3> <p>Una biblioteca es una colección de funciones compiladas. Podemos hacer uso de estas funciones en nuestros programas sin reescribir la misma funcionalidad. Esto se puede lograr usando el código de la biblioteca en nuestro programa (static library) o vinculando dinámicamente en tiempo de ejecución (shared library)</p> <p>Usando bibliotecas estáticas, podemos crear programas independientes. Asi que, los programas creados con una biblioteca compartida ocupan compatibilidad con el enlazador en tiempo de ejecución. Por esto mismo, antes de ejecutar un programa, se cargan todos los símbolos requeridos y se prepara el programa para su ejecución</p> <h3 id="funcionamiento-de-ld_preload">Funcionamiento de LD_PRELOAD</h3> <p>LD_PRELOAD trick se aprovecha la funcionalidad proporcionada por el enlazador dinámico en, UNIX permiten decirle al enlazador que vincule los símbolos proporcionados por un cierta biblioteca compartida antes que otras bibliotecas, todo esto se hace en tiempo de ejecucion</p> <h3 id="inyeccion-de-codigo-usando-ld_preload">Inyeccion de codigo usando LD_PRELOAD</h3> <p>Este es un ejemplo de <code class="highlighter-rouge">Pedro Goldsborough</code>:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">amount_read</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>

  <span class="n">fd</span> <span class="o">=</span> <span class="n">fileno</span><span class="p">(</span><span class="n">stdin</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">amount_read</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buffer</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"error reading"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">fwrite</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="n">amount_read</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">perror</span><span class="p">(</span><span class="s">"error writing"</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>A grandes rasgos lo que hace es leer una cadena con <code class="highlighter-rouge">stdin</code> y la imprime</p> <p>Pero que pasara ahora si creamos una nueva definicion para la syscall <code class="highlighter-rouge">read</code> y se la pasamos al programa original antes de la definicion que proporciona <code class="highlighter-rouge">libc</code> osea la que esta en el binario original</p> <p>Para esto hay que crear la nueva definicion de <code class="highlighter-rouge">read</code> exactamente como la del binario original:</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;string.h&gt;
</span>
<span class="kt">size_t</span> <span class="nf">read</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">strcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">"holi boli"</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">9</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Ahora lo que haremos es compilar ese nuevo codigo en una biblioteca:</p> <p><code class="highlighter-rouge">gcc -shared -fPIC -o hijack.so hijack.c</code></p> <p>Ahora usaremos LD_PRELOAD para configurar la variable de entorno apropiada a LD_PRELOAD a la ruta a nuestra biblioteca compartida</p> <p><code class="highlighter-rouge">LD_PRELOAD=$PWD/hijack.so ./ejemplo</code></p> <p>Esto tambien hara que se ejecute el binario original pero con la nueva declaracion de <code class="highlighter-rouge">read</code> que contienen la cadena <code class="highlighter-rouge">holi boli</code>, esto se logro ya que se cargo antes de que se cargara la funcion <code class="highlighter-rouge">read</code> del binario original. Verdad que es muy simple?, pues algo asi se ha usado para realizar cosas que pueden comprometer todo un sistema, y comunmente usado para escalar privilegios.</p> <h2 id="resolucion-del-ejercicio">Resolucion del ejercicio</h2> <p>Cuando ejecutamos el binario lo que nos pone es que ingresemos un numero entre 0 y 31337, el cual si es igual al numero generado con por rand() entonces nos dice que ganamos</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./guessing_game                                                                                                                                      ─╯

	---===[ Number Guessing Game v1.0 ]===---

 [?] Guess a number between 0-31337 &gt; 2
 [-] You lose. :-(
</code></pre></div></div> <p>Evidentemente adivinar un numero entre esas cifras es casi imposible, y encima en cada ejecucion se crear un nuevo numero random, para eso usaremos LD_PRELOAD, y el creador del desafio nos provee un archivo para hacer hijack de rand():</p> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
</span>
<span class="kt">int</span> <span class="nf">rand</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">42</span><span class="p">;</span> 
<span class="p">}</span>
</code></pre></div></div> <p>Basicamente crea una funcion llamada rand y siempre regresa el 42, asi que simplemente vamos a compilar el archivo con: <code class="highlighter-rouge">make hijack</code></p> <p>Aqui hay que destacar que se usa <code class="highlighter-rouge">-FPIC</code> para que el binario de compile como independiente de la posicion del codigo, esto para hacer que el codigo se cargue en un espacio de direcciones aleatorio, y el <code class="highlighter-rouge">-shared</code> es para que se compile como un objeto compartido (.so).</p> <p>Ahora si hacemos uso de <code class="highlighter-rouge">LD_PRELOAD</code> para cargar el objeto compartido con la nueva declaracion de rand, podemos ver que si ingresamos <code class="highlighter-rouge">42</code> ahora nos dice <code class="highlighter-rouge">You win</code></p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LD_PRELOAD=./rand_hijack.so ./guessing_game                                                                                                          ─╯

	---===[ Number Guessing Game v1.0 ]===---

 [?] Guess a number between 0-31337 &gt; 42
 [+] You Win! :-)
</code></pre></div></div> <p>Y como vendo mencionando, esto sucede por que se crea una nueva declaracion de <code class="highlighter-rouge">rand()</code> antes de la declaracion del binario original, esto se debe a que con <code class="highlighter-rouge">LD_PRELOAD</code> podemos cargar una biblioteca antes que las del binario original. Ese es el ejemplo basico de como usar <code class="highlighter-rouge">LD_PRELOAD</code> para modificar el comportamiento de un programa</p> <p>Eso ha sido todo, gracias por leer ❤</p> <p><img src="/assets/img/heap2/waifu.jpg" alt="" /></p> <br> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/rand-ld_preload/" class="btn btn_twitter" title="Share on Twitter"><i class="fa fa-fw fa-twitter" aria-hidden="true"></i><span> Twitter</span></a> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/rand-ld_preload/" class="btn btn_facebook" title="Share on Facebook"><i class="fa fa-fw fa-facebook" aria-hidden="true"></i><span> Facebook</span></a> <a href="https://plus.google.com/share?url=http://localhost:4000/rand-ld_preload/" class="btn btn_google-plus" title="Share on Google Plus"><i class="fa fa-fw fa-google-plus" aria-hidden="true"></i><span> Google+</span></a> <nav class="pagination"> <a href="http://localhost:4000/protostar-heap2/" class="pagination_pager" title="protostar heap2 - UAF (Use-After-Free) ">previous</a> <a href="http://localhost:4000/picoCTF-here's-a-libc/" class="pagination_pager" title="picoCTF Here’s a libc - ret2libc y bypass ASLR ">next</a> </nav> </div> </div> <!-- JS --> <script src="http://localhost:4000/assets/js/main.min.js"></script> <div class="overlay"> <ul class="projects-menu"> <li style="background:url(https://www.drunkgaming.net/uploads/monthly_2023_07/ucmd1fimkara1.gif.dfdd0c0d3b5e1def01e9bc009ff1d853.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/NazunaRansom" target="_blank" rel="nofollow external"> <span> Nazuna Ransomware </span> </a> </li> <li style="background:url(https://i.pinimg.com/originals/0c/af/9f/0caf9f7b8ab4917287aaaf8b8b772cd7.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/Synergy-RAT" target="_blank" rel="nofollow external"> <span> Synergy-RAT </span> </a> </li> <li style="background:url(https://media.tenor.com/XbbgjUJaLe0AAAAC/kumiko-oumae-nono.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/PEjector" target="_blank" rel="nofollow external"> <span> PEjector </span> </a> </li> <li style="background:url(https://media.tenor.com/c7fsPiG8UwIAAAAC/bocchi-the-rock-anime.gif) center center no-repeat;"> <a href="https://github.com/ic4rta/ISCAN" target="_blank" rel="nofollow external"> <span> ISCAN </span> </a> </li> </ul> </div> </body> </html>
